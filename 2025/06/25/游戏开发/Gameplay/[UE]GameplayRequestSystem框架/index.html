<!DOCTYPE html><html data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>[UE]GameplayRequestSystem框架 | BearChild's Blog</title><meta name="keywords" content="Gameplay,UE"><meta name="author" content="BearChild"><meta name="copyright" content="BearChild"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="GameplayRequestSystem框架 在联网游戏中经常需要有多个玩家之间请求交互的操作，提供一套 GameplayRequestSystem 用于快速自定义出一类新的 Request，自定义可发起请求交互对象、操作回调； 基本框架 从一次 Request 基本的流程出发： 对于某一类 Request，首先 A 需要筛选出关心的 B （其它玩家） ，判断这些玩家是否可以发起该类请求，如果不">
<meta property="og:type" content="article">
<meta property="og:title" content="[UE]GameplayRequestSystem框架">
<meta property="og:url" content="https://www.bearchild.top/2025/06/25/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]GameplayRequestSystem%E6%A1%86%E6%9E%B6/index.html">
<meta property="og:site_name" content="BearChild&#39;s Blog">
<meta property="og:description" content="GameplayRequestSystem框架 在联网游戏中经常需要有多个玩家之间请求交互的操作，提供一套 GameplayRequestSystem 用于快速自定义出一类新的 Request，自定义可发起请求交互对象、操作回调； 基本框架 从一次 Request 基本的流程出发： 对于某一类 Request，首先 A 需要筛选出关心的 B （其它玩家） ，判断这些玩家是否可以发起该类请求，如果不">
<meta property="og:locale">
<meta property="og:image" content="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202506252357006.png">
<meta property="article:published_time" content="2025-06-24T16:00:00.000Z">
<meta property="article:modified_time" content="2025-06-25T15:57:44.095Z">
<meta property="article:author" content="BearChild">
<meta property="article:tag" content="Gameplay">
<meta property="article:tag" content="UE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202506252357006.png"><link rel="shortcut icon" href="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/usage/%E6%BB%91%E7%A8%BD.jpg"><link rel="canonical" href="https://www.bearchild.top/2025/06/25/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]GameplayRequestSystem%E6%A1%86%E6%9E%B6/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '[UE]GameplayRequestSystem框架',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-06-25 23:57:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="/decoration/background.css"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="BearChild's Blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/usage/%E6%BB%91%E7%A8%BD.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">209</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-gamepad"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fab fa-youtube"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202506252357006.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">BearChild's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-gamepad"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fab fa-youtube"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">[UE]GameplayRequestSystem框架</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-06-24T16:00:00.000Z" title="Created 2025-06-25 00:00:00">2025-06-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-06-25T15:57:44.095Z" title="Updated 2025-06-25 23:57:44">2025-06-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/">游戏开发</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/">Gameplay</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="[UE]GameplayRequestSystem框架"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>GameplayRequestSystem框架</h1>
<p>在联网游戏中经常需要有多个玩家之间请求交互的操作，提供一套 <code>GameplayRequestSystem</code> 用于快速自定义出一类新的 <code>Request</code>，自定义可发起请求交互对象、操作回调；</p>
<h2 id="基本框架">基本框架</h2>
<p>从一次 <code>Request</code> 基本的流程出发：</p>
<p>对于某一类 <code>Request</code>，首先 A 需要筛选出关心的 B （其它玩家） ，判断这些玩家是否可以发起该类请求，如果不可以的话，还可能需要知道无法发起请求的原因；</p>
<p>然后由 A 发起请求，并等待一系列请求交互操作：</p>
<blockquote>
<ol>
<li><code>SendRequest</code> ：由 A 向 B 发起某个请求，等待请求回复；</li>
<li><code>AcceptRequest</code>：B / Manager 接受某个请求；</li>
<li><code>RejectRequest</code>：B / Manager 拒绝某个请求；</li>
<li><code>CancelRequest</code>：A / B / Manager 取消某个请求；</li>
</ol>
</blockquote>
<p>每个操作需要通知给请求交互的双方 A、B；</p>
<p>对于一个新的 <code>Request</code>，两个玩家的 <code>Client</code> 需要同步到该 <code>Request</code> 信息，获取请求当前状态与一些同步属性等；</p>
<ol>
<li>
<p>由 <code>Player</code> 的 <code>RequestComponent</code> 执行对应 <code>Request</code> 交互、持有 <code>RequestFilter</code>、同步 <code>Request</code> ；</p>
</li>
<li>
<p>由 <code>Player</code> 的 <code>RequestFilter</code> 进行 可以发起请求的目标 的注册与更新等；</p>
</li>
<li>
<p>由<code>RequestMananger</code> 持有实际的 <code>Request</code>，管理其生命周期；</p>
</li>
</ol>
<p>对于 <code>Request</code> 的数据与操作，需要一些自定义参数，通过 <a href="https://www.bearchild.top/2024/03/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/%5BUE%5DCommonParams%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">CommonParams</a> 实现；</p>
<pre class="mermaid">classDiagram
	direction TD
	
	UGameplayRequestUtils ..> UGameplayRequestManager
	UGameplayRequestUtils ..> UGameplayRequestComponent

    class UGameplayRequestManager {
        CreateRequest()
        CancelRequest()
        ResponseRequest()
        ActiveRequests : TMap~uint64|UGameplayRequestBase*~
    }
    
    class UGameplayRequestComponent {
        SendRequest()
        CancelRequest()
        AcceptRequest()
        RejectRequest()
        GetFilter()
        Requests : TArray~UGameplayRequestBase*~
        Filters : FGameplaySubSystemCollection<UGameplayRequestFilterBase>
    }
    
    UGameplayRequestManager --> UGameplayRequestBase
    UGameplayRequestComponent --> UGameplayRequestBase
    class UGameplayRequestBase {
        GetType()
        GetFilterType()
        State : EGameplayRequestState
        Result : EGameplayRequestResult
    }
    
    UGameplayRequestComponent --> UGameplayRequestFilterBase
    UGameplayRequestFilterBase --> FGameplayRequestFilterTargetData
    class UGameplayRequestFilterBase {
    	GetType()
        IsTargetValid()
        RegisterPossibleTarget()
        UnregisterPossibleTarget()
        FilterTargets()
        FilterTargetDatas : TArray~FGameplayRequestFilterTargetData~
    }
    
    class FGameplayRequestFilterTargetData {
        PlayerUID : uint64
        bValid : bool
        Params : FCommonVariantParams
    }</pre>
<h2 id="Request-Manager">Request Manager</h2>
<p>作为全局的 <code>Manager</code> 管理所有 <code>Request</code> 的生命周期，持有 <code>Request</code> 实例；</p>
<p>在这里控制 <code>Request</code> 增加/移除，将其同步 增加/移除 到 <code>Sender</code> 与 <code>Target</code> 的 <code>RequestComponent</code> 上，通过 <code>RequestComponent</code> 同步 <code>Request</code> 给对应的 <code>Client</code> ；</p>
<p>根据 <code>UGameplayRequestBase</code> 注册所有的 <code>RequestCDO</code> 用于生成 <code>Request</code> 实例；</p>
<p>特别的，为了 <code>Request</code> 状态能正确同步与通知，当其 <code>Finish</code> 时，并不会直接将其 <code>Remove</code>，而是 <code>KeepAlive</code>，到 <code>KeepAliveDuration</code> 时间结束才将其实例移除；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RequestManager.h</span></span><br><span class="line"><span class="built_in">UCLASS</span>(meta = (BlueprintSpawnableComponent))</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UGameplayRequestManager</span> :</span> <span class="keyword">public</span> UGameStateComponentBase</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Base</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="built_in">UGameplayRequestManager</span>();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnInitSelf</span><span class="params">(AGameStateBase* Owner)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnUninit</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Base</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Interact</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">uint64 <span class="title">CreateRequest</span><span class="params">(uint32 Type, uint64 SenderUID, uint64 TargetUID, <span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">CancelRequest</span><span class="params">(uint64 RequestID, uint64 CancelUID = <span class="number">0</span>, FCommonVariantParams Params = &#123;&#125;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">ResponseRequest</span><span class="params">(uint64 RequestID, <span class="keyword">bool</span> bAccept, uint64 ResponseUID = <span class="number">0</span>, FCommonVariantParams Params = &#123;&#125;)</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Interact</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Request</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">UGameplayRequestBase* <span class="title">GetRequest</span><span class="params">(uint64 RequestID)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    TArray &lt;UGameplayRequestBase*&gt; <span class="built_in">GetAllRequests</span>() <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">InitRequests</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UninitRequests</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">AddRequest</span><span class="params">(UGameplayRequestBase* Request)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RemoveRequest</span><span class="params">(uint64 RequestID)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ClearRequests</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">UPROPERTY</span>()</span><br><span class="line">    TMap &lt;uint32, UGameplayRequestBase*&gt; RequestCDOs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">UPROPERTY</span>()</span><br><span class="line">    TMap&lt;uint64, UGameplayRequestBase*&gt; ActiveRequests;</span><br><span class="line">    <span class="built_in">UPROPERTY</span>()</span><br><span class="line">    TMap&lt;uint64, FTimerHandle&gt; RequestKeepAliveTimers;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Request</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Helper</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ExecuteFunctionForRequestPlayers</span><span class="params">(UGameplayRequestBase* Request, TFunction&lt;<span class="keyword">void</span>(UGameplayRequestComponent*)&gt; Callback)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Helper</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RequestManager.cpp</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Base</span></span><br><span class="line"></span><br><span class="line">UGameplayRequestManager::<span class="built_in">UGameplayRequestManager</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">SetIsReplicatedByDefault</span>(<span class="literal">true</span>);</span><br><span class="line">    PrimaryComponentTick.bCanEverTick = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestManager::OnInitSelf</span><span class="params">(AGameStateBase* Owner)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Super::<span class="built_in">OnInitSelf</span>(Owner);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">InitRequests</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestManager::OnUninit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Super::<span class="built_in">OnUninit</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UninitRequests</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Base</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Interact</span></span><br><span class="line"></span><br><span class="line"><span class="function">uint64 <span class="title">UGameplayRequestManager::CreateRequest</span><span class="params">(uint32 Type, uint64 SenderUID, uint64 TargetUID, <span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> RequestCDO = RequestCDOs.<span class="built_in">FindRef</span>(Type);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(RequestCDO))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SenderUID == TargetUID)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    UGameplayRequestBase* NewRequest = NewObject&lt;UGameplayRequestBase&gt;(<span class="keyword">this</span>, RequestCDO-&gt;<span class="built_in">GetClass</span>());</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(NewRequest)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    uint64 RequestID = NewRequest-&gt;<span class="built_in">Init</span>(SenderUID, TargetUID, Params);</span><br><span class="line">    <span class="keyword">if</span> (RequestID &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AddRequest</span>( NewRequest );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// RegisterKeepAliveTimer</span></span><br><span class="line">    <span class="keyword">float</span> KeepAliveDuration = FMath::<span class="built_in">Max</span>( <span class="number">10.0f</span>, NewRequest-&gt;<span class="built_in">GetKeepAliveTime</span>());</span><br><span class="line">    </span><br><span class="line">    FTimerHandle&amp; TimerHandle = RequestKeepAliveTimers.<span class="built_in">FindOrAdd</span>(RequestID);</span><br><span class="line">    UWorldTimerManager::<span class="built_in">SetTimer</span>(<span class="built_in">GetWorld</span>(), TimerHandle,</span><br><span class="line">    [WeakSelfPtr = TWeakObjectPtr&lt;UGameplayRequestManager&gt;(<span class="keyword">this</span>), RequestID = RequestID]()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!WeakSelfPtr.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line">        WeakSelfPtr-&gt;<span class="built_in">RemoveRequest</span>( RequestID );</span><br><span class="line">    &#125;, KeepAliveDuration, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    NewRequest-&gt;<span class="built_in">NotifyCreated</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> RequestID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UGameplayRequestManager::CancelRequest</span><span class="params">(uint64 RequestID, uint64 CancelUID, FCommonVariantParams Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> Request = <span class="built_in">GetRequest</span>(RequestID);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由 Manager / Sender / Target 发起</span></span><br><span class="line">    <span class="keyword">if</span> ( !TSet&lt;uint64&gt;&#123; <span class="number">0LL</span>, Request-&gt;<span class="built_in">GetSenderUID</span>(), Request-&gt;<span class="built_in">GetTargetUID</span>() &#125;.<span class="built_in">Contains</span>( CancelUID ))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Request-&gt;<span class="built_in">IsFinished</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Params.<span class="built_in">SetValue</span>( <span class="string">&quot;CancelUID&quot;</span>, CancelUID );</span><br><span class="line">    Request-&gt;<span class="built_in">Cancel</span>( Params );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UGameplayRequestManager::ResponseRequest</span><span class="params">(uint64 RequestID, <span class="keyword">bool</span> bAccept, uint64 ResponseUID, FCommonVariantParams Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> Request = <span class="built_in">GetRequest</span>(RequestID);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由 Manager / TargetUID 发起</span></span><br><span class="line">    <span class="keyword">if</span> ( !TSet&lt;uint64&gt;&#123; <span class="number">0LL</span>, Request-&gt;<span class="built_in">GetTargetUID</span>() &#125;.<span class="built_in">Contains</span>( ResponseUID ))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Request-&gt;<span class="built_in">IsFinished</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Params.<span class="built_in">SetValue</span>( <span class="string">&quot;ResponseUID&quot;</span>, ResponseUID );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bAccept)</span><br><span class="line">    &#123;</span><br><span class="line">        Request-&gt;<span class="built_in">Accept</span>( Params );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Request-&gt;<span class="built_in">Reject</span>( Params );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Interact</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Request</span></span><br><span class="line"></span><br><span class="line"><span class="function">UGameplayRequestBase* <span class="title">UGameplayRequestManager::GetRequest</span><span class="params">(uint64 RequestID)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ActiveRequests.<span class="built_in">FindRef</span>( RequestID );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TArray&lt;UGameplayRequestBase*&gt; <span class="title">UGameplayRequestManager::GetAllRequests</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TArray &lt;UGameplayRequestBase*&gt; OutArray;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [RequestID, Request] : ActiveRequests)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">continue</span>;;</span><br><span class="line">        OutArray.<span class="built_in">Add</span>( Request );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OutArray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestManager::InitRequests</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    TArray&lt;UClass*&gt; RequestClasses;</span><br><span class="line">    <span class="built_in">GetDerivedClasses</span>(UGameplayRequestBase::<span class="built_in">StaticClass</span>(), RequestClasses, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> Class : RequestClasses)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Class)) <span class="keyword">continue</span>;</span><br><span class="line">    	<span class="keyword">if</span> (Class-&gt;<span class="built_in">HasAnyClassFlags</span>(CLASS_Abstract)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">auto</span> CDO = Class-&gt;GetDefaultObject&lt;UGameplayRequestBase&gt;();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(CDO)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        RequestCDOs.<span class="built_in">Add</span>( CDO-&gt;<span class="built_in">GetType</span>(), CDO );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestManager::UninitRequests</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">ClearRequests</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestManager::AddRequest</span><span class="params">(UGameplayRequestBase* Request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">return</span>;</span><br><span class="line">    ActiveRequests.<span class="built_in">Add</span>( Request-&gt;<span class="built_in">GetRequestID</span>(), Request );</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">ExecuteFunctionForRequestPlayers</span>(Request, [Request](UGameplayRequestComponent* Component)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">IsValid</span>(Component))</span><br><span class="line">        &#123;</span><br><span class="line">            Component-&gt;<span class="built_in">AddRequest</span>( Request );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestManager::RemoveRequest</span><span class="params">(uint64 RequestID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> Request = <span class="built_in">GetRequest</span>(RequestID);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsValid</span>(Request))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ExecuteFunctionForRequestPlayers</span>(Request, [RequestID](UGameplayRequestComponent* Component)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">IsValid</span>(Component))</span><br><span class="line">            &#123;</span><br><span class="line">                Component-&gt;<span class="built_in">RemoveRequest</span>( RequestID );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Request-&gt;<span class="built_in">Uninit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span>* TimerHandle = RequestKeepAliveTimers.<span class="built_in">Find</span>(RequestID))</span><br><span class="line">    &#123;</span><br><span class="line">        UWorldTimerManager::<span class="built_in">ClearTimer</span>(<span class="built_in">GetWorld</span>(), *TimerHandle);</span><br><span class="line">        RequestKeepAliveTimers.<span class="built_in">Remove</span>(RequestID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ActiveRequests.<span class="built_in">Remove</span>(RequestID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestManager::ClearRequests</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TArray &lt;uint64&gt; RequestIDs;</span><br><span class="line">    ActiveRequests.<span class="built_in">GetKeys</span>(RequestIDs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> RequestID : RequestIDs)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">RemoveRequest</span>( RequestID );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Request</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Helper</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestManager::ExecuteFunctionForRequestPlayers</span><span class="params">(UGameplayRequestBase* Request, TFunction&lt;<span class="keyword">void</span>(UGameplayRequestComponent*)&gt; Callback)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> Sender = UGameplayRequestUtils::<span class="built_in">GetComponentByUID</span>(<span class="built_in">GetWorld</span>(), Request-&gt;<span class="built_in">GetSenderUID</span>()); <span class="built_in">IsValid</span>(Sender))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">Callback</span>(Sender);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> Target = UGameplayRequestUtils::<span class="built_in">GetComponentByUID</span>(<span class="built_in">GetWorld</span>(), Request-&gt;<span class="built_in">GetTargetUID</span>()); <span class="built_in">IsValid</span>(Target))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">Callback</span>(Target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Helper</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="RequestComponent">RequestComponent</h2>
<p>作为 <code>Player</code> 组件进行 <code>Request</code> 操作（请求、同意、拒绝、取消）；</p>
<p>将与 <code>Player</code> 相关的 <code>Request</code> 同步（当 <code>Player</code> 为 <code>Sender</code> / <code>Target</code> 时认为其相关）；</p>
<p>通过 <a href="https://www.bearchild.top/2025/03/15/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/%5BUE%5DGameplaySubSystem%E5%AE%9E%E7%8E%B0/">GameplaySubSystem</a> 持有每一种 <code>RequestType</code> 对应的 <code>RequestFilter</code> ，进行 <code>FilterTargetData</code> （可能发起请求的人的相关信息）的更新与同步；</p>
<p>后续每次对 <code>Request</code> 进行 <code>Verify</code> 时，需要通过 <code>Player</code> 上对应 <code>RequestFilter</code> 进行校验是否 <code>IsTargetValid</code>；</p>
<p>同时客户端可以根据 <code>RequestFilter</code> 上的 <code>FilterTargetDatas</code> 信息，提前进行部分操作（比如 <code>Client</code> 知道该类请求无可以请求对象时、自己 / 对方处于不可请求状态时，进行提示）</p>
<p>这里 <code>ReplicateRequest</code> 时，在 <code>Client</code> 创建对应 <code>UObject</code>，需要通过 <code>ReplicateSubobjects_OwnerOnly</code> 来进行同步：</p>
<p>当 <code>Request</code> 作为 <code>Subobject</code> 同步下去时，会在 <code>Client</code> 找到其对应的 <code>Outer</code>（也就是 <code>UGameplayRequestManager</code>，所以 <code>UGameplayRequestManager</code> 需要开启同步）创建在其 <code>ActorChannel</code> 的 <code>CreateSubObjects</code> 中；</p>
<p>在 <code>RequestComponent</code> 中，由一个同步字段 <code>Requests</code> 持有对应指针；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UPlayerStateComponentBase::ReplicateSubobjects</span><span class="params">(UActorChannel* Channel, FOutBunch* Bunch, FReplicationFlags* RepFlags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> WroteSomething = Super::<span class="built_in">ReplicateSubobjects</span>(Channel, Bunch, RepFlags);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (APlayerStateBase* PS = <span class="built_in">GetPlayerState</span>(); <span class="built_in">IsValid</span>(PS) &amp;&amp; <span class="built_in">IsValid</span>(Channel) &amp;&amp; <span class="built_in">IsValid</span>(Channel-&gt;Connection))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Channel-&gt;Connection-&gt;PlayerController == PS-&gt;<span class="built_in">GetPlayerController</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			WroteSomething |= <span class="built_in">ReplicateSubobjects_OwnerOnly</span>(Channel, Bunch, RepFlags);</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> WroteSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下为具体实现：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RequestComponent.h</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>(meta=(BlueprintSpawnableComponent))</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UGameplayRequestComponent</span> :</span> <span class="keyword">public</span> UPlayerStateComponentBase, <span class="keyword">public</span> IGameplaySubSystemCollectionOwnerInterface</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Base</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">UGameplayRequestComponent</span>();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetLifetimeReplicatedProps</span><span class="params">(TArray&lt;FLifetimeProperty&gt;&amp; OutLifetimeProps)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnInitSelf</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnUninit</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Base</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Interact</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">SendRequest</span><span class="params">(uint32 Type, uint64 TargetUID, <span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">CancelRequest</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">AcceptRequest</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">RejectRequest</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region C2S</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">UFUNCTION</span>(Reliable, Server)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">C2S_SendRequest</span><span class="params">(uint32 Type, uint64 TargetUID, <span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line">    <span class="built_in">UFUNCTION</span>(Reliable, Server)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">C2S_AcceptRequest</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line">    <span class="built_in">UFUNCTION</span>(Reliable, Server)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">C2S_RejectRequest</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line">    <span class="built_in">UFUNCTION</span>(Reliable, Server)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">C2S_CancelRequest</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion C2S</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Interact</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Request</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">UFUNCTION</span>()</span><br><span class="line">    <span class="function">UGameplayRequestBase* <span class="title">GetRequest</span><span class="params">(uint64 RequestID)</span></span>;</span><br><span class="line">    <span class="built_in">UFUNCTION</span>()</span><br><span class="line">    TArray &lt;UGameplayRequestBase*&gt; <span class="built_in">GetRequestsByType</span>(uint32 Type);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">AddRequest</span><span class="params">(UGameplayRequestBase* Request)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RemoveRequest</span><span class="params">(uint64 RequestID)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ClearRequests</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">UFUNCTION</span>()</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnRep_Requests</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(ReplicatedUsing=OnRep_Requests)</span><br><span class="line">    TArray &lt;UGameplayRequestBase*&gt; Requests;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Request</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Filter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> TArray&lt;UClass*&gt; <span class="title">GetFilterClasses</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> &#123;&#125;; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">UFUNCTION</span>()</span><br><span class="line">    <span class="function">UGameplayRequestFilterBase* <span class="title">GetFilter</span><span class="params">(UClass* InClass)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">ReplicateSubobjects_OwnerOnly</span><span class="params">(UActorChannel* Channel, FOutBunch* Bunch, FReplicationFlags* RepFlags)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DECLARE_GAMEPLAYSUBSYSTEM_ACCESSORS_BY_NAME</span>(Filter, UGameplayRequestFilterBase, Filters);</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> TArray&lt;FGameplaySubSystemCollectionBase*&gt; <span class="title">GetSubSystemCollectionPtrs</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> &#123; &amp;Filters &#125;; &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    FGameplaySubSystemCollection &lt;UGameplayRequestFilterBase&gt; Filters;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Filter</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Debug</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">UFUNCTION</span>(Reliable, Server)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">C2S_DebugSendRequest</span><span class="params">(uint32 Type, uint64 SenderUID, uint64 TargetUID)</span></span>;</span><br><span class="line">    <span class="built_in">UFUNCTION</span>(Reliable, Server)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">C2S_DebugAcceptRequests</span><span class="params">(uint64 PlayerUID)</span></span>;</span><br><span class="line">    <span class="built_in">UFUNCTION</span>(Reliable, Server)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">C2S_DebugRejectRequests</span><span class="params">(uint64 PlayerUID)</span></span>;</span><br><span class="line">    <span class="built_in">UFUNCTION</span>(Reliable, Server)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">C2S_DebugCancelRequests</span><span class="params">(uint64 PlayerUID)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Debug</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RequestComponent.cpp</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Base</span></span><br><span class="line"></span><br><span class="line">UGameplayRequestComponent::<span class="built_in">UGameplayRequestComponent</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">SetIsReplicatedByDefault</span>(<span class="literal">true</span>);</span><br><span class="line">    PrimaryComponentTick.bCanEverTick = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::GetLifetimeReplicatedProps</span><span class="params">(TArray&lt;FLifetimeProperty&gt;&amp; OutLifetimeProps)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Super::<span class="built_in">GetLifetimeReplicatedProps</span>(OutLifetimeProps);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// --- OwnerOnly</span></span><br><span class="line">	</span><br><span class="line">    FDoRepLifetimeParams OwnerOnlyRepParams;</span><br><span class="line">    OwnerOnlyRepParams.bIsPushBased = <span class="literal">true</span>;</span><br><span class="line">    OwnerOnlyRepParams.Condition = COND_OwnerOnly;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UGameplayRequestComponent, Requests, OwnerOnlyRepParams);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::OnInitSelf</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Super::<span class="built_in">OnInitSelf</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Filters.<span class="built_in">Init</span>(<span class="keyword">this</span>, <span class="built_in">GetFilterClasses</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::OnUninit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Super::<span class="built_in">OnUninit</span>();</span><br><span class="line">    </span><br><span class="line">    Filters.<span class="built_in">Uninit</span>();</span><br><span class="line">    <span class="built_in">ClearRequests</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Base</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Interact</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UGameplayRequestComponent::SendRequest</span><span class="params">(uint32 Type, uint64 TargetUID, <span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> Manager = UGameplayRequestUtils::<span class="built_in">GetManager</span>(<span class="built_in">GetWorld</span>());</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Manager)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> bSucceed = Manager-&gt;<span class="built_in">CreateRequest</span>(Type, <span class="built_in">GetUID</span>(), TargetUID, Params);</span><br><span class="line">    <span class="keyword">return</span> bSucceed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UGameplayRequestComponent::AcceptRequest</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> Manager = UGameplayRequestUtils::<span class="built_in">GetManager</span>(<span class="built_in">GetWorld</span>());</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Manager)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> bSucceed = Manager-&gt;<span class="built_in">ResponseRequest</span>(RequestID, <span class="literal">true</span>, <span class="built_in">GetUID</span>(), Params);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> bSucceed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UGameplayRequestComponent::RejectRequest</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> Manager = UGameplayRequestUtils::<span class="built_in">GetManager</span>(<span class="built_in">GetWorld</span>());</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Manager)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> bSucceed = Manager-&gt;<span class="built_in">ResponseRequest</span>(RequestID, <span class="literal">false</span>, <span class="built_in">GetUID</span>(), Params);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> bSucceed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UGameplayRequestComponent::CancelRequest</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> Manager = UGameplayRequestUtils::<span class="built_in">GetManager</span>(<span class="built_in">GetWorld</span>());</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Manager)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> bSucceed = Manager-&gt;<span class="built_in">CancelRequest</span>(RequestID, <span class="built_in">GetUID</span>(), Params);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bSucceed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region C2S</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::C2S_SendRequest_Implementation</span><span class="params">(uint32 Type, uint64 TargetUID, <span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">SendRequest</span>(Type, TargetUID, Params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::C2S_AcceptRequest_Implementation</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">AcceptRequest</span>(RequestID, Params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::C2S_RejectRequest_Implementation</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">RejectRequest</span>(RequestID, Params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::C2S_CancelRequest_Implementation</span><span class="params">(uint64 RequestID, <span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">CancelRequest</span>(RequestID, Params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion C2S</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Interact</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Request</span></span><br><span class="line"></span><br><span class="line"><span class="function">UGameplayRequestBase* <span class="title">UGameplayRequestComponent::GetRequest</span><span class="params">(uint64 RequestID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> Request : Requests)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (Request-&gt;<span class="built_in">GetRequestID</span>() == RequestID)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Request;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TArray&lt;UGameplayRequestBase*&gt; <span class="title">UGameplayRequestComponent::GetRequestsByType</span><span class="params">(uint32 Type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TArray &lt;UGameplayRequestBase*&gt; OutArray;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> Request : Requests)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (Request-&gt;<span class="built_in">GetType</span>() == Type)</span><br><span class="line">        &#123;</span><br><span class="line">            OutArray.<span class="built_in">Add</span>( Request );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OutArray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::AddRequest</span><span class="params">(UGameplayRequestBase* Request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">GetRequests_Mutable</span>().<span class="built_in">AddUnique</span>( Request );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::RemoveRequest</span><span class="params">(uint64 RequestID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> Request = <span class="built_in">GetRequest</span>( RequestID );</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">GetRequests_Mutable</span>().<span class="built_in">Remove</span>( Request );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::ClearRequests</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">GetRequests_Mutable</span>().<span class="built_in">Empty</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::OnRep_Requests</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> Request : Requests)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">continue</span>;</span><br><span class="line">        Request-&gt;<span class="built_in">NotifyCreated</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Request</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Filter</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UGameplayRequestComponent::ReplicateSubobjects_OwnerOnly</span><span class="params">(UActorChannel* Channel, FOutBunch* Bunch, FReplicationFlags* RepFlags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> WroteSomething = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    WroteSomething |= Super::<span class="built_in">ReplicateSubobjects_OwnerOnly</span>(Channel, Bunch, RepFlags);</span><br><span class="line">    WroteSomething |= Filters.<span class="built_in">ReplicateSubSystems</span>( Channel, Bunch, RepFlags );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsValid</span>(Channel) &amp;&amp; RepFlags-&gt;bNetInitial == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> Request : Requests)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">continue</span>;</span><br><span class="line">            WroteSomething |= Channel-&gt;<span class="built_in">ReplicateSubobject</span>(Request, *Bunch, *RepFlags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> WroteSomething;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UGameplayRequestFilterBase* <span class="title">UGameplayRequestComponent::GetFilter</span><span class="params">(UClass* InClass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> Filter : <span class="built_in">GetFilters</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">IsValid</span>(Filter) &amp;&amp; Filter-&gt;<span class="built_in">GetClass</span>() == InClass)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Filter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Filter</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Debug</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::C2S_DebugSendRequest_Implementation</span><span class="params">(uint32 Type, uint64 SenderUID, uint64 TargetUID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_SHIPPING</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    SenderUID = SenderUID &gt; <span class="number">0</span> ? SenderUID : <span class="built_in">GetUID</span>();</span><br><span class="line">    TargetUID = TargetUID &gt; <span class="number">0</span> ? TargetUID : <span class="built_in">GetUID</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> Component = UGameplayRequestUtils::<span class="built_in">GetComponentByUID</span>(<span class="built_in">GetWorld</span>(), SenderUID);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Component)) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    Component-&gt;<span class="built_in">SendRequest</span>( Type, TargetUID );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::C2S_DebugAcceptRequests_Implementation</span><span class="params">(uint64 PlayerUID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_SHIPPING</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    PlayerUID = PlayerUID &gt; <span class="number">0</span> ? PlayerUID : <span class="built_in">GetUID</span>();</span><br><span class="line">    <span class="keyword">auto</span> Component = UGameplayRequestUtils::<span class="built_in">GetComponentByUID</span>(<span class="built_in">GetWorld</span>(), PlayerUID);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Component)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    TArray &lt;UGameplayRequestBase*&gt; PlayerRequests = Component-&gt;<span class="built_in">GetRequests</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> Request : PlayerRequests)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">continue</span>;</span><br><span class="line">        Component-&gt;<span class="built_in">AcceptRequest</span>(Request-&gt;<span class="built_in">GetRequestID</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::C2S_DebugRejectRequests_Implementation</span><span class="params">(uint64 PlayerUID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_SHIPPING</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    PlayerUID = PlayerUID &gt; <span class="number">0</span> ? PlayerUID : <span class="built_in">GetUID</span>();</span><br><span class="line">    <span class="keyword">auto</span> Component = UGameplayRequestUtils::<span class="built_in">GetComponentByUID</span>(<span class="built_in">GetWorld</span>(), PlayerUID);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Component)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    TArray &lt;UGameplayRequestBase*&gt; PlayerRequests = Component-&gt;<span class="built_in">GetRequests</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> Request : PlayerRequests)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">continue</span>;</span><br><span class="line">        Component-&gt;<span class="built_in">RejectRequest</span>(Request-&gt;<span class="built_in">GetRequestID</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestComponent::C2S_DebugCancelRequests_Implementation</span><span class="params">(uint64 PlayerUID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_SHIPPING</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    PlayerUID = PlayerUID &gt; <span class="number">0</span> ? PlayerUID : <span class="built_in">GetUID</span>();</span><br><span class="line">    <span class="keyword">auto</span> Component = UGameplayRequestUtils::<span class="built_in">GetComponentByUID</span>(<span class="built_in">GetWorld</span>(), PlayerUID);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Component)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    TArray &lt;UGameplayRequestBase*&gt; PlayerRequests = Component-&gt;<span class="built_in">GetRequests</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> Request : PlayerRequests)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">continue</span>;</span><br><span class="line">        Component-&gt;<span class="built_in">CancelRequest</span>(Request-&gt;<span class="built_in">GetRequestID</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Debug</span></span><br></pre></td></tr></table></figure>
<h2 id="RequestFilter">RequestFilter</h2>
<p>对于每一类 <code>Request</code>，每个玩家身上会有一个对应的 <code>RequestFilter</code>，用来更新可能可以发起请求的目标；</p>
<p>通过 <code>Register / Unregister</code> <code>PossibleTarget</code>，然后更新对应的 <code>FilterTargetData</code> 并同步给 <code>Client</code>；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FilterTargetData </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">USTRUCT</span>()</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGameplayRequestFilterTargetData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FGameplayRequestFilterTargetData</span>() = <span class="keyword">default</span>;</span><br><span class="line">	<span class="built_in">FGameplayRequestFilterTargetData</span>(uint64 PlayerUID) : <span class="built_in">PlayerUID</span>(PlayerUID) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> FGameplayRequestFilterTargetData&amp; Other) <span class="keyword">const</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (PlayerUID != Other.PlayerUID) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span> !=(<span class="keyword">const</span> FGameplayRequestFilterTargetData&amp; Other) <span class="keyword">const</span> &#123; <span class="keyword">return</span> !(*<span class="keyword">this</span> == Other); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">FString <span class="title">ToString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">	uint64 PlayerUID;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">	<span class="keyword">bool</span> bValid = <span class="literal">false</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">	FCommonVariantParams Params = &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RequestFilterBase.h</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>(Abstract)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UGameplayRequestFilterBase</span> :</span> <span class="keyword">public</span> UGameplaySubSystemBase</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Config</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> uint32 <span class="title">GetType</span><span class="params">()</span> <span class="keyword">const</span> <span class="title">PURE_VIRTUAL</span><span class="params">(UGameplayRequestFilterBase::GetType, <span class="keyword">return</span> <span class="number">0</span>;)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Config</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Base</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnInit</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnUninit</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FString <span class="title">ToString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	TWeakObjectPtr &lt;<span class="class"><span class="keyword">class</span> <span class="title">UGameplayRequestComponent</span>&gt;</span> Owner;</span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Base</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Replicate</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetLifetimeReplicatedProps</span><span class="params">(TArray&lt;FLifetimeProperty&gt; &amp; OutLifetimeProps)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsSupportedForNetworking</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Replicate</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region FilterTarget</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsTargetValid</span><span class="params">(uint64 TargetUID)</span> <span class="keyword">const</span></span>;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function">FGameplayRequestFilterTargetData <span class="title">GetFilterTargetData</span><span class="params">(uint64 PlayerUID)</span> <span class="keyword">const</span></span>;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FilterTargets</span><span class="params">()</span></span>; <span class="comment">// 主动调用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ClearPossibleTargets</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">RegisterPossibleTarget</span><span class="params">(uint64 TargetUID)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UnregisterPossibleTarget</span><span class="params">(uint64 TargetUID)</span></span>;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">CheckSelfConditionValid</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125; </span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">CheckTargetConditionValid</span><span class="params">(uint64 TargetUID)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnRep_FilterTargetDatas</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated, ReplicatedUsing = OnRep_FilterTargetDatas)</span><br><span class="line">	TArray &lt;FGameplayRequestFilterTargetData&gt; FilterTargetDatas;</span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion FilterTarget</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Helper</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function">uint64 <span class="title">GetUID</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function">APlayerStateBase* <span class="title">GetPlayerState</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">GetTimeNow</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Helper</span></span><br><span class="line">	</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RequestFilterBase.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Base</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestFilterBase::OnInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">OnInit</span>();</span><br><span class="line">	Owner = Cast&lt;UGameplayRequestComponent&gt;(<span class="built_in">GetOuter</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestFilterBase::OnUninit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">OnUninit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">UGameplayRequestFilterBase::ToString</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;[%llu|%s]&quot;</span>), <span class="built_in">GetUID</span>(), *<span class="built_in">GetName</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Base</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Replicate</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestFilterBase::GetLifetimeReplicatedProps</span><span class="params">(TArray&lt;FLifetimeProperty&gt;&amp; OutLifetimeProps)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">GetLifetimeReplicatedProps</span>(OutLifetimeProps);</span><br><span class="line">	<span class="comment">// --------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">	<span class="comment">// --- OwnerOnly</span></span><br><span class="line">	</span><br><span class="line">	FDoRepLifetimeParams OwnerOnlyRepParams;</span><br><span class="line">	OwnerOnlyRepParams.bIsPushBased = <span class="literal">true</span>;</span><br><span class="line">	OwnerOnlyRepParams.Condition = COND_OwnerOnly;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UGameplayRequestFilterBase, FilterTargetDatas, OwnerOnlyRepParams);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Replicate</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region FilterTarget</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UGameplayRequestFilterBase::IsTargetValid</span><span class="params">(uint64 TargetUID)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">auto</span>&amp; Data = <span class="built_in">GetFilterTargetData</span>(TargetUID);</span><br><span class="line">	<span class="keyword">return</span> Data.bValid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FGameplayRequestFilterTargetData <span class="title">UGameplayRequestFilterBase::GetFilterTargetData</span><span class="params">(uint64 PlayerUID)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; Data : FilterTargetDatas)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Data.PlayerUID == PlayerUID)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> Data;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestFilterBase::ClearPossibleTargets</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">GetFilterTargetDatas_Mutable</span>().<span class="built_in">Empty</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestFilterBase::RegisterPossibleTarget</span><span class="params">(uint64 TargetUID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span> (FilterTargetDatas.<span class="built_in">Contains</span>( TargetUID )) <span class="keyword">return</span>;</span><br><span class="line">	FilterTargetDatas.<span class="built_in">Add</span>( &#123; TargetUID &#125; );</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestFilterBase::UnregisterPossibleTarget</span><span class="params">(uint64 TargetUID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span> (!FilterTargetDatas.<span class="built_in">Contains</span>( TargetUID )) <span class="keyword">return</span>;</span><br><span class="line">	FilterTargetDatas.<span class="built_in">Remove</span>( TargetUID );</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestFilterBase::FilterTargets</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> bSelfConditionValid = <span class="built_in">CheckSelfConditionValid</span>();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Data : FilterTargetDatas)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">bool</span> bTargetConditionValid = <span class="built_in">CheckTargetConditionValid</span>(Data.PlayerUID);</span><br><span class="line">		Data.bValid = (bSelfConditionValid &amp;&amp; bTargetConditionValid);</span><br><span class="line">		<span class="comment">// TODO : More Params</span></span><br><span class="line">		Data.Params.<span class="built_in">Clear</span>();</span><br><span class="line">		Data.Params.<span class="built_in">SetValue</span>( <span class="string">&quot;bSelfConditionValid&quot;</span>, bSelfConditionValid );</span><br><span class="line">		Data.Params.<span class="built_in">SetValue</span>( <span class="string">&quot;bTargetConditionValid&quot;</span>, bTargetConditionValid );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">MARK_PROPERTY_DIRTY_FROM_NAME</span>(UGameplayRequestFilterBase, FilterTargetDatas, <span class="keyword">this</span>);</span><br><span class="line">	<span class="built_in">OnRep_FilterTargetDatas</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestFilterBase::OnRep_FilterTargetDatas</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion FilterTarget</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Helper</span></span><br><span class="line"></span><br><span class="line"><span class="function">uint64 <span class="title">UGameplayRequestFilterBase::GetUID</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!Owner.<span class="built_in">IsValid</span>()) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> Owner-&gt;<span class="built_in">GetUID</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">APlayerStateBase* <span class="title">UGameplayRequestFilterBase::GetPlayerState</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!Owner.<span class="built_in">IsValid</span>()) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">return</span> Owner-&gt;GetPlayerState&lt;APlayerStateBase&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">UGameplayRequestFilterBase::GetTimeNow</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> UFunctionLibrary::<span class="built_in">GetGameServerTimeWithSecond</span>(<span class="built_in">GetWorld</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Helper</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Request">Request</h2>
<p>一个 <code>Request</code> 由 <code>RequestManager</code> 持有实际的 <code>Request</code>；</p>
<p>通过 <code>Sender</code> 、<code>Target</code> 的 <code>RequestComponent</code> 将其同步到对应 <code>Client</code>；</p>
<p>对于 <code>Request</code>，定义基本属性、状态以及提供生命周期相关回调；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RequestBase.h</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>(Abstract)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UGameplayRequestBase</span> :</span> <span class="keyword">public</span> UObject</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Config</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> uint32 <span class="title">GetType</span><span class="params">()</span> <span class="keyword">const</span> <span class="title">PURE_VIRTUAL</span><span class="params">(UGameplayRequestBase::GetType, <span class="keyword">return</span> <span class="number">0</span>;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> UClass* <span class="title">GetFilterType</span><span class="params">()</span> <span class="keyword">const</span> <span class="title">PURE_VIRTUAL</span><span class="params">(UGameplayRequestBase::GetFilterType, <span class="keyword">return</span> UGameplayRequestFilterBase::StaticClass();)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Config</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Base</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FString <span class="title">ToString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">uint64 <span class="title">Init</span><span class="params">(uint64 SenderUID, uint64 TargetUID, <span class="keyword">const</span> FCommonVariantParams&amp; InParams)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Uninit</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">inline</span> <span class="keyword">static</span> uint64 REQUEST_ID_COUNTER = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Base</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Replicate</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetLifetimeReplicatedProps</span><span class="params">(TArray&lt;FLifetimeProperty&gt;&amp; OutLifetimeProps)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsSupportedForNetworking</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Replicate</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Validate</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">ValidateRequest</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Validata</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Timeout</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">RegisterTimeoutTimer</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	FTimerHandle TimeoutTimer;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Timeout</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Interact</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">UGameplayRequestManager</span>;</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Accept</span><span class="params">(<span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Reject</span><span class="params">(<span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Cancel</span><span class="params">(<span class="keyword">const</span> FCommonVariantParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Timeout</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Interrupt</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnAccepted</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnRejected</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnCanceled</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Interact</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Create</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">NotifyCreated</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">bool</span> bHasNotifyCreated = <span class="literal">false</span>;</span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Create</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Complete</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">NotifyCompleted</span><span class="params">(EGameplayRequestResult InResult)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnCompleted</span><span class="params">(EGameplayRequestResult InResult)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnRep_Result</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated, ReplicatedUsing=OnRep_Result)</span><br><span class="line">	EGameplayRequestResult Result = EGameplayRequestResult::None;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Complete</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region State</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UpdateState</span><span class="params">(EGameplayRequestState InState)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnStateChanged</span><span class="params">(EGameplayRequestState)</span> </span>&#123;&#125;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnRep_State</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated, ReplicatedUsing=OnRep_State)</span><br><span class="line">	EGameplayRequestState State = EGameplayRequestState::Invalid;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion State</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region KeepAlive</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">GetKeepAliveTime</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> KeepAliveTime; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// 最大保留时间 (完成后也可能保留)</span></span><br><span class="line">	<span class="keyword">float</span> KeepAliveTime = <span class="number">60.0f</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion KeepAlive</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Params</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CombineParams</span><span class="params">(<span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	FCommonVariantParams RequestParams;</span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Params</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Data</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnRep_RequestID</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">    uint64 SenderUID = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">    uint64 TargetUID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">    <span class="keyword">float</span> CreateTime = <span class="number">0.0f</span>;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">    <span class="keyword">float</span> TimeoutDuration = <span class="number">30.0f</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated, ReplicatedUsing=OnRep_RequestID)</span><br><span class="line">	uint64 RequestID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Data</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Helper</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">IsFinished</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">GetTimeNow</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">GetRunningTime</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Helper</span></span><br><span class="line">    </span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RequestBase.cpp</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Base</span></span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">UGameplayRequestBase::ToString</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&#123;[ID=%llu][Type=%d][UID=%llu-&gt;%llu][Params=%s][%s][Time=%.f+%.f(s)][%.f(s), %.f(s)]&#125;&quot;</span>),</span><br><span class="line">		RequestID,</span><br><span class="line">		<span class="built_in">GetType</span>(), SenderUID, TargetUID, *RequestParams.<span class="built_in">ToString</span>(),</span><br><span class="line">		*UStringUtils::<span class="built_in">ToString</span>(State),</span><br><span class="line">		CreateTime, <span class="built_in">GetRunningTime</span>(),</span><br><span class="line">		TimeoutDuration, KeepAliveTime</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">uint64 <span class="title">UGameplayRequestBase::Init</span><span class="params">(uint64 InSenderUID, uint64 InTargetUID, <span class="keyword">const</span> FCommonVariantParams&amp; InParams)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">SetRequestID</span>( ++REQUEST_ID_COUNTER );</span><br><span class="line"></span><br><span class="line">	<span class="built_in">SetSenderUID</span>( InSenderUID );</span><br><span class="line">	<span class="built_in">SetTargetUID</span>( InTargetUID );</span><br><span class="line">	<span class="built_in">SetRequestParams</span>( InParams );</span><br><span class="line">	<span class="built_in">SetState</span>( EGameplayRequestState::Waiting );</span><br><span class="line"></span><br><span class="line">	<span class="built_in">SetCreateTime</span>( <span class="built_in">GetTimeNow</span>() );</span><br><span class="line">	<span class="built_in">SetTimeoutDuration</span>( <span class="number">30.0f</span> );</span><br><span class="line"></span><br><span class="line">	KeepAliveTime = FMath::<span class="built_in">Max</span>(KeepAliveTime, TimeoutDuration);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">bool</span> bValid = <span class="built_in">ValidateRequest</span>();</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bValid == <span class="literal">false</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">RegisterTimeoutTimer</span>();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> RequestID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::Uninit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	</span><br><span class="line">	UWorldTimerManager::<span class="built_in">ClearTimer</span>(<span class="built_in">GetWorld</span>(), TimeoutTimer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Base</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Replicate</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::GetLifetimeReplicatedProps</span><span class="params">(TArray&lt;FLifetimeProperty&gt;&amp; OutLifetimeProps)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">GetLifetimeReplicatedProps</span>(OutLifetimeProps);</span><br><span class="line">	</span><br><span class="line">	FDoRepLifetimeParams SharedParams;</span><br><span class="line">	SharedParams.bIsPushBased = <span class="literal">true</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UGameplayRequestBase, RequestID, SharedParams);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UGameplayRequestBase, SenderUID, SharedParams);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UGameplayRequestBase, TargetUID, SharedParams);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UGameplayRequestBase, RequestParams, SharedParams);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UGameplayRequestBase, CreateTime, SharedParams);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UGameplayRequestBase, TimeoutDuration, SharedParams);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UGameplayRequestBase, RequestID, SharedParams);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UGameplayRequestBase, State, SharedParams);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UGameplayRequestBase, Result, SharedParams);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Replicate</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Validate</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UGameplayRequestBase::ValidateRequest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">GetType</span>() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果没有需要的 Filter 则默认为 true</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">auto</span> Filter = UGameplayRequestUtils::<span class="built_in">GetPlayerFilterByUID</span>(<span class="built_in">GetWorld</span>(), SenderUID, <span class="built_in">GetFilterType</span>()); <span class="built_in">IsValid</span>(Filter))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!Filter-&gt;<span class="built_in">IsTargetValid</span>(TargetUID))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// TODO : 重复 Request</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Validate</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Timeout</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::RegisterTimeoutTimer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (TimeoutDuration &lt;= <span class="number">0.0f</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	UWorldTimerManager::<span class="built_in">SetTimer</span>(<span class="built_in">GetWorld</span>(), TimeoutTimer,</span><br><span class="line">	[WeakSelfPtr = TWeakObjectPtr&lt;UGameplayRequestBase&gt;(<span class="keyword">this</span>)]()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!WeakSelfPtr.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line">		WeakSelfPtr-&gt;<span class="built_in">Timeout</span>();</span><br><span class="line">	&#125;, TimeoutDuration, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Timeout</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Interact</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::Accept</span><span class="params">(<span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IsFinished</span>()) <span class="keyword">return</span>;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">CombineParams</span>(Params);</span><br><span class="line">	<span class="built_in">UpdateState</span>(EGameplayRequestState::Accepted);</span><br><span class="line">	<span class="built_in">OnAccepted</span>();</span><br><span class="line">	<span class="built_in">NotifyCompleted</span>(EGameplayRequestResult::Success);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::Reject</span><span class="params">(<span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IsFinished</span>()) <span class="keyword">return</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">CombineParams</span>(Params);</span><br><span class="line">	<span class="built_in">UpdateState</span>(EGameplayRequestState::Rejected);</span><br><span class="line">	<span class="built_in">OnRejected</span>();</span><br><span class="line">	<span class="built_in">NotifyCompleted</span>(EGameplayRequestResult::Failed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::Cancel</span><span class="params">(<span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IsFinished</span>()) <span class="keyword">return</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">CombineParams</span>(Params);</span><br><span class="line">	<span class="built_in">UpdateState</span>(EGameplayRequestState::Canceled);</span><br><span class="line">	<span class="built_in">OnCanceled</span>();</span><br><span class="line">	<span class="built_in">NotifyCompleted</span>(EGameplayRequestResult::Canceled);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::Timeout</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IsFinished</span>()) <span class="keyword">return</span>;</span><br><span class="line">	<span class="built_in">Cancel</span>( &#123; <span class="string">&quot;CancelReason&quot;</span>, EGameplayRequestCancelReason::Timeout &#125; );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::Interrupt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IsFinished</span>()) <span class="keyword">return</span>;</span><br><span class="line">	<span class="built_in">Cancel</span>( &#123;<span class="string">&quot;CancelReason&quot;</span>, EGameplayRequestCancelReason::Interrupt&#125; );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Interact</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Create</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::NotifyCreated</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bHasNotifyCreated) <span class="keyword">return</span>;</span><br><span class="line">	bHasNotifyCreated = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Create</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Complete</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::NotifyCompleted</span><span class="params">(EGameplayRequestResult InResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">SetResult</span>(InResult);</span><br><span class="line">	<span class="built_in">OnCompleted</span>(InResult);</span><br><span class="line">	<span class="built_in">OnRep_Result</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::OnRep_Result</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Complete</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region State</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::UpdateState</span><span class="params">(EGameplayRequestState InState)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (InState == State) <span class="keyword">return</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">SetState</span>(InState);</span><br><span class="line">	<span class="built_in">OnStateChanged</span>(InState);</span><br><span class="line">	<span class="built_in">OnRep_State</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::OnRep_State</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion State</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Params</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::CombineParams</span><span class="params">(<span class="keyword">const</span> FCommonVariantParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (Params.<span class="built_in">IsEmpty</span>()) <span class="keyword">return</span>;</span><br><span class="line">	<span class="built_in">SetRequestParams</span>( RequestParams + Params );</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Params</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Data</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayRequestBase::OnRep_RequestID</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Data</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Helper</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UGameplayRequestBase::IsFinished</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> State != EGameplayRequestState::Waiting &amp;&amp; State != EGameplayRequestState::Invalid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">UGameplayRequestBase::GetTimeNow</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> UFunctionLibrary::<span class="built_in">GetGameServerTimeWithSecond</span>(<span class="built_in">GetWorld</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">UGameplayRequestBase::GetRunningTime</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">float</span> TimeNow = <span class="built_in">GetTimeNow</span>();</span><br><span class="line">	<span class="keyword">return</span> TimeNow - CreateTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Helper</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="GameplayRequestUtils">GameplayRequestUtils</h2>
<p>通过该 <code>Utils</code> 提供一些方法给外部使用；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GameplayRequestUtils.h</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UGameplayRequestUtils</span> :</span> <span class="keyword">public</span> UBlueprintFunctionLibrary</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Base</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">static</span> UGameplayRequestManager* <span class="title">GetManager</span><span class="params">(UWorld* InWorld)</span></span>;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">static</span> UGameplayRequestComponent* <span class="title">GetComponent</span><span class="params">(APlayerStateBase* PS)</span></span>;</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">static</span> UGameplayRequestComponent* <span class="title">GetComponentByUID</span><span class="params">(UWorld* InWorld, uint64 UID)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Base</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Filter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">static</span> UGameplayRequestFilterBase* <span class="title">GetPlayerFilter</span><span class="params">(APlayerStateBase* PS, UClass* FilterType)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">static</span> UGameplayRequestFilterBase* <span class="title">GetPlayerFilterByUID</span><span class="params">(UWorld* InWorld, uint64 UID, UClass* FilterType)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Filter</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Request</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">static</span> UGameplayRequestBase* <span class="title">GetRequest</span><span class="params">(UWorld* InWorld, uint64 RequestID)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">static</span> UGameplayRequestBase* <span class="title">GetPlayerRequest</span><span class="params">(APlayerStateBase* PS, uint64 RequestID)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">static</span> TArray&lt;UGameplayRequestBase*&gt; <span class="title">GetPlayerRequests</span><span class="params">(APlayerStateBase* PS)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">static</span> TArray&lt;UGameplayRequestBase*&gt; <span class="title">GetPlayerRequestsByType</span><span class="params">(APlayerStateBase* PS, uint32 Type)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Request</span></span><br><span class="line">	</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GameplayRequestUtils.cpp</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Base</span></span><br><span class="line"></span><br><span class="line"><span class="function">UGameplayRequestManager* <span class="title">UGameplayRequestUtils::GetManager</span><span class="params">(UWorld* InWorld)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (InWorld == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">return</span> UFunctionLibrary::GetGameStateComponentFromWorld&lt;UGameplayRequestManager&gt;(InWorld);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UGameplayRequestComponent* <span class="title">UGameplayRequestUtils::GetComponent</span><span class="params">(APlayerStateBase* PS)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(PS)) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">return</span> UFunctionLibrary::GetPlayerStateComponent&lt;UGameplayRequestComponent&gt;(PS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UGameplayRequestComponent* <span class="title">UGameplayRequestUtils::GetComponentByUID</span><span class="params">(UWorld* InWorld, uint64 UID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(InWorld)) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">auto</span> PS = UFunctionLibrary::<span class="built_in">GetPlayerStateByUID</span>(InWorld, UID);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(PS)) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">GetComponent</span>(PS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Base</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Filter</span></span><br><span class="line"></span><br><span class="line"><span class="function">UGameplayRequestFilterBase* <span class="title">UGameplayRequestUtils::GetPlayerFilter</span><span class="params">(APlayerStateBase* PS, UClass* FilterType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> Component = <span class="built_in">GetComponent</span>(PS);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Component)) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">return</span> Component-&gt;<span class="built_in">GetFilter</span>(FilterType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UGameplayRequestFilterBase* <span class="title">UGameplayRequestUtils::GetPlayerFilterByUID</span><span class="params">(UWorld* InWorld, uint64 UID, UClass* FilterType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> Component = <span class="built_in">GetComponentByUID</span>(InWorld, UID);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Component)) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">return</span> Component-&gt;<span class="built_in">GetFilter</span>(FilterType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Filter</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Request</span></span><br><span class="line"></span><br><span class="line"><span class="function">UGameplayRequestBase* <span class="title">UGameplayRequestUtils::GetRequest</span><span class="params">(UWorld* InWorld, uint64 RequestID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(InWorld)) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IsStandaloneOrDS</span>(InWorld))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">auto</span> Manager = <span class="built_in">GetManager</span>(InWorld);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">IsValid</span>(Manager))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> Manager-&gt;<span class="built_in">GetRequest</span>( RequestID );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">IsClient</span>(InWorld))</span><br><span class="line">	&#123;</span><br><span class="line">		APlayerStateBase* HostPS = UFunctionLibrary::<span class="built_in">GetPlayerStateByUID</span>(InWorld, UFunctionLibrary::<span class="built_in">GetMainPlayerUID</span>(InWorld));</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">IsValid</span>(HostPS))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">GetPlayerRequest</span>( HostPS, RequestID );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">UGameplayRequestBase* <span class="title">UGameplayRequestUtils::GetPlayerRequest</span><span class="params">(APlayerStateBase* PS, uint64 RequestID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> Component = <span class="built_in">GetComponent</span>(PS);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Component)) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">return</span> Component-&gt;<span class="built_in">GetRequest</span>( RequestID );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TArray&lt;UGameplayRequestBase*&gt; <span class="title">UGameplayRequestUtils::GetPlayerRequests</span><span class="params">(APlayerStateBase* PS)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> Component = <span class="built_in">GetComponent</span>(PS);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Component)) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">	<span class="keyword">return</span> Component-&gt;<span class="built_in">GetRequests</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TArray&lt;UGameplayRequestBase*&gt; <span class="title">UGameplayRequestUtils::GetPlayerRequestsByType</span><span class="params">(APlayerStateBase* PS, uint32 Type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> Requests = <span class="built_in">GetPlayerRequests</span>(PS);</span><br><span class="line">	TArray &lt;UGameplayRequestBase*&gt; OutRequests;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> Request : Requests)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Request)) <span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (Request-&gt;<span class="built_in">GetType</span>() == Type)</span><br><span class="line">		&#123;</span><br><span class="line">			OutRequests.<span class="built_in">Add</span>( Request );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> OutRequests;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Request</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Sample">Sample</h2>
<p>创建一个请求时，只需要创建该类型对应的 <code>RequestFilter</code>、<code>Request</code> 即可；</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request_Test.h</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UGameplayRequest_Test</span> :</span> <span class="keyword">public</span> UGameplayRequestBase</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Config</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> uint32 <span class="title">GetType</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="number">1001</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> UClass* <span class="title">GetFilterType</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> UGameplayRequestFilter_Test::<span class="built_in">StaticClass</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Config</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnAccepted</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnRejected</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnCanceled</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RequestFilter_Test.h</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UGameplayRequestFilter_Test</span> :</span> <span class="keyword">public</span> UGameplayRequestFilterBase</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Config</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> uint32 <span class="title">GetType</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="number">1001</span>; &#125;</span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion Config</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsTargetValid</span><span class="params">(uint64 TargetUID)</span> <span class="keyword">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">BearChild</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://www.bearchild.top/2025/06/25/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]GameplayRequestSystem%E6%A1%86%E6%9E%B6/">https://www.bearchild.top/2025/06/25/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]GameplayRequestSystem%E6%A1%86%E6%9E%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Gameplay/">Gameplay</a><a class="post-meta__tags" href="/tags/UE/">UE</a></div><div class="post_share"><div class="social-share" data-image="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202506252357006.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/03/15/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/%5BUE%5DGameplaySubSystem%E5%AE%9E%E7%8E%B0/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202503151618701.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">[UE]GameplaySubSystem实现</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/03/15/游戏开发/Gameplay/[UE]GameplaySubSystem实现/" title="[UE]GameplaySubSystem实现"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202503151618701.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-15</div><div class="title">[UE]GameplaySubSystem实现</div></div></a></div><div><a href="/2024/06/25/游戏开发/Gameplay/[UE]Command解决方案/" title="[UE]Command解决方案"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202406252220210.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-25</div><div class="title">[UE]Command解决方案</div></div></a></div><div><a href="/2024/06/01/游戏开发/Gameplay/[UE]ToString解决方案/" title="[UE]ToString解决方案"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202406011645050.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-01</div><div class="title">[UE]ToString解决方案</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/usage/%E6%BB%91%E7%A8%BD.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">BearChild</div><div class="author-info__description">前路浩荡，未来可期！</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">209</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://qm.qq.com/cgi-bin/qm/qr?k=ULZEQtGq1dv7fjaZmZjv4aKPdTOlaU1u&amp;noverify=0" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="https://github.com/DoveChild" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://www.zhihu.com/people/bearchild-91" target="_blank" title="知乎"><i class="fab fa-zhihu"></i></a><a class="social-icon" href="mailto:423339833@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">Welcome, - v - QQ：423339833</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">GameplayRequestSystem框架</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6"><span class="toc-number">1.1.</span> <span class="toc-text">基本框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Request-Manager"><span class="toc-number">1.2.</span> <span class="toc-text">Request Manager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RequestComponent"><span class="toc-number">1.3.</span> <span class="toc-text">RequestComponent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RequestFilter"><span class="toc-number">1.4.</span> <span class="toc-text">RequestFilter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Request"><span class="toc-number">1.5.</span> <span class="toc-text">Request</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GameplayRequestUtils"><span class="toc-number">1.6.</span> <span class="toc-text">GameplayRequestUtils</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sample"><span class="toc-number">1.7.</span> <span class="toc-text">Sample</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', '', 'katex-wrap')
  })
})()</script><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script></div><script src="/decoration/background.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>