<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>BearChild&#39;s Blog</title>
  
  
  <link href="https://www.bearchild.top/atom.xml" rel="self"/>
  
  <link href="https://www.bearchild.top/"/>
  <updated>2024-04-26T14:19:18.605Z</updated>
  <id>https://www.bearchild.top/</id>
  
  <author>
    <name>BearChild</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ACT浅思</title>
    <link href="https://www.bearchild.top/2024/04/24/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/3C/ACT%E6%B5%85%E6%80%9D/"/>
    <id>https://www.bearchild.top/2024/04/24/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/3C/ACT%E6%B5%85%E6%80%9D/</id>
    <published>2024-04-23T16:00:00.000Z</published>
    <updated>2024-04-26T14:19:18.605Z</updated>
    
    <content type="html"><![CDATA[<h1>ACT浅思</h1><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202404262219322.png" alt="image-20240426221904635"></p><h2 id="ACT-表现">ACT 表现</h2><h3 id="动作">动作</h3><ol><li>动作节奏：</li></ol><pre class="mermaid">flowchart LR前摇--->攻击判定--->后摇-->后摇-可打断</pre><p>需要控制好每个阶段的时间分配，表现不同的节奏；</p><blockquote><p>较长的后摇可以方便玩家明确下一步操作（不攻击、打断后摇继续攻击），判定更明确；</p><p>较短的后摇可以增加动作连续性连续，提升手感；</p></blockquote><ol start="2"><li>动画配合：</li></ol><p>动画曲线配合：从动画中提取曲线，配合曲线调整位移；比如移动，需要在脚落下的那一刻位移速度最大，其余阶段几乎不位移；</p><p>攻击方、受击方动画、位移需要匹配；</p><ol start="3"><li>受击表现：</li></ol><p>受击动作，可以有夸张的表现，具体在 硬直、击退、击飞 等；同时可以添加骨骼抖动强化受击反馈；</p><ol start="4"><li>爽感优化</li></ol><p>顿帧：伤害越大顿帧越久，一般发生在 攻击方接触受击方、技能或连招开始与结束时；</p><p>连招：较长的连招（意味着更大的风险）过后，可以添加夸张的收尾表演，释放压力；</p><p>终结技：目标强僵直、残血时可以添加慢镜头终结技；</p><h3 id="镜头">镜头</h3><ol><li>运镜逻辑：</li></ol><p>镜头内容：需要保证全程看清目标，更多以目标为核心；需要保证目标完整在镜头内（尤其是使用大位移技能时）；尽量避免主角与目标重叠；</p><p>镜头构图：可以稍微错位，可以看清目标动作；</p><ol start="2"><li>镜头效果：</li></ol><p>屏幕震动：普攻可以增加左右偏移、重击增加上下纵深偏移；</p><p>子弹时间：在合适的时候增加子弹时间，可以表现出力量感；</p><p>镜头模糊：径向模糊、动态模糊、空气扭曲等效果；可以表现出速度感；</p><h3 id="UI">UI</h3><ol><li><code>HUD</code> 的缩放、偏移、光效；</li><li>屏幕闪屏：在使用技能或击杀目标时，可以增加闪屏或者黑屏淡入淡出等效果；</li><li>准心变化：颜色、大小、特殊形态（骷髅表示击杀、打叉表示命中或爆头）；</li><li>跳字：分为普攻、暴击、恢复；主要调整：轨迹（抛物线、弹出、上浮）、缩放、透明度、重力、字体、颜色；比如暴击一般离散范围小、上浮位移大、爆发力可以更强；</li><li>连击提示：与击打节奏契合；</li><li>受击指向：被攻击的方向；</li></ol><h3 id="特殊效果">特殊效果</h3><ol><li>特效：</li></ol><blockquote><ol><li>普通特效：技能本身效果（武器发光等），保证和场景颜色差异大；</li><li>粒子特效：与目标解除时出现 命中/防御/暴击 等粒子表现；场景破碎效果等；</li><li>环境特效：对环境的氛围影响，场景灯光、场景变色；</li><li>角色特效：角色自身的发光等表现；</li></ol></blockquote><ol start="2"><li>音效：在进行指定行为时，需要有特定音效反馈，比如冲击、发射、受击等；</li><li>背景音乐：战斗和漫游需要有不同的音乐变化；</li><li>物理震动：手柄、手机的震动反馈；</li></ol><h2 id="ACT-数值">ACT 数值</h2><h3 id="攻击方">攻击方</h3><ol><li><p>基本属性：攻击力、暴击率、属性加成；</p></li><li><p>攻击范围：</p><blockquote><ol><li>自身：关注攻击碰撞盒，方向、距离、范围等；</li><li>抛射物：关注触发方式（时间、瞄准方式）、轨迹等；</li></ol></blockquote></li><li><p>攻击强度：</p><blockquote><ol><li>进攻强度：与对方防御强度对比，决定对对方造成的伤害与效果；</li><li>维持强度：保证攻击完整的能力，与敌方进攻强度对比，决定攻击是否会被对方攻击打断；</li><li>命中效果：硬直时间（防御、命中），特殊表现（击飞、倒地）</li></ol></blockquote></li><li><p>攻击节奏：前摇、生效（判定时间、持续时间）、后摇</p></li><li><p>攻击位移：水平位移、空中位移</p></li></ol><h3 id="防守方">防守方</h3><ol><li><p>基本属性：防御值、护甲、抗性、伤害减免；</p></li><li><p>防守范围：</p><blockquote><ol><li>受击判定：是否进行判定（硬直）、无敌帧</li><li>受击范围：受击碰撞盒、防守碰撞盒</li></ol></blockquote></li><li><p>防守强度：</p><blockquote><ol><li>格挡：格挡强度、格挡范围、移动距离</li><li>闪避：移动距离、无敌时间、后摇硬直时间</li><li>反击：允许反击的时间与状态、无敌时间、硬直时间</li></ol></blockquote></li><li><p>防守体力：</p><blockquote><ol><li>体力上限：最大体力值，受到攻击、进行防守等行为会降低体力，体力为 0 会进入硬直</li><li>体力恢复：脱战恢复体力</li></ol></blockquote></li></ol><h2 id="参考">参考</h2><p><a href="https://zhuanlan.zhihu.com/p/360843202">拳打冥王脚踢地府——《黑帝斯》战斗设计分析</a></p><p><a href="https://game.academy.163.com/course/careerArticle?course=324">最畅爽的打击感从何而来？</a></p><p><a href="https://zhuanlan.zhihu.com/p/342697831">《战双帕弥什》的动作打击感是怎么做出来的</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;ACT浅思&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202404262219322.png&quot; alt=&quot;image-20</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="3C" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/3C/"/>
    
    
    <category term="3C" scheme="https://www.bearchild.top/tags/3C/"/>
    
  </entry>
  
  <entry>
    <title>[UE]ReplicationGraph源码浅析</title>
    <link href="https://www.bearchild.top/2024/04/21/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/[UE]ReplicationGraph%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/"/>
    <id>https://www.bearchild.top/2024/04/21/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/[UE]ReplicationGraph%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/</id>
    <published>2024-04-20T16:00:00.000Z</published>
    <updated>2024-04-26T15:40:29.077Z</updated>
    
    <content type="html"><![CDATA[<h1>ReplicationGraph源码浅析</h1><h2 id="简介">简介</h2><p><code>UnrealEngine</code> 基本的网络同步在进行同步时需要对每个连接判断每个 <code>Actor</code> 是否需要同步，开销较大；</p><p>可以通过实现 <code>Replication</code> ，实现一个不同的 <code>ReplicationDriver</code> 来优化性能；</p><p><code>Replication</code> 将 <code>World</code> 分为多个区域 <code>Grid</code>，把 <code>Actor</code> 根据所在 <code>Grid</code> 进行分类编组，可以快速找出需要同步的 <code>Actor</code>，同时确定哪些区域需要进行同步复制。</p><h2 id="数据结构">数据结构</h2><pre class="mermaid">classDiagram    class UReplicationGraph</pre><ol><li><code>FGlobalActorReplicationInfo </code>：同步的 <code>Actor</code> 信息，包括</li></ol><blockquote><p><code>Settings</code>：<code>FClassReplicationInfo</code>，每个 <code>Actor Class</code> 对应的同步配置，包括 <code>CullDistance</code>、<code>ReplicationPeriodFrame</code>、<code>PriorityScale</code> 等；</p><p><code>Events</code>：<code>FGlobalActorReplicationEvents Events</code>，记录休眠状态的改变时，从休眠列表中添加或者移除；</p><p><code>FConnectionReplicationActorInfo</code>：对于 <code>Connection</code> 同步的 <code>Actor</code> 信息；</p></blockquote><ol start="3"><li><p><code>ReplicationGraphNode</code>：<code>GraphNode</code> 基类</p></li><li><p><code>ReplicationGraphNode_ActorList</code>：记录同步的 <code>Actors</code>；在 <code>StreamingLevelCollection</code> （以 <code>SubLevelName</code> 为 <code>Key</code> 的 <code>List</code>）中记录 <code>SubLevel</code> 的 <code>Actor</code>，否则在 <code>ReplicationActorList</code> 中记录。</p></li><li><p><code>GlobalGraphNodes</code>：维护 <code>GridSpatialization2D</code></p></li></ol><h2 id="GraphNode">GraphNode</h2><pre class="mermaid">classDiagram    class UReplicationGraphNode {        TArray~UReplicationGraphNode*~ AllChildNodes        GatherActorListsForConnection()        RouteAddNetworkActorToNodes()        RouteRemoveNetworkActorToNodes()    }    UReplicationGraphNode <|-- UReplicationGraphNode_ActorList     class UReplicationGraphNode_ActorList {    FActorRepListRefView ReplicationActorList    }            UReplicationGraphNode <|-- UReplicationGraphNode_GridSpatialization2D    class UReplicationGraphNode_GridSpatialization2D {        TArray~TArray[UReplicationGraphNode_GridCell*]~ Grid;    }        UReplicationGraphNode <|-- UReplicationGraphNode_AlwaysRelevant    class UReplicationGraphNode_AlwaysRelevant{        TArray~UClass*~AlwaysRelevantClasses;    }        UReplicationGraphNode <|-- UReplicationGraphNode_ActorListFrequencyBuckets         UReplicationGraphNode_ActorList <|-- UReplicationGraphNode_GridCell     class UReplicationGraphNode_GridCell{    }        UReplicationGraphNode_ActorList <|-- UReplicationGraphNode_AlwaysRelevant_ForConnection     class UReplicationGraphNode_AlwaysRelevant_ForConnection{    }</pre><ol><li><code>GridSpatalization2D</code>：将世界划分为 <code>2D</code> 网格，按位置把 <code>Actor</code> 分到不同的 <code>GridCell</code> 中，按空间管理<code>Actor</code> 是否进行同步，每帧更新 <code>GridCell</code> 内的 <code>Actor</code>；</li><li><code>GridCell</code>：<code>ReplicationActorList</code> 缓存着在该 <code>GridCell</code> 中的所有静态 <code>Actor</code>，<code>DynamicNodes</code> 里记录动态的 <code>Actor</code>，<code>DormancyNode</code> 里记录休眠的<code>Actor</code>；</li><li><code>AlwaysRelevant </code>：处理总是发送 <code>Net Updates</code> 给 所有 <code>Connections</code> 的 <code>Actors</code>；</li><li><code>AlwaysRelevant_ForConnection</code>：处理总是发送 <code>Net Updates</code> 给 特定 <code>Connection</code> 的 <code>Actors</code> ，一般是同步给 <code>PlayerController</code> 和 <code>ViewTarget</code>；</li><li><code>ActorListFrequencyBuckets </code>：记录地图格子上的 动态 <code>Actor</code> ;</li></ol><h2 id="生命周期">生命周期</h2><h3 id="Init">Init</h3><pre class="mermaid">graph TDStart(UNetDriver::InitBase) --> A("UNetDriver::SetReplicationDriver")A --> B("UReplicationGraph::InitializeActorsInWorld")B --> | 将World中的同步对象添加到对应GraphNode | C("UReplicationGraph::InitializeForWorld")C --> D("UReplicationGraph::AddNetworkActor(AActor* Actor)") A --> E(InitForNetDriver)E --> F(InitGlobalActorClassSettings)E --> G(InitGlobalGraphNodes)</pre><p><code>InitGlobalActorClassSettings</code>：设置 <code>CulltDistance</code>、<code>ReplicationPeriodFrame</code>；注册 <code>Actor</code> 对应的 <code>ClassReplicationInfo</code> 到 <code>GlobalActorReplicationInfoMap</code>；</p><p><code>InitGlobalGraphNodes</code>：创建 <code>GridSpatialization2D</code>、<code>AlwaysRelevant</code> 的 <code>GraphNode</code>；</p><p><code>InitConnectionGraphNodes</code>：创建 <code>AlwaysRelevantForConnection</code> 的 <code>GraphNode</code>；</p><p><code>RouteAddNetworkActorToNodes </code>：生成 <code>Actor</code> 时，添加 <code>NetworkActor</code>，分发 <code>Actor</code> 到 <code>GraphNode</code>；</p><p><code>RouteRemoveNetworkActorToNodes </code>：销毁 <code>Actor</code> 时，删除 <code>NetworkActor</code>，通知<code>GraphNode</code> 移除 <code>Actor</code>；</p><h3 id="Repliate">Repliate</h3><pre class="mermaid">graph TBStart(ServerReplicateActors) --> A(PrepareForReplication)A --> B(GatherActorListsForConnection)B --> C(ReplicateActorListsForConnections_Default)C --> D[ReplicateSingleActor]</pre><ol><li><p><code>PrepareForReplication</code> ： 调用 <code>GraphNode</code> 的 <code>PrepareForReplication</code>：</p><p>对于 <code>GridSpatialization2D</code>，会遍历 <code>Actor</code>，更新其所在的 <code>Grid</code>；</p><p>对于 <code>AlwaysRelevant</code>，记录需要同步给所有连接的 <code>Actor</code>；</p></li><li><p><code>GatherActorListsForConnection</code> ： 遍历 <code>Connections</code> 收集 <code>ReplicationActorList</code></p><p>针对每个 <code>Connection</code> 遍历 <code>GlobalGraphNodes</code> 和 <code>Connection</code> 的<code>ConnectionGraphNodes</code>，调用其 <code>GatherActorListsForConnection</code>，收集需要同步给这个<code>Connection</code> 的 <code>Actor</code>；</p><p>对于 <code>GridSpatialization2D</code>，通过其 <code>GridCellNode</code> 根据 <code>Actor</code> 的<code>ViewLocation</code> 收集；</p><p>收集的 <code>Actor</code> 默认加到 <code>GatheredReplicationListsForConnection</code> 里的 <code>EActorRepListTypeFlags.Default List</code>。</p></li><li><p><code>ReplicateActorListsForConnections_Default</code>：进行 <code>Replicate</code> 的同步检测与排序</p><p>对 <code>GatheredReplicationListsForConnection</code> 里的 <code>Actor</code>，进行检测；</p><p>首先排除 <code>Dormancy</code>、不满足<code>ReplicateFrame</code> 的 <code>Actor</code>，然后根据优先级排序（<code>Distance</code>、<code>Starvation</code>、<code>逻辑判定</code>、<code>Owner &amp; ViewTarget</code>)，将结果缓存在 <code>PrioritizedReplicationList</code> 中；</p></li><li><p><code>ReplicateSingleActor</code>：对排好序的 <code>PrioritizedReplicationList</code> 调用 <code>ReplicateSingleActor</code> 进行同步。</p></li></ol><h2 id="参考">参考</h2><p><a href="https://dev.epicgames.com/documentation/en-us/unreal-engine/replication-graph-in-unreal-engine">UE ReplicationGraph Document</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;ReplicationGraph源码浅析&lt;/h1&gt;
&lt;h2 id=&quot;简介&quot;&gt;简介&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;UnrealEngine&lt;/code&gt; 基本的网络同步在进行同步时需要对每个连接判断每个 &lt;code&gt;Actor&lt;/code&gt; 是否需要同步，开销较大；&lt;/p&gt;
</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="网络" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="UE" scheme="https://www.bearchild.top/tags/UE/"/>
    
    <category term="网络" scheme="https://www.bearchild.top/tags/%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>[UE]Networking源码浅析</title>
    <link href="https://www.bearchild.top/2024/04/20/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/[UE]Networking%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/"/>
    <id>https://www.bearchild.top/2024/04/20/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/[UE]Networking%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/</id>
    <published>2024-04-19T16:00:00.000Z</published>
    <updated>2024-04-26T15:30:09.646Z</updated>
    
    <content type="html"><![CDATA[<h1>Networking源码浅析</h1><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202404262212892.png" alt="image-20240426221216657"></p><h2 id="定义">定义</h2><p><code>Bunch</code>：表示一组相关的网络数据，包含 <code>RPC / 属性同步</code> 等信息，<code>UE</code> 中 <code>DS/Client</code> 通信的基本单位。</p><p><code>Packet</code>：<code>UDP</code> 的基本传输单位，可以打包一个或多个 <code>Bunch</code>，在接受端进行解析。</p><p><code>NetDriver</code>：管理网络通信，比如管理连接、处理数据包的发送和接收、处理网络事件。</p><p><code>NetConnection</code>：表示一个网络连接，与一个 <code>NetDriver</code> 关联，并通过 <code>NetDriver</code> 进行实际的网络通信。</p><p><code>Channel</code>：管理网络传输，进行数据分类，提供  <code>SendBunch</code>、<code>ReceivedRawBunch</code> 方法，由 <code>NetConnection</code> 管理，一个 <code>NetConnection</code> 可以包含多种 <code>Channel</code>。</p><p><code>FObjectReplicator</code>：处理对象的网络同步，保存属性快照，进行状态改变发送、更新同步状态、接受与发送消息。</p><p><code>ActorChannel</code>：关联特定的 <code>Actor</code> 负责其同步，包含多个 <code>FObjectReplicator</code> 用于复制其 <code>Actor</code>、<code>ActorComponent</code> 。</p><p><code>FRepLayout</code>：管理复制的属性，定义底层数据内存布局，数据比较、序列化与反序列化等。</p><h2 id="RPC">RPC</h2><p><strong>Server RPC</strong></p><table><thead><tr><th>Calling Machine</th><th>Owning Connection</th><th>Executing Machine</th></tr></thead><tbody><tr><td>Server</td><td>Client</td><td>Server</td></tr><tr><td>Server</td><td>Server</td><td>Server</td></tr><tr><td>Server</td><td>None</td><td>Server</td></tr><tr><td>Client</td><td>Invoking Client</td><td>Server</td></tr><tr><td>Client</td><td>Different Client</td><td>Dropped</td></tr><tr><td>Client</td><td>Server</td><td>Dropped</td></tr><tr><td>Client</td><td>None</td><td>Dropped</td></tr></tbody></table><p><strong>Client RPC</strong></p><table><thead><tr><th>Calling Machine</th><th>Owning Connection</th><th>Executing Machine</th></tr></thead><tbody><tr><td>Server</td><td>Owning Client</td><td>Owning Client</td></tr><tr><td>Server</td><td>Server</td><td>Server</td></tr><tr><td>Server</td><td>None</td><td>Server</td></tr><tr><td>Client</td><td>Invoking Client</td><td>Invoking Client</td></tr><tr><td>Client</td><td>Different Client</td><td>Invoking Client</td></tr><tr><td>Client</td><td>Server</td><td>Invoking Client</td></tr><tr><td>Client</td><td>None</td><td>Invoking Client</td></tr></tbody></table><p><strong>NetMulticast RPC</strong></p><table><thead><tr><th>Calling Machine</th><th>Owning Connection</th><th>Executing Machine</th></tr></thead><tbody><tr><td>Server</td><td>Client</td><td>Server and all Clients the invoking actor is relevant for</td></tr><tr><td>Server</td><td>Server</td><td>Server and all Clients the invoking actor is relevant for</td></tr><tr><td>Server</td><td>None</td><td>Server and all Clients the invoking actor is relevant for</td></tr><tr><td>Client</td><td>Invoking Client</td><td>Invoking Client</td></tr><tr><td>Client</td><td>Different Client</td><td>Invoking Client</td></tr><tr><td>Client</td><td>Server</td><td>Invoking Client</td></tr><tr><td>Client</td><td>None</td><td>Invoking Client</td></tr></tbody></table><p><strong>Send RPC</strong></p><pre class="mermaid">flowchart TBUObject::ProcessEvent-- FunctionCallspace::Remote --> AActor::CallRemoteFunction--> UNetDriver::ProcessRemoteFunctionServerMulticast(bIsServerMulticast)UNetDriver::ProcessRemoteFunction--> ServerMulticastServerMulticast--TRUE-->UNetDriver::GetFunctionRepLayout--Actor IsNetRelevant || FUNC_NetReliable --> FRepLayout::BuildSharedSerializationForRPC--> UNetDriver::InternalProcessRemoteFunctionPrivate--> UNetDriver::ProcessRemoteFunctionForChannelPrivateServerMulticast--FALSE--> UReplicationGraph::ProcessRemoteFunction--> UNetDriver::ProcessRemoteFunctionForChannel--> UNetDriver::ProcessRemoteFunctionForChannelPrivate-- FRepLayout::SendPropertiesForRPC --> QueueBunchQueueBunch(!bReliable & NetMulticast)QueueBunch--TRUE-->UChannel::SendBunchQueueBunch--FALSE-->UActorChannel::QueueRemoteFunctionBunch</pre><p><strong>Receive RPC</strong></p><pre class="mermaid">flowchart TBUIpNetDriver::TickDispatch--> UNetConnection::ReceivedRawPacket--> UNetConnection::ReceivedPacket--> UNetConnection::DispatchPacket--> UChannel::ReceivedRawBunch--> UChannel::ReceivedNextBunch--> UChannel::ReceivedSequencedBunch--> UActorChannel::ReceivedBunch--> UActorChannel::ProcessBunch--> FObjectReplicator::ReceivedBunch-- FObjectReplicator::ReceivedRPC--> UObject::ProcessEvent</pre><h2 id="属性同步">属性同步</h2><p><strong>Replicate Diff</strong></p><pre class="mermaid">flowchart TBUNetDriver::TickFlush--> UNetDriver::ServerReplicateActors--> UActorChannel::ReplicateActor--> FObjectReplicator::ReplicateProperties--> FNetSerializeCB::UpdateChangelistMgr--> FRepLayout::UpdateChangelistMgr--> FRepLayout::CompareProperties</pre><p><strong>Replicate Send</strong></p><pre class="mermaid">flowchart TBUNetDriver::TickFlush--> UNetDriver::ServerReplicateActors--> UActorChannel::ReplicateActor--> FObjectReplicator::ReplicateProperties--> FRepLayout::ReplicateProiperties--> FRepLayout::SendProperties--> FProperty::NetSerializeItem--> UChannel::SendBunch</pre><p><strong>Replicate Receive</strong></p><pre class="mermaid">flowchart TBUIpNetDriver::TickDispatch--> UNetConnection::ReceivedRawPacket--> UNetConnection::ReceivedPacket--> UNetConnection::DispatchPacket--> UChannel::ReceivedRawBunch--> UChannel::ReceivedNextBunch--> UChannel::ReceivedSequencedBunch--> UActorChannel::ReceivedBunch--> UActorChannel::ProcessBunch--> FObjectReplicator::ReceivedBunch--> FRepLayout::ReceiveProperties--> FRepLayout::ReceivePropertyHelper--> FProperty::NetSerializeItem--> FObjectReplicator::PostReceivedBunch--> FObjectReplicator::CallRepNotifies</pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;Networking源码浅析&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202404262212892.png&quot; alt=</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="网络" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="UE" scheme="https://www.bearchild.top/tags/UE/"/>
    
    <category term="网络" scheme="https://www.bearchild.top/tags/%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>[UE]弱网工具Clumsy的使用</title>
    <link href="https://www.bearchild.top/2024/04/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/[UE]%E5%BC%B1%E7%BD%91%E5%B7%A5%E5%85%B7Clumsy%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>https://www.bearchild.top/2024/04/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/[UE]%E5%BC%B1%E7%BD%91%E5%B7%A5%E5%85%B7Clumsy%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2024-04-13T16:00:00.000Z</published>
    <updated>2024-04-14T11:41:55.634Z</updated>
    
    <content type="html"><![CDATA[<h1>弱网工具Clumsy的使用</h1><p><strong>Clumsy</strong> 用于弱网测试时，进行本地弱网环境的模拟，基于 <a href="https://github.com/basil00/Divert">WinDivert</a> 实现，可以出模拟延迟、丢包等网络状态。</p><h2 id="Downloads">Downloads</h2><p>下载地址：<a href="https://github.com/jagt/clumsy">Clumsy</a>；官方文档：<a href="https://jagt.github.io/clumsy/cn/index.html">Clumsy Manual</a></p><p>下载后的几个重点文件：</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202404141744461.png" alt="%~UYF6SWT2EC28Q%6Z4N_EM"></p><p>打开 <strong>Clumsy.exe</strong> 可以看到以下内容：</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202404141744627.png" alt="image-20240414172540109" style="zoom:50%;" /><p>可以看出这里有几个重点的 <code>Function</code>，一般重点使用 <strong>Lag 延迟</strong>、<strong>Drop 丢包</strong>。</p><p>在 <code>Filtering</code> 填入对应的 <code>Command</code> 后，设置 <code>Functions</code>，点击 <code>Start</code> 即可开始模拟。</p><p>同时可以在 <code>Config.txt</code> 中，预设一些 <code>Presets</code> 方便下次使用。</p><h2 id="UE-DS-中的使用">UE DS 中的使用</h2><p>对于 <code>UE</code>的 <code>DS</code> 环境，首先为了具体到某一个 <code>Client</code> / <code>DS</code>，采用 <code>Filter Port</code> 的机制，对某个具体的端口号进行操作。</p><p>用 <code>netstat -aon\Findstr 进程ID</code>，查询 <code>DS</code>/<code>Client</code> 进程，通过 <code>UDP</code> 进行链接。</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202404141745888.png" alt="image-20240414173745071" style="zoom:67%;" /><p><code>DS</code> 的 <code>port</code> 一般可以在启动命令中找到 <code>-port=17777</code>；</p><p><code>Client</code> 的 <code>port</code> 可以在 <code>DS</code> 的 <code>Log</code> 中，快速查询到对应与指定 <code>Client</code> 连接的对应端口号：</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202404141745297.png" alt="image-20240414173856028" style="zoom: 50%;" /><blockquote><p>// DS.log</p><p>LogNet: NotifyAcceptedConnection: Name: TestMap, TimeStamp: 04/14/24 00:00:00, [UNetConnection] <strong>RemoteAddr</strong>: 127.0.0.1:<strong>58459</strong>, Name: IpConnection_0, Driver: GameNetDriver NetDriver_1, IsServer: YES, PC: NULL, Owner: NULL, UniqueId: INVALID</p><p>LogNet: AddClientConnection: Added client connection: [UNetConnection] RemoteAddr: 127.0.0.1:58459, Name: IpConnection_0, Driver: GameNetDriver NetDriver_1, IsServer: YES, PC: NULL, Owner: NULL, UniqueId: INVALID</p></blockquote><pre><code>这里的 **58459** 也就是该 `Client` 的 `Connetcion` 对应的端口号。在 `Filtering` 中填入对应的设置即可：1. 关闭上行包：`udp and udp.SrcPort == 58459` ，设置 `Drop = 100%`2. 关闭下行包：`udp and udp.DstPort == 58459`，设置 `Drop = 100%`</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;弱网工具Clumsy的使用&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;Clumsy&lt;/strong&gt; 用于弱网测试时，进行本地弱网环境的模拟，基于 &lt;a href=&quot;https://github.com/basil00/Divert&quot;&gt;WinDivert&lt;/a&gt; 实现，可以出模拟延</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="网络" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="UE" scheme="https://www.bearchild.top/tags/UE/"/>
    
    <category term="网络" scheme="https://www.bearchild.top/tags/%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>[UE]夺旗模式框架</title>
    <link href="https://www.bearchild.top/2024/03/20/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]%E5%A4%BA%E6%97%97%E6%A8%A1%E5%BC%8F%E6%A1%86%E6%9E%B6/"/>
    <id>https://www.bearchild.top/2024/03/20/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]%E5%A4%BA%E6%97%97%E6%A8%A1%E5%BC%8F%E6%A1%86%E6%9E%B6/</id>
    <published>2024-03-19T16:00:00.000Z</published>
    <updated>2024-04-26T16:01:10.217Z</updated>
    
    <content type="html"><![CDATA[<h1>夺旗模式框架</h1><h2 id="描述">描述</h2><p><strong>夺旗模式：</strong></p><p>场景里会按照一定的规则刷新出不同类型的旗帜（不同类型的旗帜有不同的得分、血量、表现等）；</p><p>玩家会被分成若干个队伍，抢夺刷新出来的旗帜，将旗帜带到自己队伍目标点进行销毁，则可以获得分数；</p><p>玩家持有旗帜时，旗帜可能会掉落或被抢夺：被其它玩家撞击到则旗帜被抢夺到其它玩家身上；旗帜的血量归零则会掉落回场景；</p><p>有正式赛与加时赛两种类型的比赛，首先会开启正式赛；对于正式赛，率先达到目标分的队伍获胜；如果平局则开启加时赛，否则进行结算；对于加时赛，率先得分的队伍获胜，如果平局则以两队平局进行结算；</p><p><strong>要点总结：</strong></p><blockquote><ol><li>旗帜实体：旗帜本身有自己的类型、得分、血量；</li><li>旗帜刷新：场景内根据一定规则（倒计时刷新、旗子上缴）会刷出不同类型旗帜；</li><li>旗帜传递：玩家可以拾取场景里的旗帜、相互抢夺旗帜、掉落旗帜（持有旗帜血量归零）、将旗帜送给终点得分等；玩家可以组队，共享队伍得分；同队伍之间的玩家可以传递旗帜；</li><li>单局流程：所有玩家就绪分队后，传送到起始点准备开赛；如果一局比赛平分，一定条件下可以触发下一场比赛继续；</li></ol></blockquote><h2 id="模式基础">模式基础</h2><h3 id="单局流程">单局流程</h3><p>首先，一个完整的夺旗赛，由若干个子比赛构成，子比赛逐渐推进；</p><pre class="mermaid">flowchart LRM[MainProcess]R0[RaceProcess_0]R1[RaceProcess_1]R2[RaceProcess_2]M-->R0M-->R1M-->R2R0-.->R1R1-.->R2</pre><p>比赛胜负规则：</p><blockquote><p>单场比赛结束时，判定是否有一方队伍得分更高：</p><p>如果有，则全局结束；</p><p>如果没有，尝试进入下一场比赛（如果有配置的话），若没有下一场则全局结束；</p><ol><li>正式赛：比赛结束条件：有一队达到目标分 / 倒计时结束</li><li>加时赛：比赛结束条件：有一队得到分数 / 倒计时结束</li><li>其它类型比赛……</li></ol></blockquote><h3 id="局内玩法">局内玩法</h3><p>从业务出发，先明确有哪些相关逻辑：</p><p>最基本的交互显然是：</p><pre class="mermaid">flowchart LRF0[场景旗帜_0]F1[场景旗帜_1]G0([目标点_0])G1([目标点_1])P0[[Player_0]]P1[[Player_1]]F0--PickUp--->P0--Drop-->F0P0--Reach--->G0P0<--Strike--->P1</pre><blockquote><p><code>PickUp</code>：<code>Player</code> 触碰到 <code>场景旗帜</code> ，就可以拾取该旗帜到自己身上；</p><p><code>Drop</code> ：<code>Player</code> 持有的旗帜存在血量，其血量归零（可能是被其它 <code>Player</code> 攻击导致扣血），就会触发旗帜的掉落，在对应位置生成场景旗帜；</p><p><code>Reach</code>：<code>Player</code> 将持有的旗帜护送到 <code>目标点</code>，获得分数，同时该旗帜会被销毁；</p><p><code>Strike</code>：<code>Player</code> 撞击另一个 <code>Player</code>，可以抢夺对方的旗帜；</p></blockquote><h3 id="业务拆分">业务拆分</h3><p>首先，先给出基本的一些元素定义；</p><blockquote><p>游戏玩法的本质是由刷新点刷新出旗帜，旗帜在各个部分之间交互传递，旗帜本身定义为 <code>FlagItem</code>。</p><p>旗帜在场景（不在 <code>Player</code> 身上）里的表现为，存在对应的 <code>FlagSceneItem</code>。</p><p>场景里存在若干个终点，定义该终点为 <code>GoalPointSceneItem</code></p></blockquote><p>这里说的 <strong>交互</strong> 的本质实际上是一个 <code>Flag</code> 的 <code>Instance</code> 在 <em><strong>各个部分</strong></em> 之间的 <strong>传递</strong> 。想一下所谓的 <em>各个部分</em>，到底是什么？</p><p>本质可以抽象为一个个持有 <code>Flag</code> 的容器，将其定义为 <code>FlagContainer</code>。</p><p>这里显然有三种 <code>Container</code>：</p><blockquote><p><code>Container_WorldFlag</code>：定义 <code>WorldFlag</code> 为 <strong>没有被 <code>Player</code> 持有的旗帜</strong></p><p><code>Container_GoalPoint</code>：定义 <code>GoalPoint</code> 为目标点</p><p><code>Container_Player</code>：每个 <code>Player</code> 持有一个 <code>Container</code>；</p></blockquote><p>细想一下， <code>WorldFlag</code> 、<code>GoalPoint</code> 的具体业务逻辑和具体的某个 <code>Instance</code> 没有太大关系，只需要通过 <code>ID</code> 串联即可，所以对于 <code>WorldFlag</code>、<code>GoalPoint</code>，不需要真的在每一个 <code>Instance</code> 都创建对应 <code>Container</code>，只需要一个单局管理的唯一 <code>Manager</code> 用来代替管理即可。但显然对于每个 <code>Player</code> 都需要有自己的 <code>Container</code>。</p><p>可以在单局内创建全局唯一的  <code>Container_WorldFlag</code> 、<code>Container_GoalPoint</code> 实例。</p><pre class="mermaid">flowchart TDF0[FlagSceneItem_0]F1[FlagSceneItem_1]F2[FlagSceneItem_2]subgraph WorldFlag[Container_WorldFlag]    direction LR    F0-.-F1-.-F2endG0([GoalPoint_0])G1([GoalPoint_1])G2([GoalPoint_2])subgraph GoalPoint[Container_GoalPoint]    direction LR    G0-.-G1-.-G2endP0[[Container_Player_0]]P1[[Container_Player_1]]WorldFlag--PickUp--->P0--Drop--->WorldFlagP0--Reach--->GoalPointP0<--Strike--->P1</pre><p>这样就可以将 <strong>交互</strong> 的逻辑拆得非常简单了：</p><blockquote><p><code>PickUp</code> ：由 <code>FlagSceneItem</code> 和 <code>Player</code> 的 <code>Overlap</code> 触发，将 <code>Container_WorldFlag</code> 持有的对应该 <code>FlagSceneItem</code> 的 <code>FlagItem</code> ，传递给这个 <code>Player</code> 的 <code>Conatiner_Player</code></p><p><code>Drop</code> ： 由 <code>Player</code> 的血量变化归零触发，将 <code>Container_Player</code> 上的所有 <code>FlagItem</code> 转移给 <code>Cotainer_WorldFlag</code></p><p><code>Reach</code>：由 <code>Player</code> 和 <code>GoalPointSceneItem</code> 的 <code>Overlap</code> 触发，将 <code>Container_Player</code> 上的所有 <code>FlagItem</code> 转移给 <code>Cotainer_GoalPonit</code></p><p><code>Strike</code>：由 <code>Player0</code> 和 <code>Player1</code> 的撞击触发，将 <code>Container_Player</code> 上的所有 <code>FlagItem</code> 转移给 <code>Cotainer_Player1</code></p></blockquote><p>这里的 <code>PickUp</code>、<code>Drop</code>、<code>Reach</code>、<code>Strike</code> 是这张图的 <strong>边</strong>，将其定义为 <code>TransferPolicy</code>。</p><p>对于 <code>Container</code>，有各自的 <code>Add(FlagItem)</code>、<code>Remove(FlagItem)</code>，一些基本逻辑：</p><blockquote><p><code>Container_WorldFlag</code>：</p><ol><li><p><code>AddItem</code> ：从 <code>FlagItem</code> 上取出位置，将 <code>Item</code> 血量设置为满血，通过调用 <code>FlagSceneItemManager</code> 创建出 <code>FlagItem</code> 对应的 <code>FlagSceneItem</code>；</p></li><li><p><code>RemoveItem</code>：调用 <code>FlagSceneItemManager</code> 删除对应的  <code>FlagItem</code>  对应的 <code>FlagSceneItem</code>；</p></li></ol></blockquote><blockquote><p><code>Container_GoalPoint</code>：</p><ol><li><p><code>AddItem</code>：判断是从哪个 <code>Container</code> 来的，给对应 <code>Player</code> 加分，并且 <code>RemoveItem</code>；</p></li><li><p><code>RemoveItem</code> ：销毁对应的 <code>FlagItem</code>；</p></li></ol></blockquote><blockquote><p><code>Container_Player</code>：</p><ol><li><p><code>AddItem</code>：从 <code>FlagItem</code> 获得 <code>FlagSyncData</code> 同步给自己，并设置 <code>Player</code> 血量为 <code>Item</code> 的血量等逻辑；</p></li><li><p><code>RemoveItem</code>：将 <code>Player</code> 血量设置给 <code>Item</code> 血量，清空同步信息等逻辑；</p></li></ol></blockquote><p>完整的业务拆分完毕，这下需要哪些系统显而易见：</p><blockquote><p><code>ProcessSystem</code>：负责管理单局流程，创建比赛与推动玩法进程；</p><p><code>TeamSystem</code> ：负责 <code>Player</code> 的组队，管理 <code>Memebr</code>、<code>Score</code> 等；</p><p><code>FlagItemSystem</code>：负责管理所有 <code>FlagItem</code> 实例，提供 <code>Create</code>、<code>Destroy</code> 等方法，维护 <code>Item</code> 基本的生命周期；</p><p><code>ContainerSystem</code>：负责提供基本的 <code>CreateContainer</code>、<code>DestoryContainer</code> 方法，对于具体的 <code>Container</code>，需要支持 <code>AddItem</code> 、<code>RemoveItem</code>、<code>GetItem</code> 等；</p><p><code>TransferSystem</code>：负责管理所有的 <code>TransferPolicy</code> ，提供 <code>TransferItem</code> 方法；</p><p><code>FlagSpawnerSystem</code>：旗帜的刷新点，负责 <code>WorldFlag</code> 的生成，生成 <code>FlagItem</code> 并 <code>Add</code> 到 <code>Container_WorldFlag</code>；</p><p><code>SceneItemSystem</code> ：维护场景里 <code>SceneItem</code> 的生成，提供 <code>Create</code>、<code>Destroy</code> 对应的 <code>SceneItem</code> 的方法；对于某个具体的 <code>SceneItem</code>，需要实现基础的 <code>Overlap</code>、<code>Sync</code>；</p></blockquote><h2 id="具体实现">具体实现</h2><h3 id="ProcesSystem"><code>ProcesSystem</code></h3><p>首先需要一个挂在 <code>GameState</code> 上的  <code>MainProcess</code> 负责管理全局的流程，串联多个 <code>RaceProcess</code> 推进玩法；</p><p>显然，一个最简单的流程可以这样：</p><pre class="mermaid">flowchart LRM[MainProcess]R0[RaceProcess_0]R1[RaceProcess_1]F[Finish]M---->|1. 开赛|R0R0-.->|2. Result_0|MM-->|3. Check_Result_0|R1R1-.->|4. Result_1|MM-->|5. Check_Result_1|FR0-.->R1R1-.->F</pre><p>但是这样循环流程需要在 <code>Main</code> 里面关注 <code>RaceProcess</code> 给出的 <code>Result</code> 事件，显然有点不够优雅。</p><p>发现这里的主要由两部分组成：</p><blockquote><ol><li><code>RaceProcess</code> 管理子比赛流程，给出 <code>Result</code></li><li><code>MainProcess</code> 接受子比赛 <code>Result</code>，校验并判断开启下一场 <code>Race</code> 或者结束比赛</li></ol></blockquote><p>所以可以将其拆成两个 <code>Controller</code>：</p><p><code>MainProcess</code> 负责提供 <code>Dispatch</code> 的功能，</p><blockquote><ol><li><code>FinishRace_Controller</code>：监听 <code>Dispatcher</code> 的 <code>开赛</code> 事件，并向 <code>Dispatcher</code> 分发 <code>单局结束</code>事件；</li><li><code>CreateRace_Controller</code>：监听 <code>单局结束</code> 事件，进行处理并向 <code>Dispatcher</code> 分发<code>开赛</code> 事件；</li></ol></blockquote><pre class="mermaid">flowchart TBM[MainProcess]D[Dispatcher]F[FinishRace_Controller]C[CreateRace_Controller]M-->DF-->|Send_Finsih|DD-.->|Register_Create|FC-->|Send_Create|DD-.->|Register_Finish|C</pre><h3 id="TeamSystem"><code>TeamSystem</code></h3><p>参考 <a href="https://www.bearchild.top/2024/03/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/%5BUE%5DTeamSystem%E6%A1%86%E6%9E%B6/">[UE] TeamSystem 框架</a></p><p>支持玩家的 <code>加入</code>、<code>退出</code> 队伍，以及维护队伍的各种数据（比如 <code>Members</code>、<code>Score</code>），并维护数据，进行同步。</p><h3 id="SceneItemSystem"><code>SceneItemSystem</code></h3><pre class="mermaid">classDiagram    UCFSceneItemUtils..>UCFSceneItemManager    class UCFSceneItemUtils {        }        UCFSceneItemManager..>UCFScecneItemBase    class UCFSceneItemManager {    frien UCFSceneItemUtils    - CreateItem(Type, UID, Params)    - DestroyItem(UID)    }        UCFScecneItemBase..>UCFScecneItemSyncComponent    UCFScecneItemBase..>UCFScecneItemDisplayComponent    class UCFScecneItemBase {    SyncComponent : UCFScecneItemSyncComponent    OverlapDelegate    # OnInit()    # OnUninit()    # BeginDetect()    # EndDetect()    + CollectSyncData()    }        UCFScecneItem_WorldFlag--|>UCFScecneItemBase    UCFScecneItem_GoalPoint--|>UCFScecneItemBase</pre><pre class="mermaid">classDiagram    UCFSceneItemUtils..>UCFSceneItemManager    class UCFSceneItemUtils {        }        UCFSceneItemManager..>UCFScecneItemBase    class UCFSceneItemManager {    frien UCFSceneItemUtils    - CreateItem(Type, UID, Params)    - DestroyItem(UID)    }        UCFScecneItemBase..>UCFScecneItemSyncComponent    UCFScecneItemBase..>UCFScecneItemDisplayComponent    class UCFScecneItemBase {    SyncComponent : UCFScecneItemSyncComponent    OverlapDelegate    # OnInit()    # OnUninit()    # BeginDetect()    # EndDetect()    + CollectSyncData()    }</pre><pre class="mermaid">classDiagram    UCFSceneItemUtils..>UCFSceneItemManager    class UCFSceneItemUtils {        }        UCFSceneItemManager..>UCFScecneItemBase    class UCFSceneItemManager {    - CreateItem(Type, UID, Params)    - DestroyItem(UID)    }        UCFScecneItemBase..>UCFScecneItemSyncComponent    UCFScecneItemBase..>UCFScecneItemDisplayComponent    class UCFScecneItemBase {    SyncComponent : UCFScecneItemSyncComponent    OverlapDelegate    # OnInit()    # OnUninit()    # BeginDetect()    # EndDetect()    + CollectSyncData()    }</pre><p>首先，需要 <code>UCFSceneItemManager</code> 负责管理所有的 <code>SceneItem</code>，同时通过 <code>UCFSceneItemUtils</code> 提供方法给外部调用。</p><p>对于一个具体的 <code>SceneItem</code>，额外对其提供两个 <code>Component</code>，</p><blockquote><ol><li><code>SyncComponent</code>：在 <code>DS/Client</code> 生成，维护 <code>SceneItem</code> 的同步数据，这一部分数据不会被 <code>AOI</code> 裁剪，保证远距离的数据同步；</li><li><code>DisplayComponent</code>：仅在 <code>Client</code> 生成，随着 <code>SceneItem</code> 被 <code>AOI</code>，用于实现客户端表现。</li></ol></blockquote><h3 id="FlagItemSystem、ContainerSystem"><code>FlagItemSystem</code>、<code>ContainerSystem</code></h3><pre class="mermaid">classDiagramdirection LRUCaptureFlagItemSystem..>FCaptureFlagItem    class UCaptureFlagItemSystem {    ItemInstances : TMap~uint64|TSharedPtr~FCaptureFlagItem~~    + CreateItem(ItemID)    + DestroyItem(ItemUID)    + GetItem(ItemUID)    - GenerateUID()    - RegisterClearTimer()    - UnregisterClearTimer()    - ClearAllItems(bCheckUnused)    }        %% ----- FlagItem -----        namespace FlagItem {        class FCaptureFlagItem        class FCaptureFlagItemSyncData    }        FCaptureFlagItem..FCaptureFlagItemSyncData    FCaptureFlagItem..UCaptureFlagContainerBase    class FCaptureFlagItem {    + InitItem(InUID, ItemID)    + GetSyncData() : FCaptureFlagItemSyncData    + UID / ItemID / Type / Health / MaxHealth...    + Container : TWeakObjectPtr~UCaptureFlagContainerBase~    + TransferReason : ECFTransferReason    }        class FCaptureFlagItemSyncData {    + UID / ItemID / Type / Health / MaxHealth / TransferReason    }        %% ----- FlagContainer -----        namespace FlagContainer {    class UCaptureFlagContainerBase    class UCaptureFlagContainer_WorldFlag    class UCaptureFlagContainer_GoalPoint    class UCaptureFlagContainer_Player    }        class UCaptureFlagContainerBase {    Items : TMap ~uint64|TWeakPtr~FCaptureFlagItem~~    Owner : TWeakObjectPtr~UObject~    + Init(InOwner)    + Uninit()    + AddItem(TWeakPtr~FCaptureFlagItem~Item, Params)    + RemoveItem(TWeakPtr~FCaptureFlagItem~ Item)    + VerifyCanAddItem()    + GetType() : ECFContainerType    # OnInit()    # OnUninit()    # OnAddItem(TWeakPtr~FCaptureFlagItem~Item, Params)    # OnRemoveItem(TWeakPtr~FCaptureFlagItem~ Item)    }        UCaptureFlagContainer_WorldFlag--|>UCaptureFlagContainerBase    UCaptureFlagContainer_GoalPoint--|>UCaptureFlagContainerBase        UCaptureFlagContainer_Player--|>UCaptureFlagContainerBase    class UCaptureFlagContainer_Player{    # GetType() : ECFContainerType        }        %% ----- ContainerOwner -----        namespace ContainerOwner {    class UCaptureFlagManager    class UCaptureFlagComponent    class ICaptureFlagContainerOwnerInterface    }            UCaptureFlagManager..>UCaptureFlagContainer_GoalPoint    UCaptureFlagManager..>UCaptureFlagContainer_WorldFlag    UCaptureFlagManager..|>ICaptureFlagContainerOwnerInterface    class UCaptureFlagManager{    - WorldFlagContainer    - GoalPointContainer    + GetWorldFlagContainer()    + GetGoalPointContainer()    }        UCaptureFlagComponent..|>ICaptureFlagContainerOwnerInterface    UCaptureFlagComponent..>UCaptureFlagContainer_Player    UCaptureFlagComponent..>FCaptureFlagItemSyncData    class UCaptureFlagComponent{    - FlagContainer_Player    - FlagItemSyncData : FCaptureFlagItemSyncData    + GetCaptureFlagContainer()    + UpdateFlagItemSyncData(SyncData)    }        ICaptureFlagContainerOwnerInterface..>UCaptureFlagContainerBase    class ICaptureFlagContainerOwnerInterface{    CreateFlagContainer(InOwner)    DestroyFlagContainer(Container)    }</pre><p>首先，需要一个 <code>FlagItemSystem</code> 负责管理所有的 <code>FlagItem</code> 实例。提供基本的创建、销毁、查询功能的同时，这个 <code>FlagItemSystem</code>需要 <code>RegisterClearTimer</code>，每隔一段时间，<code>Clear</code> 不被任何一个 <code>Container</code> 持有的 <code>Item</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UCaptureFlagItemManager</span></span><br><span class="line"></span><br><span class="line"><span class="function">TWeakPtr&lt;FCaptureFlagItem&gt; <span class="title">UCaptureFlagItemManager::CreateItem</span><span class="params">(<span class="keyword">int</span> ItemID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">auto</span> NewItem = MakeShared&lt;FCaptureFlagItem&gt;();</span><br><span class="line">NewItem-&gt;<span class="built_in">Init</span>( <span class="built_in">GenerateUID</span>(),  ItemID );</span><br><span class="line">ItemInstances.<span class="built_in">Add</span>( NewItem-&gt;<span class="built_in">GetUID</span>(), NewItem );</span><br><span class="line"></span><br><span class="line"><span class="built_in">NotifyItemCreated</span>(NewItem);</span><br><span class="line"><span class="keyword">return</span> NewItem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UCaptureFlagItemManager::DestoryItem</span><span class="params">(uint64 ItemUID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!ItemInstances.<span class="built_in">Contains</span>(ItemUID)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> Item = ItemInstances.<span class="built_in">FindRef</span>(ItemUID);</span><br><span class="line"><span class="keyword">if</span> (Item.<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (Item-&gt;<span class="built_in">GetContainer</span>().<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 先从 Container 上移除</span></span><br><span class="line">Item-&gt;<span class="built_in">GetContainer</span>()-&gt;<span class="built_in">RemoveItem</span>(Item);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">ItemInstances.<span class="built_in">Remove</span>(ItemUID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UCaptureFlagItemManager::ClearAllItems</span><span class="params">(<span class="keyword">bool</span> bUnused)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">TArray &lt;uint64&gt; ItemUIDs;</span><br><span class="line">ItemInstances.<span class="built_in">GetKeys</span>(ItemUIDs);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> ItemUID : ItemUIDs)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">auto</span> Item = ItemInstances.<span class="built_in">FindRef</span>(ItemUID);</span><br><span class="line"><span class="keyword">if</span> (!Item.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( bUnused == <span class="literal">false</span></span><br><span class="line">|| <span class="comment">/*未被任何 Container 持有*/</span> Item-&gt;<span class="built_in">GetContainer</span>().<span class="built_in">IsValid</span>() == <span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">DestoryItem</span>(ItemUID);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于 <code>FlagItem</code>，保存 <code>Flag</code> 最基本的信息，同时提供一个 <code>CollectSyncData</code>，用于生成对应的 <code>FlagSyncData</code>，表示需要同步的数据，在 <code>ContainerOwner</code> 需要的时候进行数据同步。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlagItem.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATE_CAPTUREFLAG_ITEM_PROPERTY(Visibility, Type, Name) \</span></span><br><span class="line"><span class="meta">public: Type Get##Name() const &#123; return Name; &#125; \</span></span><br><span class="line"><span class="meta">public: void Set##Name(const Type&amp; Value) &#123; Name = Value; &#125; \</span></span><br><span class="line"><span class="meta">Visibility: Type Name</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要在 FCaptureFlagItem::GetSyncData 中打包数据</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">USTRUCT</span>()</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FCaptureFlagItemSyncData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">FCaptureFlagItemSyncData</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function">FString <span class="title">ToString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> FCaptureFlagItemSyncData&amp; Other) <span class="keyword">const</span>;</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span>!=(<span class="keyword">const</span> FCaptureFlagItemSyncData&amp; Other) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> !(*<span class="keyword">this</span> == Other);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">uint64 UID = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line"><span class="keyword">int</span> ItemID = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line"><span class="keyword">int</span> Type = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line"><span class="keyword">float</span> Health = <span class="number">0.0f</span>;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line"><span class="keyword">float</span> MaxHealth = <span class="number">0.0f</span>;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">ECFTransferReason TransferReason;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FCaptureFlagItem</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">virtual</span> ~<span class="built_in">FCaptureFlagItem</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init</span><span class="params">(uint64 InUID, <span class="keyword">int</span> ItemID)</span></span>;</span><br><span class="line"><span class="function">FCaptureFlagItemSyncData <span class="title">GetSyncData</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function">FString <span class="title">ToString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">GENERATE_CAPTUREFLAG_ITEM_PROPERTY</span>(<span class="keyword">private</span>, uint64, UID);</span><br><span class="line"></span><br><span class="line"><span class="built_in">GENERATE_CAPTUREFLAG_ITEM_PROPERTY</span>(<span class="keyword">private</span>, <span class="keyword">int</span>, ItemID);</span><br><span class="line"><span class="built_in">GENERATE_CAPTUREFLAG_ITEM_PROPERTY</span>(<span class="keyword">private</span>, <span class="keyword">int</span>, Type);</span><br><span class="line"><span class="built_in">GENERATE_CAPTUREFLAG_ITEM_PROPERTY</span>(<span class="keyword">private</span>, <span class="keyword">float</span>, Health);</span><br><span class="line"><span class="built_in">GENERATE_CAPTUREFLAG_ITEM_PROPERTY</span>(<span class="keyword">private</span>, <span class="keyword">float</span>, MaxHealth);</span><br><span class="line"><span class="built_in">GENERATE_CAPTUREFLAG_ITEM_PROPERTY</span>(<span class="keyword">private</span>, <span class="keyword">int</span>, Score);</span><br><span class="line"></span><br><span class="line"><span class="built_in">GENERATE_CAPTUREFLAG_ITEM_PROPERTY</span>(<span class="keyword">private</span>, ECFTransferReason, TransferReason);</span><br><span class="line"><span class="built_in">GENERATE_CAPTUREFLAG_ITEM_PROPERTY</span>(<span class="keyword">private</span>, TWeakObjectPtr&lt;class UCaptureFlagContainerBase&gt;, Container);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>需要 <code>Container</code> 来持有 <code>FlagItem</code>，在 <code>AddItem</code> 和 <code>RemoveItem</code> 内写具体的逻辑。</p><p>每种 <code>Container</code> 通过重载 <code>UCaptureFlagContainerBase</code> 的 <code>PURE_VIRTUAL</code> 方法  <code>GetType</code>  来定义其类型。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ContainerBase.h</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>(Abstract)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UCaptureFlagContainerBase</span> :</span> <span class="keyword">public</span> UObject</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">UCaptureFlagItemUtils</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> ECFContainerType <span class="title">GetType</span><span class="params">()</span> <span class="title">PURE_VIRTUAL</span><span class="params">( UCaptureFlagContainerBase::GetType, <span class="keyword">return</span> ECFContainerType::None; )</span> <span class="comment">// 设置 ContainerType</span></span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">VerifyCanAddItem</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CollectParams</span><span class="params">(FCaptureFlagParams&amp; Params)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CheckCapcityValid</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init</span><span class="params">(UObject* InOwner)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Uninit</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">AddItem</span><span class="params">(TWeakPtr&lt;FCaptureFlagItem&gt; Item, <span class="keyword">const</span> FCaptureFlagParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">RemoveItem</span><span class="params">(TWeakPtr&lt;FCaptureFlagItem&gt; Item)</span></span>;</span><br><span class="line">TArray &lt;TWeakPtr&lt;FCaptureFlagItem&gt;&gt; <span class="built_in">GetAllItems</span>();</span><br><span class="line"><span class="function">TWeakPtr&lt;FCaptureFlagItem&gt; <span class="title">GetItem</span><span class="params">(uint64 ItemUID)</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ClearItems</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"><span class="comment">// 各个 Container 自定义逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnInit</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnUninit</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnAddItem</span><span class="params">(TWeakPtr&lt;FCaptureFlagItem&gt; Item, <span class="keyword">const</span> FCaptureFlagParams&amp; Params)</span> </span>&#123;&#125;;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnRemoveItem</span><span class="params">(TWeakPtr&lt;FCaptureFlagItem&gt; Item)</span> </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">TMap &lt;uint64, TWeakPtr&lt;FCaptureFlagItem&gt;&gt; Items &#123;&#125;;</span><br><span class="line">TWeakObjectPtr &lt;UObject&gt; Owner = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ContainerBase.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UCaptureFlagContainerBase::AddItem</span><span class="params">(TWeakPtr&lt;FCaptureFlagItem&gt; Item, <span class="keyword">const</span> FCaptureFlagParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!Owner.<span class="built_in">IsValid</span>() || !Item.<span class="built_in">IsValid</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">uint64 ItemUID = Item.<span class="built_in">Pin</span>()-&gt;<span class="built_in">GetUID</span>();</span><br><span class="line"><span class="keyword">if</span> (Item.<span class="built_in">Pin</span>()-&gt;<span class="built_in">GetContainer</span>().<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Item 只能被放在一个 Container 内</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否可以获得</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">VerifyCanAddItem</span>() == <span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Item.<span class="built_in">Pin</span>()-&gt;<span class="built_in">SetContainer</span>( <span class="keyword">this</span> );</span><br><span class="line">Items.<span class="built_in">Add</span>( ItemUID, Item );</span><br><span class="line"></span><br><span class="line"><span class="built_in">OnAddItem</span>(Item, Params);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UCaptureFlagContainerBase::RemoveItem</span><span class="params">(TWeakPtr&lt;FCaptureFlagItem&gt; Item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!Owner.<span class="built_in">IsValid</span>() || !Item.<span class="built_in">IsValid</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">uint64 ItemUID = Item.<span class="built_in">Pin</span>()-&gt;<span class="built_in">GetUID</span>();</span><br><span class="line"><span class="keyword">if</span> (!Items.<span class="built_in">Contains</span>(ItemUID))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Item.<span class="built_in">Pin</span>()-&gt;<span class="built_in">SetContainer</span>(<span class="literal">nullptr</span>);</span><br><span class="line">Items.<span class="built_in">Remove</span>(ItemUID);</span><br><span class="line"><span class="built_in">OnRemoveItem</span>(Item);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每个 <code>Container</code> 需要一个 <code>ContainerOwner</code> 来持有，这里有三种 <code>Container</code>。</p><blockquote><ol><li><code>Container_WorldFlag</code>： 由 <code>CaptureFlagManager(GS)</code> 持有，一场子比赛持有一个；</li><li><code>Container_GoalPoint</code>：由 <code>CaptureFlagManager(GS)</code> 持有，一场子比赛持有一个；</li><li><code>Container_Player</code>：由 <code>CaptureFlagComponent(PS)</code> 持有，每个 <code>Player</code> 持有一个；</li></ol></blockquote><p>提供一个 <code>ICaptureFlagContainerOwnerInterface</code> 用于支持 <code>Create</code>、<code>Destroy</code> 对应的 <code>Container</code> 方法；</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ContainerOwner.h</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UINTERFACE</span>(BlueprintType, Blueprintable)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UCaptureFlagContainerOwnerInterface</span> :</span> <span class="keyword">public</span> UInterface</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ICaptureFlagContainerOwnerInterface</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">typename</span> TEnableIf&lt;TIsDerivedFrom&lt;T, UCaptureFlagContainerBase&gt;::Value, T*&gt;::<span class="function">Type</span></span><br><span class="line"><span class="function"><span class="title">CreateFlagContainer</span><span class="params">(UObject* InOwner)</span> <span class="comment">// 传入 this</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">IsValid</span>(InOwner)) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">T* Container = NewObject&lt;T&gt;(InOwner);</span><br><span class="line">Container-&gt;<span class="built_in">Init</span>(InOwner);</span><br><span class="line"><span class="keyword">return</span> Container;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DestroyFlagContainer</span><span class="params">(UCaptureFlagContainerBase* Container)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Container)) <span class="keyword">return</span>;</span><br><span class="line">Container-&gt;<span class="built_in">Uninit</span>();</span><br><span class="line">Container = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="TransferSystem"><code>TransferSystem</code></h3><pre class="mermaid">classDiagram    direction LR        UCFTransferSystem..>UCFTransferPolicyBase    UCFTransferSystem..UCaptureFlagContainerBase    class UCFTransferSystem {        Policies : FGameSubSystemCollection~UCFTransferPolicyBase~        friend UCFTransferPolicyBase        - TransferItem(Item, TargetContainer, TransferReason)    }            UCFTransferPolicyBase..UCaptureFlagContainerBase    class UCFTransferPolicyBase{    # OnInit()    # OnUninit()    # TransferItem(Item, TargetContainer)    # GetTransferReason() : ECFTransferReason    }        UCFTansferPolicy_PickUp--|>UCFTransferPolicyBase    UCFTansferPolicy_Drop--|>UCFTransferPolicyBase    UCFTansferPolicy_Reach--|>UCFTransferPolicyBase    UCFTansferPolicy_Strike--|>UCFTransferPolicyBase</pre><p>首先需要一个 <code>UCFTransferSystem</code> 持有 <code>Polices</code>，管理并维护所有 <code>TransferPolicy</code> 的生命周期，具体可以参考 <a href="https://www.bearchild.top/2024/03/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/%5BUE%5DGameSubSystem%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/">[UE] GameSubSystem 简单实现</a>。</p><p>对于一个具体的 <code>TransferPolicy</code>，通过重载 <code>TransferPolicyBase</code> 的 <code>PURE_VIRTUAL</code> 方法  <code>GetTransferReason</code> ，明确其对应的 <code>TransferReason</code>，在其 <code>OnInit</code>、<code>OnUninit</code>，监听该类型需要的事件，通过对应的 <code>Callback</code> 调用到 <code>Base</code> 提供的 <code>TransferItem</code> 方法，执行 <code>Item</code> 的转移。</p><p>对于一次成功的 <code>Transfer</code>，显然会调用到 <code>SourceContainer</code> 的 <code>Remove</code> ，以及 <code>TargetContainer</code> 的 <code>Add</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TransferManager</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UCaptureFlagTransferManager::TransferItem</span><span class="params">(TWeakPtr&lt;FCaptureFlagItem&gt; Item, UCaptureFlagContainerBase* TargetContainer, ECFTransferReason TransferReason)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!Item.<span class="built_in">IsValid</span>() || !<span class="built_in">IsValid</span>(TargetContainer)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> SharedItem = Item.<span class="built_in">Pin</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否可以获得</span></span><br><span class="line"><span class="keyword">if</span> (TargetContainer-&gt;<span class="built_in">VerifyCanAddItem</span>() == <span class="literal">false</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// Source 可以为空</span></span><br><span class="line"><span class="keyword">auto</span> SourceContainer = SharedItem-&gt;<span class="built_in">GetContainer</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (SourceContainer == TargetContainer) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">ECFTransferReason LastTransferReason = Item.<span class="built_in">Pin</span>()-&gt;<span class="built_in">GetTransferReason</span>();</span><br><span class="line">Item.<span class="built_in">Pin</span>()-&gt;<span class="built_in">SetTransferReason</span>(TransferReason);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 若有 Source，则尝试移除</span></span><br><span class="line"><span class="keyword">if</span> (SourceContainer.<span class="built_in">IsValid</span>() &amp;&amp; SourceContainer-&gt;<span class="built_in">RemoveItem</span>(Item) == <span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">Item.<span class="built_in">Pin</span>()-&gt;<span class="built_in">SetTransferReason</span>(LastTransferReason);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FCaptureFlagParams Params&#123;&#125;;</span><br><span class="line"><span class="keyword">if</span> (SourceContainer.<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line">SourceContainer-&gt;<span class="built_in">CollectParams</span>(Params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 尝试添加</span></span><br><span class="line"><span class="keyword">if</span> (TargetContainer-&gt;<span class="built_in">AddItem</span>(Item, Params) == <span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">Item.<span class="built_in">Pin</span>()-&gt;<span class="built_in">SetTransferReason</span>(LastTransferReason);</span><br><span class="line"><span class="comment">// 失败则还给 Source</span></span><br><span class="line"><span class="keyword">if</span> (SourceContainer.<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line">SourceContainer-&gt;<span class="built_in">AddItem</span>(Item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TransferPolicyBase.h</span></span><br><span class="line"><span class="built_in">UCLASS</span>(Abstract)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UCFTransferPolicyBase</span> :</span> <span class="keyword">public</span> UGameModeSubSystemBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> ECFTransferReason <span class="title">GetTransferReason</span><span class="params">()</span> <span class="keyword">const</span> <span class="title">PURE_VIRTUAL</span><span class="params">(UCFTransferPolicyBase::GetTransferReason, <span class="keyword">return</span> ECFTransferReason::None;)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnInit</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnUninit</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">TransferItem</span><span class="params">(TWeakPtr&lt;FCaptureFlagItem&gt; Item, UCaptureFlagContainerBase* TargetContainer)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">TWeakObjectPtr &lt;<span class="class"><span class="keyword">class</span> <span class="title">UCaptureFlagTransferManager</span>&gt;</span> System = <span class="literal">nullptr</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TransferPolicy.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UCFTransferPolicyBase::OnInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">System = Cast&lt;UCaptureFlagTransferManager&gt;(<span class="built_in">GetOuter</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UCFTransferPolicyBase::TransferItem</span><span class="params">(TWeakPtr&lt;FCaptureFlagItem&gt; Item, UCaptureFlagContainerBase* TargetContainer)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!System.<span class="built_in">IsValid</span>() || !Item.<span class="built_in">IsValid</span>() || !<span class="built_in">IsValid</span>(TargetContainer)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> bSucceed = <span class="literal">false</span>;</span><br><span class="line">bSucceed = System-&gt;<span class="built_in">TransferItem</span>( Item, TargetContainer, <span class="built_in">GetTransferReason</span>() );</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> bSucceed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;夺旗模式框架&lt;/h1&gt;
&lt;h2 id=&quot;描述&quot;&gt;描述&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;夺旗模式：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;场景里会按照一定的规则刷新出不同类型的旗帜（不同类型的旗帜有不同的得分、血量、表现等）；&lt;/p&gt;
&lt;p&gt;玩家会被分成若干个队伍，抢夺刷新出来的</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="Gameplay" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/"/>
    
    
    <category term="Gameplay" scheme="https://www.bearchild.top/tags/Gameplay/"/>
    
    <category term="UE" scheme="https://www.bearchild.top/tags/UE/"/>
    
  </entry>
  
  <entry>
    <title>[UE]CommonParams解决方案</title>
    <link href="https://www.bearchild.top/2024/03/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]CommonParams%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <id>https://www.bearchild.top/2024/03/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]CommonParams%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</id>
    <published>2024-03-13T16:00:00.000Z</published>
    <updated>2024-03-14T17:15:44.538Z</updated>
    
    <content type="html"><![CDATA[<h1>CommonParams解决方案</h1><p>在实现业务框架的时候，经常需要支持传参的功能（比如 <code>Buff</code> 系统中，<code>AddBuff</code> 的时候，通常需要支持外部传入一个 <code>BuffParams</code> ，在内部解析出各种 <code>Param</code> 使用。）</p><p>这个参数需要支持基本的数据保存、同步等。</p><h2 id="初始的想法">初始的想法</h2><p>一个最简单的想法，是打包一个结构体，支持各种类型的传入，比如：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>()</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Params</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="built_in">UPROPERTY</span>()</span><br><span class="line">    uint64 uVar0;</span><br><span class="line">    <span class="built_in">UPROPERTY</span>()</span><br><span class="line">    <span class="keyword">int</span> iVar0;</span><br><span class="line">    <span class="built_in">UPROPERTY</span>()</span><br><span class="line">    <span class="keyword">float</span> fVar0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样虽然很简单，同时可以通过反射来同步。</p><p>但是有一个巨大的问题，那就是在解析参数的时候，只知道 <code>Var0</code> 这种没有名字的抽象的概念，使用者需要记住 <code>Var0</code> 对应的是什么数据，很不直观。</p><h2 id="CommonVariantParams">CommonVariantParams</h2><p>维护一个 <code>CommonVariantParams</code>，通过 <code>TMap &lt;FString, FVariant&gt; ValueMap</code> 来保存数据，同时自定义 <code>NetSerialize</code> 来支持网络同步。</p><p>为了方便使用，还可以自定义一些构造函数，比如 <code>std::initializer_list&lt;TPairInitializer&lt;const FString&amp;, FVariant&gt;&gt; ValuePairs</code> ，这样就可以支持 <code>&#123; &#123;Key0, Val0&#125;, &#123;Key1, Val1&#125; &#125;</code> 形式的构造。</p><p>由于 <code>TMap</code> 以及 <code>FVariant</code> 实际上在引擎内部都已经有了合适的重载 <code>operator &lt;&lt; Archive</code>，所以自定义 <code>NetSerialize</code> 也很简单。</p><h3 id="使用方法">使用方法</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建Params：</span></span><br><span class="line">FCommonVariantParams Params = &#123; &#123;<span class="string">&quot;ParamA&quot;</span>, (<span class="keyword">float</span>)A&#125;, &#123;<span class="string">&quot;ParamsB&quot;</span>, (<span class="keyword">int</span>)B &#125;, &#123;<span class="string">&quot;ParamsC&quot;</span>, (FString)C &#125; <span class="comment">/* ... */</span> &#125;);</span><br><span class="line"><span class="comment">// 解析Params:</span></span><br><span class="line"><span class="keyword">float</span> A = BuffParams.GetValue&lt;<span class="keyword">float</span>&gt;(<span class="string">&quot;ParamA&quot;</span>);</span><br><span class="line"><span class="keyword">int</span> B = BuffParams.GetValue&lt;<span class="keyword">int</span>&gt;(<span class="string">&quot;ParamB&quot;</span>);</span><br><span class="line">FString C = BuffParams.GetValue&lt;FString&gt;(<span class="string">&quot;ParamC&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="具体实现">具体实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CommonVariantParams.h</span></span><br><span class="line"><span class="built_in">USTRUCT</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FCommonVariantParams</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">FCommonVariantParams</span>() = <span class="keyword">default</span>;</span><br><span class="line"><span class="built_in">FCommonVariantParams</span>(<span class="keyword">const</span> FString&amp; Key, FVariant Value);</span><br><span class="line"><span class="built_in">FCommonVariantParams</span>(std::initializer_list&lt;TPairInitializer&lt;<span class="keyword">const</span> FString&amp;, FVariant&gt;&gt; ValuePairs);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetValue</span><span class="params">(<span class="keyword">const</span> FString&amp; FieldName, FVariant Value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Contains</span><span class="params">(<span class="keyword">const</span> FString&amp; FieldName)</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsEmpty</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType = <span class="keyword">float</span>&gt; ValueType <span class="built_in">GetValue</span>(<span class="keyword">const</span> FString&amp; FieldName, ValueType Default = &#123;&#125;) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!ValueMap.<span class="built_in">Contains</span>(FieldName)) <span class="keyword">return</span> Default;</span><br><span class="line"><span class="keyword">if</span> (TVariantTraits&lt;ValueType&gt;::<span class="built_in">GetType</span>() != ValueMap[FieldName].<span class="built_in">GetType</span>()) <span class="keyword">return</span> Default;</span><br><span class="line"><span class="keyword">return</span> ValueMap[FieldName].GetValue&lt;ValueType&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">ToString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> TMap&lt;FString, FVariant&gt;&amp; <span class="title">GetValueMap</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">NetSerialize</span><span class="params">(FArchive&amp; Ar, class UPackageMap* Map, <span class="keyword">bool</span>&amp; bOutSuccess)</span></span>;</span><br><span class="line"></span><br><span class="line">FCommonVariantParams <span class="keyword">operator</span>+(<span class="keyword">const</span> FCommonVariantParams&amp; OtherParams);</span><br><span class="line">FCommonVariantParams&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> FCommonVariantParams&amp; OtherParams)</span><br><span class="line">&#123;</span><br><span class="line">ValueMap = OtherParams.<span class="built_in">GetValueMap</span>();</span><br><span class="line"><span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Merge</span><span class="params">(<span class="keyword">const</span> FCommonVariantParams&amp; OtherParams)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Clear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">begin</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> ValueMap.<span class="built_in">begin</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">begin</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> ValueMap.<span class="built_in">begin</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">end</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> ValueMap.<span class="built_in">end</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">end</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> ValueMap.<span class="built_in">end</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">TMap&lt;FString, FVariant&gt; ValueMap;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SGGAMEMODE_API</span> <span class="title">TStructOpsTypeTraits</span>&lt;</span>FCommonVariantParams&gt; : TStructOpsTypeTraitsBase2&lt;FCommonVariantParams&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">WithNetSerializer = <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CommonVariantParams.cpp</span></span><br><span class="line">FCommonVariantParams::<span class="built_in">FCommonVariantParams</span>(<span class="keyword">const</span> FString&amp; Key, FVariant Value)</span><br><span class="line">&#123;</span><br><span class="line">ValueMap.<span class="built_in">Add</span>(Key, Value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FCommonVariantParams::<span class="built_in">FCommonVariantParams</span>(std::initializer_list&lt;TPairInitializer&lt;<span class="keyword">const</span> FString&amp;, FVariant&gt;&gt; ValuePairs)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; Pair : ValuePairs)</span><br><span class="line">&#123;</span><br><span class="line">ValueMap.<span class="built_in">Add</span>(Pair.Key, Pair.Value);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FCommonVariantParams::SetValue</span><span class="params">(<span class="keyword">const</span> FString&amp; FieldName, FVariant Value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">ValueMap.<span class="built_in">Add</span>(FieldName, <span class="built_in">FVariant</span>(Value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FCommonVariantParams::Contains</span><span class="params">(<span class="keyword">const</span> FString&amp; FieldName)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ValueMap.<span class="built_in">Contains</span>(FieldName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FCommonVariantParams::IsEmpty</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ValueMap.<span class="built_in">IsEmpty</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">FCommonVariantParams::ToString</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FString DebugString = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Params:&quot;</span>));</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [Key, Value] : ValueMap)</span><br><span class="line">&#123;</span><br><span class="line">DebugString += FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;[%s=%s]&quot;</span>), *Key, *USGStringUtils::<span class="built_in">ToString</span>(Value));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> DebugString;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> TMap&lt;FString, FVariant&gt;&amp; <span class="title">FCommonVariantParams::GetValueMap</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ValueMap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FCommonVariantParams::NetSerialize</span><span class="params">(FArchive&amp; Ar, class UPackageMap* Map, <span class="keyword">bool</span>&amp; bOutSuccess)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">bOutSuccess = <span class="literal">true</span>;</span><br><span class="line">Ar &lt;&lt; ValueMap;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FCommonVariantParams FCommonVariantParams::<span class="keyword">operator</span>+(<span class="keyword">const</span> FCommonVariantParams&amp; OtherParams)</span><br><span class="line">&#123;</span><br><span class="line">FCommonVariantParams CombinedParams = *<span class="keyword">this</span>;</span><br><span class="line">CombinedParams.<span class="built_in">Merge</span>(OtherParams);</span><br><span class="line"><span class="keyword">return</span> CombinedParams;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FCommonVariantParams::Merge</span><span class="params">(<span class="keyword">const</span> FCommonVariantParams&amp; OtherParams)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [Key, Value] : OtherParams.<span class="built_in">GetValueMap</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 覆盖</span></span><br><span class="line"><span class="built_in">SetValue</span>(Key, Value);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FCommonVariantParams::Clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">ValueMap.<span class="built_in">Empty</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Lua">Lua</h3><p>对于这个 <code>CommonVariantParams</code>，还可以扩展一些方法，让这些参数可以通过 <code>Unlua</code> 在 <code>Lua</code> 脚本中设置与访问。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FCommonVariantParams::SetValue</span><span class="params">(<span class="keyword">const</span> FString&amp; FieldName, FVariant Value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">ValueMap.<span class="built_in">Add</span>(FieldName, <span class="built_in">FVariant</span>(Value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FCommonVariantParams::SetIntValue</span><span class="params">(<span class="keyword">const</span> FString&amp; FieldName, int32 Value)</span> </span>&#123; <span class="built_in">SetValue</span>(FieldName, Value); &#125;</span><br><span class="line"><span class="function">int32 <span class="title">FCommonVariantParams::GetIntValue</span><span class="params">(<span class="keyword">const</span> FString&amp; FieldName, int32 Default <span class="comment">/*= &#123;&#125;*/</span>)</span> </span>&#123; <span class="keyword">return</span> GetValue&lt;int32&gt;(FieldName, Default); &#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出：</span></span><br><span class="line"><span class="comment">// define 在 UnluaEx.h 中</span></span><br><span class="line"><span class="built_in">BEGIN_EXPORT_REFLECTED_CLASS</span>(FCommonVariantParams)</span><br><span class="line">    <span class="built_in">ADD_FUNCTION</span>(SetIntValue)</span><br><span class="line"><span class="built_in">ADD_FUNCTION</span>(GetIntValue)</span><br><span class="line"><span class="built_in">END_EXPORT_CLASS</span>()</span><br><span class="line"><span class="built_in">IMPLEMENT_EXPORTED_CLASS</span>(FCommonVariantParams)</span><br></pre></td></tr></table></figure><h3 id="具体业务">具体业务</h3><p>特别地，具体业务使用的时候，可以继承一个自己的 <code>Params</code> 来使用，以 <code>FGameplayBuffParams</code> 为例：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>()</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGameplayBuffParams</span> :</span> <span class="keyword">public</span> FCommonVariantParams</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">using</span> FCommonVariantParams::FCommonVariantParams;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;CommonParams解决方案&lt;/h1&gt;
&lt;p&gt;在实现业务框架的时候，经常需要支持传参的功能（比如 &lt;code&gt;Buff&lt;/code&gt; 系统中，&lt;code&gt;AddBuff&lt;/code&gt; 的时候，通常需要支持外部传入一个 &lt;code&gt;BuffParams&lt;/code&gt; ，</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="Gameplay" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/"/>
    
    
    <category term="Gameplay" scheme="https://www.bearchild.top/tags/Gameplay/"/>
    
    <category term="UE" scheme="https://www.bearchild.top/tags/UE/"/>
    
  </entry>
  
  <entry>
    <title>[UE]GameSubSystem简单实现</title>
    <link href="https://www.bearchild.top/2024/03/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]GameSubSystem%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/"/>
    <id>https://www.bearchild.top/2024/03/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]GameSubSystem%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/</id>
    <published>2024-03-13T16:00:00.000Z</published>
    <updated>2024-04-26T15:27:09.343Z</updated>
    
    <content type="html"><![CDATA[<h1>GameSubSystem简单实现</h1><p>一种简单的维护 <code>SubSystem</code> 的解决方案，参考 <code>UE</code> 自带的 <code>FSubsystemCollection</code> 实现。</p><p>在维护各个业务时，经常需要将一个上层的 <code>Manager</code>，下面再拆出若干个子系统，需要一种快捷的方法快速扩展出一套 <code>SUbSystem</code> 系统。</p><h2 id="基本结构">基本结构</h2><pre class="mermaid">classDiagramManager-->FGameSubSystemCollectionclass Manager {SubSystemCollections : FGameSubSystemCollection~USubSystemBase~}class FGameSubSystemCollection {FGameSubSystemCollection()}FGameSubSystemCollectionBase<|--FGameSubSystemCollectionclass FGameSubSystemCollectionBase {        Outer : TWeakObjectPtr~UObject~        SubSystemMap : TMap[UClass*,TStrongObjectPtr~UGameSubSystemBase~]        BaseType : UClass*                Init()        Uninit()        Tick()                FGameSubSystemCollectionBase(UClass* InBaseType)        AddSubSystemByClass(UClass* SubSystemClass)        RemoveSubSystemByClass(UClass* SubSystemClass)    }           FGameSubSystemCollectionBase..>UGameSubSystemBase    class UGameSubSystemBase {    LastTickTime : float        + Init()    + Uninit()    + Tick()    # OnInit()    # OnUnInit()    # OnTick(float DeltaTime)        # GetTickInternal()    # GetTimeNow()        }        UGameSubSystemBase<|--UGameSubSystem    class UGameSubSystem {    # OnInit()    # OnUnInit()    # OnTick(float DeltaTime)        # GetTickInternal()    }</pre><h2 id="使用方法">使用方法</h2><p>由 <code>Manager</code> 持有对应类型的 <code>SubSystemCollection</code>，主动调用 <code>Init</code>、<code>Uninit</code>、<code>Tick</code> 。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Manager.h</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="keyword">typename</span> TEnableIf&lt;TIsDerivedFrom&lt;T, UGameSubSystem&gt;::Value, T*&gt;::<span class="function">Type</span></span><br><span class="line"><span class="function"><span class="title">GetSubSystem</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> SubSystemCollections.GetSubSystem&lt;T&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">FGameSubSystemCollection &lt;UGameSubSystem&gt; SubSystemCollections;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Manager.cpp</span></span><br><span class="line"><span class="comment">// 在合适的时机：</span></span><br><span class="line">SubSystemCollections.<span class="built_in">Init</span>()</span><br><span class="line">SubSystemCollections.<span class="built_in">Uninit</span>()</span><br><span class="line">SubSystemCollections.<span class="built_in">Tick</span>()</span><br></pre></td></tr></table></figure><h2 id="SubSystemCollection">SubSystemCollection</h2><p><code>SubSystemCollection</code> 负责收集与管理所有的 <code>SubSystem</code>。</p><p>在 <code>SubSystemCollectionBase</code> 中，提供一个 <code>BaseClass</code>，这个 <code>BaseClass</code> 由对应的 <code>SubSystemCollection</code> 在初始化的时候传入：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TBaseType&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGameSubSystemCollection</span> :</span> FGameSubSystemCollectionBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in"><span class="keyword">static_assert</span></span>(TIsDerivedFrom&lt;TBaseType, UGameSubSystemBase&gt;::Value, <span class="string">&quot;TBaseType must inherit from UGameSubSystemBase&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">FGameSubSystemCollection</span>() : <span class="built_in">FGameSubSystemCollectionBase</span>(TBaseType::<span class="built_in">StaticClass</span>())</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FGameSubSystemCollectionBase::<span class="built_in">FGameSubSystemCollectionBase</span>(UClass* InBaseType)</span><br><span class="line">: <span class="built_in">BaseType</span>(InBaseType)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">check</span>(BaseType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>Init</code> 的时候，根据 <code>BaseClass</code>，找到所有继承于该类的 <code>Class</code> （<code>GetDerivedClasses(BaseType, SubSystemClasses, true)</code>），然后进行 <code>AddSubSystemByClass</code>。</p><p>用一个 <code>TMap &lt; UClass*, TStrongObjectPtr&lt;UGameSubSystemBase&gt; &gt; SubSystemMap</code> 将所有的 <code>SubSystem</code> 实例保存下来，这里由于我们期望 <code>FGameSubSystemCollection</code> 可以在编译期决定类型，所以使用了 <code>template&lt;typename TBaseType&gt;</code> ，导致无法走 <code>UHT</code> 的反射，挂上<code>UPROPERTY()</code> 来保证生命周期。所以这里需要用 <code>TStrongObjectPtr</code> 来保证这个 <code>Collection</code> 内部的 <code>SubSystem</code> 不会被 <code>GC</code> 掉，同时保证被 <code>Manager</code> 持有时生命周期正确。</p><p>同时我们需要</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SubSystemCollectionBase.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGameSubSystemCollectionBase</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="comment">// 外部调用</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init</span><span class="params">(UObject* InOuter)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Uninit</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Tick</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"><span class="built_in">FGameSubSystemCollectionBase</span>(UClass* InBaseType);</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">TSubSystemClass</span>&gt;</span></span><br><span class="line"><span class="keyword">typename</span> TEnableIf&lt;TIsDerivedFrom&lt;TSubSystemClass, UGameSubSystemBase&gt;::Value, UGameSubSystemBase*&gt;::<span class="function">Type</span></span><br><span class="line"><span class="function"><span class="title">GetSubSystemInternal</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> SubSystem = SubSystemMap.<span class="built_in">FindRef</span>( TSubSystemClass::<span class="built_in">StaticClass</span>() ); SubSystem.<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> SubSystem.<span class="built_in">Get</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">TSubSystemClass</span>&gt;</span></span><br><span class="line"><span class="keyword">typename</span> TEnableIf&lt;TIsDerivedFrom&lt;TSubSystemClass, UGameSubSystemBase&gt;::Value, TArray&lt;UGameSubSystemBase*&gt;&gt;::<span class="function">Type</span></span><br><span class="line"><span class="function"><span class="title">GetSubSystemsInternal</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">TArray &lt;TSubSystemClass*&gt; OutArray;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Pair : SubSystemMap)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!Pair.Value.<span class="built_in">IsValid</span>()) <span class="keyword">continue</span>;</span><br><span class="line">&#123;</span><br><span class="line">OutArray.<span class="built_in">Add</span>( Pair.Value.<span class="built_in">Get</span>() );</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> OutArray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="function">UGameSubSystemBase* <span class="title">AddSubSystemByClass</span><span class="params">(UClass* SubSystemClass)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RemoveSubSystemByClass</span><span class="params">(UClass* SubSystemClass)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">TWeakObjectPtr &lt;UObject&gt; Outer = <span class="literal">nullptr</span>;</span><br><span class="line">TMap &lt; UClass*, TStrongObjectPtr&lt;UGameSubSystemBase&gt; &gt; SubSystemMap;</span><br><span class="line">UClass* BaseType = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SubSystemCollectionBase.cpp</span></span><br><span class="line">FGameSubSystemCollectionBase::<span class="built_in">FGameSubSystemCollectionBase</span>(UClass* InBaseType)</span><br><span class="line">: <span class="built_in">BaseType</span>(InBaseType)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">check</span>(BaseType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FGameSubSystemCollectionBase::Init</span><span class="params">(UObject* InOuter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Outer.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>; <span class="comment">// already initialized</span></span><br><span class="line"><span class="keyword">if</span> (InOuter == <span class="literal">nullptr</span>) <span class="keyword">return</span>; <span class="comment">// invalid Outer</span></span><br><span class="line"></span><br><span class="line">Outer = InOuter;</span><br><span class="line"></span><br><span class="line">TArray&lt;UClass*&gt; SubSystemClasses;</span><br><span class="line"><span class="built_in">GetDerivedClasses</span>(BaseType, SubSystemClasses, <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">for</span> (UClass* SubSystemClass : SubSystemClasses)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">AddSubSystemByClass</span>(SubSystemClass);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FGameSubSystemCollectionBase::Tick</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Pair : SubSystemMap)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">auto</span> SubSystem = Pair.Value;</span><br><span class="line"><span class="keyword">if</span> (SubSystem.<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line">SubSystem-&gt;<span class="built_in">Tick</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FGameSubSystemCollectionBase::Uninit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">TArray &lt;UClass*&gt; SubSystemClasses;</span><br><span class="line">SubSystemMap.<span class="built_in">GetKeys</span>(SubSystemClasses);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> SubSystemClass : SubSystemClasses)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">RemoveSubSystemByClass</span>(SubSystemClass);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UGameSubSystemBase* <span class="title">FGameSubSystemCollectionBase::AddSubSystemByClass</span><span class="params">(UClass* SubSystemClass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (SubSystemClass == <span class="literal">nullptr</span> || !Outer.<span class="built_in">IsValid</span>()) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">if</span> (SubSystemClass-&gt;<span class="built_in">HasAnyClassFlags</span>(CLASS_Abstract)) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (SubSystemMap.<span class="built_in">Contains</span>( SubSystemClass ))</span><br><span class="line"><span class="keyword">return</span> SubSystemMap.<span class="built_in">FindRef</span>(SubSystemClass).<span class="built_in">Get</span>();</span><br><span class="line"></span><br><span class="line">UGameSubSystemBase* SubSystem = NewObject&lt;UGameSubSystemBase&gt;(Outer.<span class="built_in">Get</span>(), SubSystemClass);</span><br><span class="line">SubSystemMap.<span class="built_in">Add</span>( SubSystemClass, <span class="built_in">TStrongObjectPtr</span>(SubSystem)  );</span><br><span class="line">SubSystem-&gt;<span class="built_in">Init</span>();</span><br><span class="line"><span class="keyword">return</span> SubSystem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FGameSubSystemCollectionBase::RemoveSubSystemByClass</span><span class="params">(UClass* SubSystemClass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (SubSystemClass == <span class="literal">nullptr</span> || !Outer.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">if</span> (!SubSystemMap.<span class="built_in">Contains</span>( SubSystemClass )) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> SubSystem = SubSystemMap.<span class="built_in">FindAndRemoveChecked</span>(SubSystemClass);</span><br><span class="line"><span class="keyword">if</span> (!SubSystem.<span class="built_in">IsValid</span>()) <span class="keyword">return</span>;</span><br><span class="line">SubSystem-&gt;<span class="built_in">Uninit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SubSystemCollection.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TBaseType&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGameSubSystemCollection</span> :</span> FGameSubSystemCollectionBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in"><span class="keyword">static_assert</span></span>(TIsDerivedFrom&lt;TBaseType, UGameSubSystemBase&gt;::Value, <span class="string">&quot;TBaseType must inherit from UGameSubSystemBase&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">FGameSubSystemCollection</span>() : <span class="built_in">FGameSubSystemCollectionBase</span>(TBaseType::<span class="built_in">StaticClass</span>())</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">TSubSystemClass</span>&gt;</span></span><br><span class="line"><span class="keyword">typename</span> TEnableIf&lt;TIsDerivedFrom&lt;TSubSystemClass, TBaseType&gt;::Value, TSubSystemClass*&gt;::<span class="function">Type</span></span><br><span class="line"><span class="function"><span class="title">GetSubSystem</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;TSubSystemClass*&gt;(GetSubSystemInternal&lt;TSubSystemClass&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">TSubSystemClass</span>&gt;</span></span><br><span class="line"><span class="keyword">typename</span> TEnableIf&lt;TIsDerivedFrom&lt;TSubSystemClass, TBaseType&gt;::Value, TArray&lt;TSubSystemClass*&gt;&gt;::<span class="function">Type</span></span><br><span class="line"><span class="function"><span class="title">GetSubSystems</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> TArray&lt;UGameSubSystemBase*&gt;&amp; Array = GetSubSystemsInternal&lt;TSubSystemClass&gt;();</span><br><span class="line"><span class="keyword">const</span> TArray&lt;TSubSystemClass*&gt;* SpecificArray = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> TArray&lt;TSubSystemClass*&gt;*&gt;(&amp;Array);</span><br><span class="line"><span class="keyword">return</span> *SpecificArray;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>特别地，注意这里的 <code>FGameSubSystemCollection::GetSubSystems</code>，由于 <code>GetSubSystemsInternal</code> 返回的都是 <code>UGameSubSystemBase</code> 指针，内存大小和 <code>TSubSystemClass</code> 指针一样，所以可以使用 <code>reinterpret_cast</code> 直接将整个数组的类型转化，节省一步 <code>O(n)</code> 来 <code>cast</code> 的开销。</p><h2 id="SubSystemBase">SubSystemBase</h2><p>我们需要一个 <code>SubSystemBase</code>，负责管理给 <code>SubSystemCollection</code> 持有，同时给各自定义的 <code>SubSystem</code> 继承。</p><p>提供一些基础的方法，<code>Init</code>、<code>Uninit</code>、<code>Tick</code> 给 <code>SubSystemCollection</code> 调用。</p><p>同时子类只需要关心：<code>OnInit</code>、<code>OnUninit</code>、<code>OnTick</code>。</p><p>对于各自的业务，大家各自继承自定义的 <code>SubSystemBase</code> ，然后再自定义各自的 <code>SubSytem</code> 继承于这个业务扩展出来的 <code>SubSystemBase</code> 即可。</p><p><code>SubSystemBase-&gt;GetOuter()</code> 就可以拿到对应的 <code>Manager</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>(Abstract)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UGameSubSystemBase</span> :</span> <span class="keyword">public</span> UObject</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Tick</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Uninit</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnInit</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnUninit</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnTick</span><span class="params">(<span class="keyword">float</span> DeltaTime)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">float</span> <span class="title">GetTickInternal</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">-1.0f</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">float</span> <span class="title">GetTimeNow</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">float</span> LastTickTime;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>对于 <code>Tick</code> ，维护一个 <code>LastTickTime</code>，用于计算 <code>DeltaTime</code> 。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameSubSystemBase::Tick</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">float</span> TickInternal = <span class="built_in">GetTickInternal</span>();</span><br><span class="line"><span class="keyword">if</span> (TickInternal &lt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> CurrentTickTime = <span class="built_in">GetTimeNow</span>();</span><br><span class="line"><span class="keyword">if</span> (CurrentTickTime - LastTickTime &gt; TickInternal)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">OnTick</span>(CurrentTickTime - LastTickTime);</span><br><span class="line">LastTickTime = CurrentTickTime;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;GameSubSystem简单实现&lt;/h1&gt;
&lt;p&gt;一种简单的维护 &lt;code&gt;SubSystem&lt;/code&gt; 的解决方案，参考 &lt;code&gt;UE&lt;/code&gt; 自带的 &lt;code&gt;FSubsystemCollection&lt;/code&gt; 实现。&lt;/p&gt;
&lt;p&gt;在维护各个</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="Gameplay" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/"/>
    
    
    <category term="Gameplay" scheme="https://www.bearchild.top/tags/Gameplay/"/>
    
    <category term="UE" scheme="https://www.bearchild.top/tags/UE/"/>
    
  </entry>
  
  <entry>
    <title>[UE]TeamSystem框架</title>
    <link href="https://www.bearchild.top/2024/03/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]TeamSystem%E6%A1%86%E6%9E%B6/"/>
    <id>https://www.bearchild.top/2024/03/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]TeamSystem%E6%A1%86%E6%9E%B6/</id>
    <published>2024-03-13T16:00:00.000Z</published>
    <updated>2024-04-26T15:24:47.454Z</updated>
    
    <content type="html"><![CDATA[<h1>TeamSystem框架</h1><p>一个简单的组队系统：支持玩家的 <code>加入</code>、<code>退出</code> 队伍，以及维护队伍的各种数据（比如 <code>Members</code>、<code>Score</code>）。</p><p>首先需要一个全局的 <code>TeamManager</code> ，以及一个在 <code>Player</code> 身上的 <code>TeamComponent</code> 负责维护 <code>Player</code> 相关的组队信息；</p><p>同时，将业务拆分为多个 <code>TeamSubSystems</code>。</p><p>以及最重点的 <strong>数据同步</strong>，根据不同的数据类型，进行不同方式的数据同步。</p><h2 id="TeamSubSystemBase">TeamSubSystemBase</h2><p>首先，需要将业务拆分为多个 <code>SubSystem</code> ，通过 <code>TeamManager</code> 持有  <code>SubSystemCollection</code> 来实现这个功能。</p><p>需要一个 <code>TeamSubSystemBase</code> ，在这里传入 <code>System = TeamManager</code> 以及为后续同步数据的分发做准备。</p><p>参考：<a href="https://www.bearchild.top/2024/03/14/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/%5BUE%5DGameSubSystem%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/">[UE]GameSubSystem简单实现</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>(Abstract)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UTeamSubSystemBase</span> :</span> <span class="keyword">public</span> UGameSubSystemBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnInit</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnUninit</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">TWeakObjectPtr &lt;<span class="class"><span class="keyword">class</span> <span class="title">UTeamManager</span>&gt;</span> System = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamSubSystemBase::OnInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Super::<span class="built_in">OnInit</span>();</span><br><span class="line">System = Cast&lt;UTeamManager&gt;(<span class="built_in">GetOuter</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="TeamMemberSystem">TeamMemberSystem</h2><p>一个组队系统，最基本的功能就是玩家的 <code>JoinTeam</code>、<code>LeaveTeam</code>，对应的，需要 <code>TeamSystem</code> 支持队伍的 <code>Create</code>、<code>Destroy</code> 。</p><pre class="mermaid">classDiagram    UTeamManager..>UTeam    UTeamManager..>UTeamSubSystemBase    class UTeamManager {        SubSystemCollections : FGameSubSystemCollection~UTeamSubSystemBase~        Teams : TMap~uint64|UTeam*~         CreateTeam()        DestoryTeam()        GetTeam(uint64 TeamID)    }    class UTeamComponent {        TeamID : uint64        UpdateTeamID()    }        class UTeamSubSystemBase {    System : TWeakObjectPtr~class UTeamManager~    # OnInit()    # OnUninit()    }            UTeamMemberSystem..>UTeam    UTeamSubSystemBase<|--UTeamMemberSystem    class UTeamMemberSystem {    +JoinTeam(TeamID, PlayerUID)    +LeaveTeam(PlayerUID)    - GetOrCreateTeam(TeamID)    }        UTeam..>UTeamComponent    class UTeam {    TeamID : uint64    Members : TArray~ TWeakObjectPtr[UTeamComponent] ~    }</pre><p><em>伪代码示例：</em></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamMemberSystem::JoinTeam</span><span class="params">(uint64 TeamID, uint64 PlayerUID, <span class="keyword">bool</span> bProcessID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">auto</span> Team = <span class="built_in">GetOrCreateTeam</span>(TeamID);</span><br><span class="line">TeamComponent-&gt;<span class="built_in">UpdateTeamID</span>(Team-&gt;<span class="built_in">GetTeamID</span>());</span><br><span class="line">Team-&gt;<span class="built_in">AddMember</span>(TeamComponent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamMemberSystem::LeaveTeam</span><span class="params">(uint64 PlayerUID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line">Team-&gt;<span class="built_in">RemoveMember</span>(TeamComponent);</span><br><span class="line">TeamComponent-&gt;<span class="built_in">UpdateTeamID</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (Team-&gt;<span class="built_in">GetMembers</span>().<span class="built_in">Num</span>() == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">System-&gt;<span class="built_in">DestoryTeam</span>( TeamID );</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UTeam* <span class="title">UTeamMemberSystem::GetOrCreateTeam</span><span class="params">(uint64 TeamID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> Team = System-&gt;<span class="built_in">GetTeam</span>(TeamID); !<span class="built_in">IsValid</span>(Team))</span><br><span class="line">&#123;</span><br><span class="line">System-&gt;<span class="built_in">CreateTeam</span>(TeamID);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> System-&gt;<span class="built_in">GetTeam</span>(TeamID);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UTeam* <span class="title">UTeamManager::CreateTeam</span><span class="params">(uint64 TeamID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">GetTeam</span>(TeamID) != <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">UTeam* NewTeam = NewObject&lt;UTeam&gt;(<span class="keyword">this</span>);</span><br><span class="line">NewTeam-&gt;<span class="built_in">Init</span>(TeamID);</span><br><span class="line">Teams.<span class="built_in">Add</span>( TeamID, NewTeam );</span><br><span class="line"><span class="keyword">return</span> NewTeam;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamManager::DestoryTeam</span><span class="params">(uint64 TeamID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">auto</span> Team = <span class="built_in">GetTeam</span>(TeamID);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Team)) <span class="keyword">return</span>;</span><br><span class="line">Team-&gt;<span class="built_in">Uninit</span>();</span><br><span class="line">Teams.<span class="built_in">Remove</span>(TeamID);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeam::Init</span><span class="params">(uint64 InTeamID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">TeamID = InTeamID;</span><br><span class="line">Members.<span class="built_in">Empty</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeam::AddMember</span><span class="params">(TWeakObjectPtr&lt;UTeamComponent&gt; InMember)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Members.<span class="built_in">Add</span>(InMember);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeam::RemoveMember</span><span class="params">(TWeakObjectPtr&lt;UTeamComponent&gt; InMember)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Members.<span class="built_in">Remove</span>(InMember);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="TeamScoreSystem">TeamScoreSystem</h2><p>组队需要得分，每个队伍维护一个 <code>Score</code>。</p><pre class="mermaid">classDiagram        class UTeamSubSystemBase {    }        UTeamScoreSystem--|>UTeamSubSystemBase    class UTeamScoreSystem {    + AddScore(TeamID, InScore)    + ClearScore(TeamID)    }       UTeamScoreSystem..>UTeam    class UTeam {    Score : float    SetScore()    GetScore()    }</pre><p><em>伪代码示例：</em></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamScoreSystem::AddScore</span><span class="params">(uint64 TeamID, <span class="keyword">int</span> InAddScore)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">int</span> LastScore = <span class="built_in">GetScore</span>(TeamID);</span><br><span class="line"><span class="keyword">int</span> NewScore = LastScore + InAddScore;</span><br><span class="line"><span class="built_in">SetScore</span>( TeamID, NewScore);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamScoreSystem::ClearScore</span><span class="params">(uint64 TeamID)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">if</span> <span class="params">(!IsStandaloneOrDS(<span class="keyword">this</span>))</span> <span class="keyword">return</span></span>;</span><br><span class="line"><span class="built_in">SetScore</span>( TeamID, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="TeamSyncSystem"><em><strong>TeamSyncSystem</strong></em></h2><p>数据的同步，是该组队系统的 <strong>重点</strong> ，考虑一下对于各种各样的数据，有哪些本质的类型。</p><p>比如上述有 <code>队伍成员 Members</code>、<code>队伍分数 Score</code> 这两种数据，这两个数据的差别在于：</p><blockquote><p>① Members：对于玩家客户端，自己只关心自己队伍的 Members，不关心其它队伍的 Members</p><p>② Score：对于玩家客户端，不仅关心自己队伍的 Score，也关心其它队伍的 Score</p></blockquote><p>于是将数据拆为这两种类型，进行不同的同步方式，同时需要将同步数据的 <code>转发</code>、<code>通知</code> 分发到各个 <code>SubSystem</code> 里执行。</p><p>将这数据定义为这两种类型：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UENUM</span>()</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">ETeamSyncDataType</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">None           = <span class="number">0</span>,</span><br><span class="line">OwnerOnly      = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,</span><br><span class="line">Common         = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">ENUM_CLASS_FLAGS</span>(ETeamSyncDataType);</span><br></pre></td></tr></table></figure><blockquote><p><code>FTeamSyncData_OwnerOnly</code>：<code>Client-OwnerOnly Data</code>, 通过 <code>TeamComponent(PlayerState)-OwnerOnly</code> 同步（若某个字段，<code>Client</code> 只关心自己队伍上的，则放在这）</p><p><code>FTeamSyncData_Common</code>： <code>All Data</code>, 通过 <code>TeamManager(GameState)</code> 同步（若某个数据，<code>1P</code> 关心其它队伍上的数据，则放在这）</p></blockquote><p>特别注意的是，有时候某些数据同时存在于两种类型中，比如 <code>TeamID</code>。</p><h3 id="数据类型：OwnerOnlyData">数据类型：OwnerOnlyData</h3><p><code>OwnerOnlyData</code> 比较简单，直接将数据打包好，然后设置给 <code>TeamComponent(PS)</code> 来同步即可，将同步数据 <code>Condition</code> 设置为 <code>COND_OwnerOnly</code> 。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>()</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FTeamSyncData_OwnerOnly</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">FTeamSyncData_OwnerOnly</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">uint64 TeamID;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">TArray &lt;uint64&gt; MemberUIDs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> FTeamSyncData_OwnerOnly&amp; Other) <span class="keyword">const</span>;</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span>!=(<span class="keyword">const</span> FTeamSyncData_OwnerOnly&amp; Other) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> !(*<span class="keyword">this</span> == Other);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function">FString <span class="title">ToString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="数据类型：CommonData">数据类型：CommonData</h3><p><code>CommonData</code> 的原始数据比较简单：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>()</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FTeamSyncData_Common</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">FTeamSyncData_Common</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">uint64 TeamID = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line"><span class="keyword">int</span> Score = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">friend</span> FArchive&amp; <span class="keyword">operator</span>&lt;&lt;(FArchive&amp; Ar, FTeamSyncData_Common&amp; Data);</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> FTeamSyncData_Common&amp; Other) <span class="keyword">const</span>;</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span>!=(<span class="keyword">const</span> FTeamSyncData_Common&amp; Other) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> !(*<span class="keyword">this</span> == Other);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function">FString <span class="title">ToString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">FArchive&amp; <span class="keyword">operator</span>&lt;&lt;(FArchive&amp; Ar, FTeamSyncData_Common&amp; Data)</span><br><span class="line">&#123;</span><br><span class="line">Ar &lt;&lt; Data.TeamID;</span><br><span class="line">Ar &lt;&lt; Data.Score;</span><br><span class="line"><span class="keyword">return</span> Ar;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是由于这个数据通过 <code>TeamManager</code> 来同步，需要维护 <code>TeamID-&gt;CommonData</code> 这个映射。</p><p>但是由于 <code>TMap</code> 不能直接挂 <code>UPROPERTY()</code> 进行同步，所以需要自定义一下 <code>NetSerialize</code> 来进行同步。</p><p>在 <code>TeamManager</code> 中设置：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Manager</span></span><br><span class="line">&#123; </span><br><span class="line"><span class="built_in">UPROPERTY</span>(Replicated, PushModelProperty, ReplicatedUsing = OnRep_SyncDatas)</span><br><span class="line">FTeamSyncCommonDatas SyncDatas;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过一个 <code>SyncDatas</code> 来同步数据，这个 <code>SyncDatas</code> 里保存了 <code>TMap &lt;uint64, FTeamSyncData_Common&gt; Datas</code>，以及一个用于触发同步的 <code>SyncCount</code>。</p><p>每次数据 <code>Update</code> 或者 <code>Remove</code> 的时候，<code>MARK_SYNC_DIRTY</code> 来将 <code>SyncCount++</code>，并且 <code>MarkDirty</code> 一下，触发数据同步。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>()</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FTeamSyncCommonDatas</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">FTeamSyncCommonDatas</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function">FTeamSyncData_Common <span class="title">GetData</span><span class="params">(uint64 TeamID)</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> TMap&lt;uint64, FTeamSyncData_Common&gt;&amp; <span class="title">GetDatas</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateData</span><span class="params">(uint64 TeamID, <span class="keyword">const</span> FTeamSyncData_Common&amp; InData)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RemoveData</span><span class="params">(uint64 TeamID)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">TMap &lt;uint64, FTeamSyncData_Common&gt; Datas;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">NetSerialize</span><span class="params">(FArchive&amp; Ar, class UPackageMap* Map, <span class="keyword">bool</span>&amp; bOutSuccess)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MARK_SYNC_DIRTY</span><span class="params">()</span></span>;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line">uint32 SYNC_COUNT = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TStructOpsTypeTraits</span>&lt;</span>FTeamSyncCommonDatas&gt; : TStructOpsTypeTraitsBase2&lt;FTeamSyncCommonDatas&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">WithNetSerializer = <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FTeamSyncData_Common <span class="title">FTeamSyncCommonDatas::GetData</span><span class="params">(uint64 TeamID)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!Datas.<span class="built_in">Contains</span>(TeamID)) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">return</span> Datas[TeamID];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> TMap&lt;uint64, FTeamSyncData_Common&gt;&amp; <span class="title">FTeamSyncCommonDatas::GetDatas</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> Datas;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FTeamSyncCommonDatas::UpdateData</span><span class="params">(uint64 TeamID, <span class="keyword">const</span> FTeamSyncData_Common&amp; InData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Datas.<span class="built_in">Add</span>( TeamID, InData );</span><br><span class="line"><span class="built_in">MARK_SYNC_DIRTY</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FTeamSyncCommonDatas::RemoveData</span><span class="params">(uint64 TeamID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Datas.<span class="built_in">Remove</span>(TeamID);</span><br><span class="line"><span class="built_in">MARK_SYNC_DIRTY</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FTeamSyncCommonDatas::MARK_SYNC_DIRTY</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">SYNC_COUNT++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FTeamSyncCommonDatas::NetSerialize</span><span class="params">(FArchive&amp; Ar, UPackageMap* Map, <span class="keyword">bool</span>&amp; bOutSuccess)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Ar &lt;&lt; SYNC_COUNT;</span><br><span class="line">Ar &lt;&lt; Datas;</span><br><span class="line">bOutSuccess = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="数据同步">数据同步</h3><pre class="mermaid">classDiagramclass UTeam {    + CollectSyncData_OwnerOnly(FTeamSyncData_OwnerOnly& SyncData)    + CollectSyncData_Common(FTeamSyncData_Common& SyncData)    - NotifySyncDataChanged(ETeamSyncDataType DataType)    }        UTeam..>Delegate    Delegate..>UTeamSubSystemBase        class UTeamSubSystemBase {    - RegisterSyncData()    - UnregisterSyncData()    # OnSyncTeamDataOwnerOnlyChanged(TeamID, NewData, LastData)    # OnSyncTeamDataCommonChanged(TeamID, NewData, LastData)    }</pre><p>由于原始数据存在 <code>DS</code> 的 <code>UTeam</code> 上，实现一个 <code>Notify</code> 方法，在数据变化的时候，通过 <code>Delegate</code> 调用到 <code>TeamSyncSystem</code>，进行数据的分发。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeam::NotifySyncDataChanged</span><span class="params">(ETeamSyncDataType DataType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">EnumHasAllFlags</span>(DataType, ETeamSyncDataType::OwnerOnly))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> Delegate = UTeamCommonDelegate::<span class="built_in">GetDelegate</span>()-&gt;OnSyncTeamData_OwnerOnly; Delegate.<span class="built_in">IsBound</span>())</span><br><span class="line">&#123;</span><br><span class="line">Delegate.<span class="built_in">Execute</span>(TeamID);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">EnumHasAllFlags</span>(DataType, ETeamSyncDataType::Common))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> Delegate = UTeamCommonDelegate::<span class="built_in">GetDelegate</span>()-&gt;OnSyncTeamData_Common; Delegate.<span class="built_in">IsBound</span>())</span><br><span class="line">&#123;</span><br><span class="line">Delegate.<span class="built_in">Execute</span>(TeamID);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddMember、RemoveMember 时 Members 发生变化后：</span></span><br><span class="line"><span class="built_in">NotifySyncDataChanged</span>(ETeamSyncDataType::OwnerOnly);</span><br><span class="line"><span class="comment">// SetScore 时 Score发生变化</span></span><br><span class="line"><span class="built_in">NotifySyncDataChanged</span>(ETeamSyncDataType::Common);</span><br></pre></td></tr></table></figure><p>在 <code>TeamSyncData : TeamSubSystemBase</code> 里绑定两种数据变化的 <code>Delegate</code>，对数据进行操作：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamSyncSystem::SyncTeamData_OwnerOnlyCallback</span><span class="params">(uint64 TeamID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FTeamSyncData_OwnerOnly SyncData;</span><br><span class="line">Team-&gt;<span class="built_in">CollectSyncData_OwnerOnly</span>(SyncData);</span><br><span class="line">    <span class="comment">// 对队伍里的所有成员修改 SyncData</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> Member : Team-&gt;<span class="built_in">GetMembers</span>())</span><br><span class="line">&#123;</span><br><span class="line">Member-&gt;<span class="built_in">UpdateTeamSyncData</span>( SyncData ); </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamSyncSystem::OnSyncTeamData_CommonCallback</span><span class="params">(uint64 TeamID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FTeamSyncData_Common SyncData;</span><br><span class="line">Team-&gt;<span class="built_in">CollectSyncData_Common</span>(SyncData);</span><br><span class="line">    <span class="comment">// 将数据设置到 Manager 里</span></span><br><span class="line">System-&gt;<span class="built_in">UpdateTeamSyncData</span>( TeamID, SyncData );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>特别地，在 <code>DestroyTeam</code> 时，进行 <code>RemoveSyncData</code>；在玩家 <code>LeaveTeam</code> 时，<code>UpdateTeamSyncData( &#123;&#125; ) </code>清空数据。</p><h3 id="数据分发">数据分发</h3><p>显然需要在 <code>DS/Clinet</code> 进行数据的分发，将数据变化重新分发回各个业务。</p><p>于是在对应数据的 <code>OnRep</code> 里将数据传给 <code>TeamSubSystemBase</code>，并且分发数据给各个子系统。</p><pre class="mermaid">flowchart TDTeam--Notify-->TeamSyncSystemTeamSyncSystem--SetData-->TeamComponentTeamSyncSystem--SetData-->TeamManagerTeamComponent--OnRep_SyncData : OwnerOnly-->TeamSubSystemBaseTeamManager--OnRep_SyncDatas : Common-->TeamSubSystemBaseTeamSubSystemBase--OnSync : OwnerOnlyData-->TeamMemberSystemTeamSubSystemBase--OnSync : CommonData-->TeamScoreSystemTeamSubSystemBase--OnSync-->OtherSystem...</pre><h4 id="RepData">RepData</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamManager::UpdateTeamSyncData</span><span class="params">(uint64 TeamID, <span class="keyword">const</span> FTeamSyncData_Common&amp; InData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">GetSyncDatas_Mutable</span>().<span class="built_in">UpdateData</span>( TeamID, InData );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamManager::RemoveTeamSyncData</span><span class="params">(uint64 TeamID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">GetSyncDatas_Mutable</span>().<span class="built_in">RemoveData</span>(TeamID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamManager::OnRep_SyncDatas</span><span class="params">(<span class="keyword">const</span> FTeamSyncCommonDatas&amp; LastSyncDatas)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [TeamID, NewData] : SyncDatas.<span class="built_in">GetDatas</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (TeamID == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> LastData = LastSyncDatas.<span class="built_in">GetData</span>(TeamID); LastData != NewData)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> Delegate = UTeamCommonDelegate::<span class="built_in">GetDelegate</span>()-&gt;OnSyncTeamDataCommonChanged; Delegate.<span class="built_in">IsBound</span>())</span><br><span class="line">&#123;</span><br><span class="line">Delegate.<span class="built_in">Execute</span>(TeamID, NewData, LastData);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamManager::OnRep_SyncDatas</span><span class="params">(<span class="keyword">const</span> FTeamSyncCommonDatas&amp; LastSyncDatas)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [TeamID, NewData] : SyncDatas.<span class="built_in">GetDatas</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (TeamID == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> LastData = LastSyncDatas.<span class="built_in">GetData</span>(TeamID); LastData != NewData)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> Delegate = UTeamCommonDelegate::<span class="built_in">GetDelegate</span>()-&gt;OnSyncTeamDataCommonChanged; Delegate.<span class="built_in">IsBound</span>())</span><br><span class="line">&#123;</span><br><span class="line">Delegate.<span class="built_in">Execute</span>(TeamID, NewData, LastData);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Data-Register-Changed">Data Register&amp;Changed</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>(Abstract)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UTeamSubSystemBase</span> :</span> <span class="keyword">public</span> UGameSubSystemBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">        </span><br><span class="line"><span class="comment">// ----- 客户端收到数据后的事件分发 ------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> ETeamSyncDataType <span class="title">GetRegisterSyncDataType</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> ETeamSyncDataType::None; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterSyncData</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnregisterSyncData</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamSubSystemBase::RegisterSyncData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">IsClient</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> Type = <span class="built_in">GetRegisterSyncDataType</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">EnumHasAllFlags</span>(Type, ETeamSyncDataType::OwnerOnly))</span><br><span class="line">&#123;</span><br><span class="line">UTeamCommonDelegate::<span class="built_in">GetDelegate</span>()-&gt;OnSyncTeamDataOwnerOnlyChanged.<span class="built_in">BindDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::OnSyncTeamDataOwnerOnlyChanged );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">EnumHasAllFlags</span>(Type, ETeamSyncDataType::Common))</span><br><span class="line">&#123;</span><br><span class="line">UTeamCommonDelegate::<span class="built_in">GetDelegate</span>()-&gt;OnSyncTeamDataCommonChanged.<span class="built_in">BindDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::OnSyncTeamDataCommonChanged );</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamSubSystemBase::UnregisterSyncData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">IsClient</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">auto</span> Type = <span class="built_in">GetRegisterSyncDataType</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">EnumHasAllFlags</span>(Type, ETeamSyncDataType::OwnerOnly))</span><br><span class="line">&#123;</span><br><span class="line">UTeamCommonDelegate::<span class="built_in">GetDelegate</span>()-&gt;OnSyncTeamDataOwnerOnlyChanged.<span class="built_in">Unbind</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">EnumHasAllFlags</span>(Type, ETeamSyncDataType::Common))</span><br><span class="line">&#123;</span><br><span class="line">UTeamCommonDelegate::<span class="built_in">GetDelegate</span>()-&gt;OnSyncTeamDataCommonChanged.<span class="built_in">Unbind</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 供 SubSytem 重载</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamSubSystemBase::OnSyncTeamDataOwnerOnlyChanged</span><span class="params">(uint64 TeamID, <span class="keyword">const</span> FTeamSyncData_OwnerOnly&amp; NewData, <span class="keyword">const</span> FTeamSyncData_OwnerOnly&amp; LastData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamSubSystemBase::OnSyncTeamDataCommonChanged</span><span class="params">(uint64 TeamID, <span class="keyword">const</span> FTeamSyncData_Common&amp; NewData, <span class="keyword">const</span> FTeamSyncData_Common&amp; LastData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在每个不同的 <code>SubSystem</code> 里，通过 <code>override GetRegisterSyncDataType </code> 来决定自己需要监听哪种类型的数据（也可以都监听）</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TeamMemberSystem</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> ETeamSyncDataType <span class="title">GetRegisterSyncDataType</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> ETeamSyncDataType::OwnerOnly; &#125;</span><br><span class="line"><span class="comment">// TeamScoreSystem:</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> ETeamSyncDataType <span class="title">GetRegisterSyncDataType</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> ETeamSyncDataType::Common; &#125;</span><br><span class="line"><span class="comment">// OtherSystem:</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> ETeamSyncDataType <span class="title">GetRegisterSyncDataType</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> ETeamSyncDataType::OwnerOnly | ETeamSyncDataType::Common; &#125;</span><br></pre></td></tr></table></figure><p>各个 <code>SubSystem</code> 自己重载需要的 <code>OnSyncTeamDataOwnerOnlyChanged</code> 或 <code>OnSyncTeamDataCommonChanged</code>，可以根据 <code>Data</code>、<code>LastData</code> 进行数据的 <code>Diff</code> 并进行事件通知，比如：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UTeamMemberSystem::OnSyncTeamDataOwnerOnlyChanged</span><span class="params">(uint64 TeamID, <span class="keyword">const</span> FTeamSyncData_OwnerOnly&amp; NewData, <span class="keyword">const</span> FTeamSyncData_OwnerOnly&amp; LastData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Super::<span class="built_in">OnSyncTeamDataOwnerOnlyChanged</span>(TeamID, NewData, LastData);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> MemberUID : NewData.MemberUIDs)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!LastData.MemberUIDs.<span class="built_in">Contains</span>(MemberUID))</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ADD</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> Component = UTeamUtils::<span class="built_in">GetComponentByUID</span>(<span class="built_in">GetWorld</span>(), MemberUID); <span class="built_in">IsValid</span>(Component)) <span class="comment">// 客户端设置 TeamID, 防止同步延迟问题</span></span><br><span class="line">&#123;</span><br><span class="line">Component-&gt;<span class="built_in">UpdateTeamID</span>(TeamID);</span><br><span class="line">&#125;</span><br><span class="line">UTeamUtils::<span class="built_in">NotifyTeamMemberChanged</span>(TeamID, MemberUID, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> MemberUID : LastData.MemberUIDs)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!NewData.MemberUIDs.<span class="built_in">Contains</span>(MemberUID))</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//Remove</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> Component = UTeamUtils::<span class="built_in">GetComponentByUID</span>(<span class="built_in">GetWorld</span>(), MemberUID); <span class="built_in">IsValid</span>(Component)) <span class="comment">// 客户端设置 TeamID, 防止同步延迟问题</span></span><br><span class="line">&#123;</span><br><span class="line">Component-&gt;<span class="built_in">UpdateTeamID</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">UTeamUtils::<span class="built_in">NotifyTeamMemberChanged</span>(TeamID, MemberUID, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;TeamSystem框架&lt;/h1&gt;
&lt;p&gt;一个简单的组队系统：支持玩家的 &lt;code&gt;加入&lt;/code&gt;、&lt;code&gt;退出&lt;/code&gt; 队伍，以及维护队伍的各种数据（比如 &lt;code&gt;Members&lt;/code&gt;、&lt;code&gt;Score&lt;/code&gt;）。&lt;/p&gt;
&lt;p&gt;</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="Gameplay" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/"/>
    
    
    <category term="Gameplay" scheme="https://www.bearchild.top/tags/Gameplay/"/>
    
    <category term="UE" scheme="https://www.bearchild.top/tags/UE/"/>
    
  </entry>
  
  <entry>
    <title>[UE]GameplayBuffSystem框架</title>
    <link href="https://www.bearchild.top/2024/02/23/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]GameplayBuffSystem%E6%A1%86%E6%9E%B6/"/>
    <id>https://www.bearchild.top/2024/02/23/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]GameplayBuffSystem%E6%A1%86%E6%9E%B6/</id>
    <published>2024-02-22T16:00:00.000Z</published>
    <updated>2024-04-26T15:56:24.244Z</updated>
    
    <content type="html"><![CDATA[<h1>GameplayBuffSystem框架</h1><h2 id="设计">设计</h2><p>首先我们需要一个 <code>BuffManager</code> ，管理所有的 <code>BuffComponent</code>。<br>（实现的时候，可以让 <code>BuffManager</code> 作为一个 <code>GameStateComponent</code>；<code>BuffComponent</code> 作为一个 <code>PlayerStateComponent</code> ）</p><p>对于每个 <code>Player</code>，需要一个 <code>BuffComponent</code> 管理该 <code>Player</code> 身上持有的 <code>Buff</code>；</p><p>对于 <code>Buff</code>，需要一个 <code>BuffBase</code> 作为 <code>Buff</code> 的基类；</p><pre class="mermaid">classDiagramUGameplayBuffManager..>FGameplayBuffSettingUGameplayBuffManager..>UGameplayBuffComponentUGameplayBuffManager..>FGameplayBuffParams    class UGameplayBuffManager {        BuffSettings : TMap~int|FGameplayBuffSetting~        +CommitBuff(Target, BuffID, Params)        +QueryBuff(Target, BuffID)        +CombineBuffParams(Target, BuffID, Params)        +RemoveBuff(Target, BuffID, bRemoveImmediately)        +RemoveBuff(Target, BuffHandle, bRemoveImmediately)        +ClearBuff(Target)        -Tick()        -CreateBuff(Target, BuffID, Params)    }        UGameplayBuffComponent..>UGameplayBuffBase    class UGameplayBuffComponent {    BuffGroup : TArray~UGameplayBuffBase*~        BuffIDArray : int (For Sync)        AddBuff(InBuff)        RemoveBuff(InBuff, bRemoveImmediately)    }class FGameplayBuffSetting {        BuffName : FString        bNeedToMerge : bool        BuffAsset : TSubclassOf~UGameplayBuffBase~    }    class FGameplayBuffParams {        # ValueMap : TMap~FString, FVariant~ ValueMap        FGameplayBuffParams(std::initializer_list ~TPairInitializer[const FString&, FVariant]~ ValuePairs)        SetValue(const FString& FieldName, FVariant Value)        Contains(const FString& FieldName)        IsEmpty()        Merge(const FGameplayBuffParams& OtherParams)        GetValueMap() const        operator+(const FGameplayBuffParams& OtherParams)    }        class FGameplayCountDownData {    StartTime    TotalTime    LeftTime    IsPause    SpeedFactor    }UGameplayBuffBase..>FGameplayBuffParamsclass UGameplayBuffBase {Owner : TWeakObjectPtr~UGameBuffComponent~BuffID : intBuffName : FStringBuffParams : FGameplayBuffParams+Create(Owner, BuffID, Params)+Remove()+Merge(BuffHandle, Params)+CombineParams(Params)+Tick(DeltaTime)+CheckNeetToStop()+SetNeedToRemove(bEnable)#OnCreate()#OnRemove()#OnMerge()#OnTick()}UGameplayBuffBase<|--UGameplayBuff_TimeDurationUGameplayBuff_TimeDuration..>FGameplayCountDownDataclass UGameplayBuff_TimeDuration {# TimeDuration : float# PassDuration : float# TickInternal : float# LastTickTime : float- SpeedFactor : float- bInPause : false- PauseReasons : TArray~FString~# Tick(DeltaTime)+ Refresh(InPassDuration, InTimeDuration)+ BeginPauseTime(Reason)+ StopPauseTime(Reason)+ UpdateSpeedFactor(InFactor)+ GetTimeDuration()+ GetLeftTime()+ GetCountDownData()# OnBeginPauseTime()# OnStopPauseTime()# OnUpdateSpeedFactor()# OnRefresh()# OnTimeStateChanged()}UGameplayBuffUtils..>UGameplayBuffManagerclass UGameplayBuffUtils {}</pre><h2 id="BuffManager">BuffManager</h2><ol><li><p><code>Commit</code>：判断 <code>BuffSettings</code> 里是否有对应 <code>BuffID</code> 的 <code>Buff</code>，若存在则创建该实例；</p><p>判断一下 <code>BuffComponent</code> 里是否原本已经有相同 <code>BuffID</code> 的 <code>Buff</code>，若存在，并且该 <code>Buff</code> 需要 <code>Merge</code> 的话，执行 <code>OldBuff</code> 的  <code>Merge</code> ，并将新创建的 <code>Buff</code> 给 <code>Remove</code> ；</p><p>否则直接执行 <code>BuffComponent</code> 的 <code>AddBuff</code>。</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UGameplayBuffBase* <span class="title">UGameplayBuffManager::CommitBuff</span><span class="params">(UGameplayBuffComponent* Target, <span class="keyword">int</span> BuffID, <span class="keyword">const</span> FGameplayBuffParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Target == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::CommitBuff, Target is nullptr! BuffID=%d&quot;</span>), BuffID);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MergedParams 的作用：将代码中传入的参数与额外配置表中的参数 Merge，实现 BuffParams 的配置化</span></span><br><span class="line">FGameplayBuffParams MergedParams = <span class="built_in">GetMergedParams</span>( BuffID, Params );</span><br><span class="line"></span><br><span class="line">UGameplayBuffBase* Buff = <span class="built_in">CreateBuff</span>(Target, BuffID, MergedParams);</span><br><span class="line"><span class="keyword">if</span> (Buff == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::CommitBuff, Buff is nullptr! UID=%llu, BuffID=%d&quot;</span>), Target-&gt;<span class="built_in">GetUID</span>(), BuffID);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> SpecBuffGroup = Target-&gt;<span class="built_in">GetBuffGroupByBuffID</span>(BuffID);</span><br><span class="line"><span class="keyword">if</span> (SpecBuffGroup.<span class="built_in">Num</span>() &amp;&amp; BuffSettings[BuffID].bNeedToMerge == <span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">UGameplayBuffBase* OldBuff = SpecBuffGroup[<span class="number">0</span>];</span><br><span class="line">OldBuff-&gt;<span class="built_in">Merge</span>(Buff, MergedParams);</span><br><span class="line">Buff-&gt;<span class="built_in">Remove</span>();</span><br><span class="line"><span class="keyword">return</span> OldBuff;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">Target-&gt;<span class="built_in">AddBuff</span>(Buff);</span><br><span class="line"><span class="keyword">return</span> Buff;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UGameplayBuffBase* <span class="title">UGameplayBuffManager::CreateBuff</span><span class="params">(UGameplayBuffComponent* Target, <span class="keyword">int</span> BuffID, <span class="keyword">const</span> FGameplayBuffParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!BuffSettings.<span class="built_in">Contains</span>(BuffID) || !<span class="built_in">IsValid</span>(BuffSettings[BuffID].BuffAsset))</span><br><span class="line">&#123; </span><br><span class="line"><span class="built_in">LogW</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::CreateBuff,  Miss BuffSetting! UID=%llu, BuffID=%d&quot;</span>), Target-&gt;<span class="built_in">GetUID</span>(), BuffID);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">UGameplayBuffBase* BuffInst = NewObject&lt;UGameplayBuffBase&gt;( Target, BuffSettings[BuffID].BuffAsset );</span><br><span class="line"><span class="keyword">if</span> (BuffInst == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogW</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::CreateBuff,  BuffInst is nullptr! UID=%llu, BuffID=%d&quot;</span>), Target-&gt;<span class="built_in">GetUID</span>(), BuffID);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BuffInst-&gt;<span class="built_in">Create</span>(Target, BuffID, Params);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> BuffInst;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><code>Query</code>：判断<code>BuffComponent</code>上是否有对应ID的<code>Buff</code>，返回对应 <code>Handle</code>：</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TArray&lt;UGameplayBuffBase*&gt; <span class="title">UGameplayBuffManager::QueryBuff</span><span class="params">(UGameplayBuffComponent* Target, <span class="keyword">int</span> BuffID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Target == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::QueryBuff, Target is nullptr! BuffID=%d&quot;</span>), BuffID);</span><br><span class="line"><span class="keyword">return</span> TArray&lt;UGameplayBuffBase*&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> SpecBuffGroup = Target-&gt;<span class="built_in">GetBuffGroupByBuffID</span>(BuffID);</span><br><span class="line"><span class="keyword">return</span> SpecBuffGroup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li><code>Remove</code>：通过 <code>BuffID</code> 或者 <code>Handle</code> 把 <code>BuffComponent</code> 上存在的对应 <code>Buff</code> 给 <code>Remove</code>。<br>特别的，为了解决 <code>Buff</code> 之间的依赖问题（比如 <code>Buff(A-&gt;B)</code>，在  <code>A、B</code> 的 <code>Remove</code> 都调用到了另一个 <code>Buff</code> 的 <code>Remove</code>，会导致循环 <code>Remove</code>问题），维护一个 <code>bRemoveImmediately</code> （默认为<code>false</code>），每次调用 <code>Remove</code> 时只是 <code>MarkDirty</code>（把移除标记设为 <code>true</code>），在下一次 <code>Tick</code> 才会实际移除。<br>这样就可以一次 <code>Tick</code> 移除一个 <code>Buff</code>，通过时间来解开了这个循环依赖的链条。</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffManager::RemoveBuff</span><span class="params">(UGameplayBuffComponent* Target, <span class="keyword">int</span> BuffID, <span class="keyword">bool</span> bRemoveImmediately)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Target == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::RemoveBuff, Target is nullptr! BuffID=%d&quot;</span>), BuffID);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> SpecBuffGroup = Target-&gt;<span class="built_in">GetBuffGroupByBuffID</span>(BuffID);</span><br><span class="line"><span class="keyword">if</span> (!SpecBuffGroup.<span class="built_in">Num</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::RemoveBuff, Buff is not exist! UID=%llu, BuffID=%d&quot;</span>), Target-&gt;<span class="built_in">GetUID</span>(), BuffID);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> Index = SpecBuffGroup.<span class="built_in">Num</span>() - <span class="number">1</span>; Index &gt;= <span class="number">0</span>; Index--)</span><br><span class="line">&#123;</span><br><span class="line">Target-&gt;<span class="built_in">RemoveBuff</span>(SpecBuffGroup[Index], bRemoveImmediately);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffManager::RemoveBuff</span><span class="params">(UGameplayBuffComponent* Target, UGameplayBuffBase* Buff, <span class="keyword">bool</span> bRemoveImmediately)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Target == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::RemoveBuff, Target is nullptr!&quot;</span>));</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">Target-&gt;<span class="built_in">RemoveBuff</span>(Buff, bRemoveImmediately);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffManager::ClearBuff</span><span class="params">(UGameplayBuffComponent* Target)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Target == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::RemoveBuff, Target is nullptr!&quot;</span>));</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> BuffGroup = Target-&gt;<span class="built_in">GetBuffGroup</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> Index = BuffGroup.<span class="built_in">Num</span>() - <span class="number">1</span>; Index &gt;= <span class="number">0</span>; Index--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (Index &gt;= BuffGroup.<span class="built_in">Num</span>()) <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">auto</span> Buff = BuffGroup[Index];</span><br><span class="line"><span class="keyword">if</span> (Buff == <span class="literal">nullptr</span>) <span class="keyword">continue</span>;</span><br><span class="line">Target-&gt;<span class="built_in">RemoveBuff</span>(Buff);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li><code>Combine</code>：<code>Buff</code> 显然需要支持传入参数，在 <code>Create</code> 的时候传参，或者通过 <code>CombineParams</code> 将参数传入 <code>Buff</code> 中：</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffManager::CombineBuffParams</span><span class="params">(UGameplayBuffComponent* Target, <span class="keyword">int</span> BuffID, <span class="keyword">const</span> FGameplayBuffParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Target == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::CombineBuffParams, Target is nullptr! BuffID=%d&quot;</span>), BuffID);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> SpecBuffGroup = Target-&gt;<span class="built_in">GetBuffGroupByBuffID</span>(BuffID);</span><br><span class="line"><span class="keyword">if</span> (!SpecBuffGroup.<span class="built_in">Num</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::CombineBuffParams, Buff is not exist! UID=%llu, BuffID=%d&quot;</span>), Target-&gt;<span class="built_in">GetUID</span>(), BuffID);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> Buff : SpecBuffGroup)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">IsValid</span>(Buff))</span><br><span class="line">&#123;</span><br><span class="line">Buff-&gt;<span class="built_in">CombineParams</span>(Params);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffManager::CombineBuffParams</span><span class="params">(UGameplayBuffBase* Buff, <span class="keyword">const</span> FGameplayBuffParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Buff == <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::CombineBuffParams, Buff is nullptr!&quot;</span>));</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Buff-&gt;<span class="built_in">CombineParams</span>(Params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li><code>Tick</code>：遍历<code>BuffComponent</code>，遍历其中的 <code>BuffGroup</code>；对每一个<code>Buff</code> 执行 <code>Tick</code>，并且检查是否需要 <code>Stop</code> ：</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffManager::TickComponent</span><span class="params">(<span class="keyword">float</span> DeltaTime, ELevelTick TickType, FActorComponentTickFunction* ThisTickFunction)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">IsClient</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line">Super::<span class="built_in">TickComponent</span>(DeltaTime, TickType, ThisTickFunction);</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> GS = GetOwner&lt;AGameStateBase&gt;();</span><br><span class="line"><span class="keyword">auto</span> PlayerArray = GS-&gt;<span class="built_in">GetAllPlayerState</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> Player : PlayerArray)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">auto</span> Target = UFunctionLibrary::GetPlayerStateComponent&lt;UGameplayBuffComponent&gt;(Player);</span><br><span class="line"><span class="keyword">if</span> (Target == <span class="literal">nullptr</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">auto</span> BuffGroup = Target-&gt;<span class="built_in">GetBuffGroup</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tick</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> Buff : BuffGroup)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (Buff == <span class="literal">nullptr</span>) <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">if</span> (!Buff-&gt;<span class="built_in">CheckNeedToStop</span>())</span><br><span class="line">&#123;</span><br><span class="line">Buff-&gt;<span class="built_in">Tick</span>(DeltaTime);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove</span></span><br><span class="line"><span class="keyword">int</span> TotalCount = BuffGroup.<span class="built_in">Num</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> Index = TotalCount - <span class="number">1</span>; Index &gt;= <span class="number">0</span>; Index--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">auto</span>&amp; Buff = BuffGroup[Index];</span><br><span class="line"><span class="keyword">if</span> (Buff-&gt;<span class="built_in">CheckNeedToStop</span>() || Buff-&gt;<span class="built_in">CheckNeedToRemove</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffManager::TickComponent, Remove Buff (UID=%llu, BuffID=%d)&quot;</span>), Player-&gt;<span class="built_in">GetActorStateUID</span>(), Buff-&gt;<span class="built_in">GetBuffID</span>());</span><br><span class="line">Target-&gt;<span class="built_in">RemoveBuff</span>(Buff, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="BuffComponent">BuffComponent</h2><ol><li><code>AddBuff</code>：将 <code>Buff</code> 添加到 <code>BuffGroup</code> / <code>BuffIDArray</code>，通过 <code>BuffIDArray</code> 做客户端的同步（仅同步 <code>BuffID</code> 到客户端）</li><li><code>RemoveBuff</code>：移除 <code>Buff</code>，并执行该 <code>Buff</code> 的 <code>Remove</code> 方法，同步对应信息；</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffComponent::AddBuff</span><span class="params">(UGameplayBuffBase* InBuff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">BuffGroup.<span class="built_in">Add</span>( InBuff );</span><br><span class="line"><span class="built_in">GetBuffIDArray_Mutable</span>().<span class="built_in">Add</span>( InBuff-&gt;<span class="built_in">GetBuffID</span>() );</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">OnRep_BuffIDArray</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffComponent::RemoveBuff</span><span class="params">(UGameplayBuffBase* InBuff, <span class="keyword">bool</span> bRemoveImmediately)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (InBuff == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> TotalCount = BuffGroup.<span class="built_in">Num</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> Index = TotalCount - <span class="number">1</span>; Index &gt;= <span class="number">0</span>; Index--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (BuffGroup[Index] == InBuff)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (bRemoveImmediately == <span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">BuffGroup.<span class="built_in">RemoveAt</span>( Index );</span><br><span class="line"><span class="built_in">GetBuffIDArray_Mutable</span>().<span class="built_in">RemoveAt</span>( Index );</span><br><span class="line">InBuff-&gt;<span class="built_in">SetNeedToRemove</span>(<span class="literal">true</span>);</span><br><span class="line">InBuff-&gt;<span class="built_in">Remove</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">OnRep_BuffIDArray</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">InBuff-&gt;<span class="built_in">SetNeedToRemove</span>(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffComponent::OnUninit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Super::<span class="built_in">OnUninit</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">IsStandaloneOrDS</span>(<span class="keyword">this</span>)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> Index = BuffGroup.<span class="built_in">Num</span>() - <span class="number">1</span>; Index &gt;= <span class="number">0</span>; Index--)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (Index &gt;= BuffGroup.<span class="built_in">Num</span>()) <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">auto</span> Buff = BuffGroup[Index];</span><br><span class="line"><span class="keyword">if</span> (Buff == <span class="literal">nullptr</span>) <span class="keyword">continue</span>;</span><br><span class="line">BuffGroup.<span class="built_in">RemoveAt</span>( Index );</span><br><span class="line">Buff-&gt;<span class="built_in">Remove</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffComponent::OnRep_BuffIDArray</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Buff">Buff</h2><h3 id="BuffBase">BuffBase</h3><p>每个 <code>Buff</code> 的实际持有者为 <code>BuffComponent</code> 。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffBase::Create</span><span class="params">(UGameplayBuffComponent* InOwner, <span class="keyword">int</span> InBuffID, <span class="keyword">const</span> FGameplayBuffParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (InOwner == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">Owner = InOwner;</span><br><span class="line">BuffID = InBuffID;</span><br><span class="line">BuffName = UGameplayBuffUtils::<span class="built_in">GetBuffName</span>(BuffID);</span><br><span class="line">BuffParams = Params;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffBase::Create,  UID=%llu, BuffID=%d, BuffName=%s, Params=%s&quot;</span>), Owner-&gt;<span class="built_in">GetUID</span>(), BuffID, *BuffName, *BuffParams.<span class="built_in">ToString</span>());</span><br><span class="line"><span class="built_in">OnCreate</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffBase::Remove</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Owner == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffBase::Remove,  UID=%llu, BuffID=%d, BuffName=%s&quot;</span>), Owner-&gt;<span class="built_in">GetUID</span>(), BuffID, *BuffName);</span><br><span class="line"><span class="built_in">OnRemove</span>();</span><br><span class="line"></span><br><span class="line">Owner = <span class="literal">nullptr</span>;</span><br><span class="line">BuffID = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffBase::Merge</span><span class="params">(UGameplayBuffBase* InBuff, <span class="keyword">const</span> FGameplayBuffParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Owner == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuffBase::Merge,  UID=%llu, BuffID=%d, BuffName=%s&quot;</span>), Owner-&gt;<span class="built_in">GetUID</span>(), BuffID, *BuffName);</span><br><span class="line"><span class="built_in">OnMerge</span>(InBuff, Params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffBase::Tick</span><span class="params">(<span class="keyword">float</span> DeltaTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">OnTick</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuffBase::CombineParams</span><span class="params">(<span class="keyword">const</span> FGameplayBuffParams&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">BuffParams = BuffParams + Params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TimeDurationBuff">TimeDurationBuff</h3><p>Time时间流逝的 <code>Buff</code>，需要支持 <code>Refresh</code>、 <code>Pause</code>、<code>UpdateSpeedFactor</code> 等操作；</p><ol><li>基础的 <code>TimeDurationBuff</code> 的实现：</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuff_TimeDuration::OnCreate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Super::<span class="built_in">OnCreate</span>();</span><br><span class="line"></span><br><span class="line">TimeDuration = BaseTimeDuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> InDuration = BuffParams.<span class="built_in">GetValue</span>(<span class="string">&quot;Duration&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (InDuration != <span class="number">0</span>) TimeDuration = InDuration;</span><br><span class="line"></span><br><span class="line">PassDuration = <span class="number">0.0f</span>;</span><br><span class="line">LastTickTime = <span class="built_in">GetWorldTimeNow</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuff_TimeDuration::Tick</span><span class="params">(<span class="keyword">float</span> DeltaTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">GetWorld</span>() == <span class="literal">nullptr</span> || <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetGameState</span>() == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> CurrentTickTime = <span class="built_in">GetWorldTimeNow</span>();</span><br><span class="line">TickInternal = CurrentTickTime - LastTickTime;</span><br><span class="line">LastTickTime = CurrentTickTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">CheckInPause</span>() == <span class="literal">false</span> &amp;&amp; <span class="built_in">CheckNeedToStop</span>() == <span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">PassDuration += TickInternal * SpeedFactor;</span><br><span class="line"><span class="built_in">OnTick</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><code>Refresh</code>：刷新倒计时时间：</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuff_TimeDuration::Refresh</span><span class="params">(<span class="keyword">float</span> InPassDuration, <span class="keyword">float</span> InTimeDuration)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (InPassDuration &gt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">PassDuration = InPassDuration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (InTimeDuration &gt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">TimeDuration = InTimeDuration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">OnRefresh</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li><code>Pause</code>：根据不同的 <code>Reason</code> 暂停/重启 时间：</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuff_TimeDuration::BeginPauseTime</span><span class="params">(FString Reason)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Owner == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuff_TimeDuration::BeginPauseTime,  UID=%llu, BuffID=%d, TimeDuration=%.2f, bInPause=%d, Reason=%s&quot;</span>),</span><br><span class="line">Owner-&gt;<span class="built_in">GetUID</span>(), BuffID, TimeDuration, bInPause, *Reason);</span><br><span class="line"></span><br><span class="line">PauseReasons.<span class="built_in">AddUnique</span>(Reason);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bInPause == <span class="literal">true</span>) <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">if</span> (PauseReasons.<span class="built_in">Num</span>() &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">bInPause = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">OnBeginPauseTime</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuff_TimeDuration::StopPauseTime</span><span class="params">(FString Reason)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Owner == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuff_TimeDuration::StopPauseTime,  UID=%llu, BuffID=%d, TimeDuration=%.2f, bInPause=%d, Reason=%s&quot;</span>),</span><br><span class="line">Owner-&gt;<span class="built_in">GetUID</span>(), BuffID, TimeDuration, bInPause, *Reason);</span><br><span class="line">PauseReasons.<span class="built_in">Remove</span>(Reason);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bInPause == <span class="literal">false</span>) <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">if</span> (PauseReasons.<span class="built_in">Num</span>() &gt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">bInPause = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">OnStopPauseTime</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li><code>UpdateSpeedFactor</code> ： 更新 <code>Buff</code> 的速度</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameplayBuff_TimeDuration::UpdateSpeedFactor</span><span class="params">(<span class="keyword">float</span> InFactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Owner == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">if</span> (SpeedFactor == InFactor) <span class="keyword">return</span>;</span><br><span class="line">SpeedFactor = InFactor;</span><br><span class="line"><span class="built_in">LogD</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;UGameplayBuff_TimeDuration::UpdateSpeedFactor,  UID=%llu, BuffID=%d, TimeDuration=%.2f, SpeedFactor=%.2f&quot;</span>),</span><br><span class="line">Owner-&gt;<span class="built_in">GetUID</span>(), BuffID, TimeDuration, SpeedFactor);</span><br><span class="line"><span class="built_in">OnUpdateSpeedFactor</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="BuffUtils">BuffUtils</h2><p>暴露给外部系统使用的 <code>Utils</code>，期望外部的调用都从这里走，实际上是一些胶水代码。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">GetBuffID</span><span class="params">( FString BuffName )</span></span>;</span><br><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetBuffName</span><span class="params">( <span class="keyword">int</span> BuffID )</span></span>;</span><br><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">float</span> <span class="title">GetBuffParam</span><span class="params">(FString BuffName, FString ParamName)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">float</span> <span class="title">GetBuffParam</span><span class="params">(<span class="keyword">int</span> BuffID, FString ParamName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="keyword">static</span> TArray&lt;UGameplayBuffBase*&gt; <span class="title">GetGameplayBuff</span><span class="params">(APlayerStateBase* PS, FString BuffName)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> TArray&lt;UGameplayBuffBase*&gt; <span class="title">GetGameplayBuff</span><span class="params">(APlayerStateBase* PS, <span class="keyword">int</span> ID)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line"><span class="function"><span class="keyword">static</span> UGameplayBuffBase* <span class="title">AddGameplayBuff</span><span class="params">(APlayerStateBase* PS, FString BuffName)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> UGameplayBuffBase* <span class="title">AddGameplayBuff</span><span class="params">(APlayerStateBase* PS, <span class="keyword">int</span> BuffID)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> UGameplayBuffBase* <span class="title">AddGameplayBuff</span><span class="params">(APlayerStateBase* PS, FString BuffName, <span class="keyword">const</span> FGameplayBuffParams&amp; Params)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> UGameplayBuffBase* <span class="title">AddGameplayBuff</span><span class="params">(APlayerStateBase* PS, <span class="keyword">int</span> BuffID, <span class="keyword">const</span> FGameplayBuffParams&amp; Params)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bRemoveImmediately = true 可能会导致依赖问题，非必要时序依赖，建议使用 false</span></span><br><span class="line"><span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveGameplayBuff</span><span class="params">(APlayerStateBase* PS, FString BuffName, <span class="keyword">bool</span> bRemoveImediately = <span class="literal">false</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveGameplayBuff</span><span class="params">(APlayerStateBase* PS, FString BuffName, <span class="keyword">bool</span> bRemoveImediately, <span class="keyword">const</span> FGameplayBuffParams&amp; Params)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveGameplayBuff</span><span class="params">(APlayerStateBase* PS, <span class="keyword">int</span> ID, <span class="keyword">bool</span> bRemoveImediately = <span class="literal">false</span>, <span class="keyword">const</span> FGameplayBuffParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveGameplayBuff</span><span class="params">(APlayerStateBase* PS, UGameplayBuffBase* Buff, <span class="keyword">bool</span> bRemoveImediately = <span class="literal">false</span>, <span class="keyword">const</span> FGameplayBuffParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CombineGameplayBuffParams</span><span class="params">(APlayerStateBase* PS, FString BuffName, <span class="keyword">const</span> FGameplayBuffParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CombineGameplayBuffParams</span><span class="params">(APlayerStateBase* PS, <span class="keyword">int</span> ID, <span class="keyword">const</span> FGameplayBuffParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CombineGameplayBuffParams</span><span class="params">(UGameplayBuffBase* Buff, <span class="keyword">const</span> FGameplayBuffParams&amp; Params = &#123;&#125;)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ClearGameplayBuff</span><span class="params">(APlayerStateBase* PS)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">CheckGameplayBuffExist</span><span class="params">(APlayerStateBase* PS, FString BuffName)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">CheckGameplayBuffExist</span><span class="params">(APlayerStateBase* PS, <span class="keyword">int</span> BuffID)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">CheckGameplayBuffHandleExist</span><span class="params">(APlayerStateBase* PS, UGameplayBuffBase* Buff)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="其它信息">其它信息</h2><h3 id="FGameplayBuffParams">FGameplayBuffParams</h3><p><code>Buff</code> 的 <code>Params</code> 部分，实现一个 <code>ValueMap</code> 记录各种类型的参数；</p><p>这样使用的时候就可以这样使用 <code>Params</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 外部调用创建Buff时：</span></span><br><span class="line">UGameplayBuffUtils::<span class="built_in">AddGameplayBuff</span>(Target, BuffID, &#123; &#123;<span class="string">&quot;ParamA&quot;</span>, (<span class="keyword">float</span>)A&#125;, &#123;<span class="string">&quot;ParamsB&quot;</span>, (<span class="keyword">int</span>)B &#125; &#125;);</span><br><span class="line"><span class="comment">// Buff内部 (BuffParams 已经传入 Buff 中)</span></span><br><span class="line"><span class="keyword">float</span> A = BuffParams.GetValue&lt;<span class="keyword">float</span>&gt;(<span class="string">&quot;ParamA&quot;</span>);</span><br><span class="line"><span class="keyword">int</span> B = BuffParams.GetValue&lt;<span class="keyword">int</span>&gt;(<span class="string">&quot;ParamB&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGameplayBuffParams</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">FGameplayBuffParams</span>() = <span class="keyword">default</span>;</span><br><span class="line"><span class="built_in">FGameplayBuffParams</span>(<span class="keyword">const</span> FString&amp; Key, FVariant Value);</span><br><span class="line"><span class="built_in">FGameplayBuffParams</span>(std::initializer_list&lt;TPairInitializer&lt;<span class="keyword">const</span> FString&amp;, FVariant&gt;&gt; ValuePairs);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetValue</span><span class="params">(<span class="keyword">const</span> FString&amp; FieldName, FVariant Value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Contains</span><span class="params">(<span class="keyword">const</span> FString&amp; FieldName)</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsEmpty</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType = <span class="keyword">float</span>&gt; ValueType <span class="built_in">GetValue</span>(<span class="keyword">const</span> FString&amp; FieldName, ValueType Default = &#123;&#125;) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!ValueMap.<span class="built_in">Contains</span>(FieldName)) <span class="keyword">return</span> Default;</span><br><span class="line"><span class="keyword">if</span> (TVariantTraits&lt;ValueType&gt;::<span class="built_in">GetType</span>() != ValueMap[FieldName].<span class="built_in">GetType</span>()) <span class="keyword">return</span> Default;</span><br><span class="line"><span class="keyword">return</span> ValueMap[FieldName].GetValue&lt;ValueType&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">ToString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> TMap&lt;FString, FVariant&gt;&amp; <span class="title">GetValueMap</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">NetSerialize</span><span class="params">(FArchive&amp; Ar, class UPackageMap* Map, <span class="keyword">bool</span>&amp; bOutSuccess)</span></span>;</span><br><span class="line">    </span><br><span class="line">FGameplayBuffParams <span class="keyword">operator</span>+(<span class="keyword">const</span> FGameplayBuffParams&amp; OtherParams);</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Merge</span><span class="params">(<span class="keyword">const</span> FGameplayBuffParams&amp; OtherParams)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">TMap&lt;FString, FVariant&gt; ValueMap;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">FGameplayBuffParams::<span class="built_in">FGameplayBuffParams</span>(<span class="keyword">const</span> FString&amp; Key, FVariant Value)</span><br><span class="line">&#123;</span><br><span class="line">ValueMap.<span class="built_in">Add</span>(Key, Value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FGameplayBuffParams::<span class="built_in">FGameplayBuffParams</span>(std::initializer_list&lt;TPairInitializer&lt;<span class="keyword">const</span> FString&amp;, FVariant&gt;&gt; ValuePairs)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; Pair : ValuePairs)</span><br><span class="line">&#123;</span><br><span class="line">ValueMap.<span class="built_in">Add</span>(Pair.Key, Pair.Value);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FGameplayBuffParams::SetValue</span><span class="params">(<span class="keyword">const</span> FString&amp; FieldName, FVariant Value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">ValueMap.<span class="built_in">Add</span>(FieldName, <span class="built_in">FVariant</span>(Value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FGameplayBuffParams::Contains</span><span class="params">(<span class="keyword">const</span> FString&amp; FieldName)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ValueMap.<span class="built_in">Contains</span>(FieldName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FGameplayBuffParams::IsEmpty</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ValueMap.<span class="built_in">IsEmpty</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">FGameplayBuffParams::ToString</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FString DebugString = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Params:&quot;</span>));</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [Key, Value] : ValueMap)</span><br><span class="line">&#123;</span><br><span class="line">DebugString += FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;[%s=%s]&quot;</span>), *Key, *UStringUtils::<span class="built_in">ToString</span>(Value));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> DebugString;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> TMap&lt;FString, FVariant&gt;&amp; <span class="title">FGameplayBuffParams::GetValueMap</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ValueMap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FGameplayBuffParams::NetSerialize</span><span class="params">(FArchive&amp; Ar, class UPackageMap* Map, <span class="keyword">bool</span>&amp; bOutSuccess)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">bOutSuccess = <span class="literal">true</span>;</span><br><span class="line">Ar &lt;&lt; ValueMap;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FGameplayBuffParams FGameplayBuffParams::<span class="keyword">operator</span>+(<span class="keyword">const</span> FGameplayBuffParams&amp; OtherParams)</span><br><span class="line">&#123;</span><br><span class="line">FGameplayBuffParams CombinedParams = *<span class="keyword">this</span>;</span><br><span class="line">CombinedParams.<span class="built_in">Merge</span>(OtherParams);</span><br><span class="line"><span class="keyword">return</span> CombinedParams;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FGameplayBuffParams::Merge</span><span class="params">(<span class="keyword">const</span> FGameplayBuffParams&amp; OtherParams)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [Key, Value] : OtherParams.<span class="built_in">GetValueMap</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 覆盖</span></span><br><span class="line"><span class="built_in">SetValue</span>(Key, Value);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FGameplayCountDownData">FGameplayCountDownData</h3><p>提供给 <code>UGameplayBuff_TimeDuration</code> 使用，一份记录倒计时的数据</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>()</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGameplayCountDownData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="built_in">GENERATED_USTRUCT_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">FGameplayCountDownData</span>() = <span class="keyword">default</span>;</span><br><span class="line"><span class="built_in">FGameplayCountDownData</span>(<span class="keyword">float</span> StartTime, <span class="keyword">float</span> TotalTime = <span class="number">0.0f</span>, <span class="keyword">float</span> LeftTime = <span class="number">0.0f</span>, <span class="keyword">bool</span> IsPause = <span class="literal">false</span>, <span class="keyword">float</span> SpeedFactor = <span class="number">1.0f</span>)</span><br><span class="line">: <span class="built_in">StartTime</span>(StartTime), <span class="built_in">TotalTime</span>(TotalTime), <span class="built_in">LeftTime</span>(LeftTime), <span class="built_in">IsPause</span>(IsPause), <span class="built_in">SpeedFactor</span>(SpeedFactor)</span><br><span class="line">&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">NetSerialize</span><span class="params">(FArchive&amp; Ar, class UPackageMap* Map, <span class="keyword">bool</span>&amp; bOutSuccess)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Ar &lt;&lt; StartTime;</span><br><span class="line">        Ar &lt;&lt; TotalTime;</span><br><span class="line">        Ar &lt;&lt; LeftTime;</span><br><span class="line">        Ar &lt;&lt; IsPause;</span><br><span class="line">        Ar &lt;&lt; SpeedFactor;</span><br><span class="line"></span><br><span class="line">        bOutSuccess = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> FGameplayCountDownData&amp; Other) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (StartTime != Other.StartTime) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (TotalTime != Other.TotalTime) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (LeftTime != Other.LeftTime) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (IsPause != Other.IsPause) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (SpeedFactor != Other.SpeedFactor) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">operator</span> !=(<span class="keyword">const</span> FGameplayCountDownData&amp; Other) <span class="keyword">const</span> &#123; <span class="keyword">return</span> !(*<span class="keyword">this</span> == Other); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">ToString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line"><span class="keyword">float</span> StartTime = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line"><span class="keyword">float</span> TotalTime = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line"><span class="keyword">float</span> LeftTime = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line"><span class="keyword">bool</span> IsPause = <span class="literal">false</span>;</span><br><span class="line"><span class="built_in">UPROPERTY</span>()</span><br><span class="line"><span class="keyword">float</span> SpeedFactor = <span class="number">1.0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;GameplayBuffSystem框架&lt;/h1&gt;
&lt;h2 id=&quot;设计&quot;&gt;设计&lt;/h2&gt;
&lt;p&gt;首先我们需要一个 &lt;code&gt;BuffManager&lt;/code&gt; ，管理所有的 &lt;code&gt;BuffComponent&lt;/code&gt;。&lt;br&gt;
（实现的时候，可以让 &lt;co</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="Gameplay" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/"/>
    
    
    <category term="Gameplay" scheme="https://www.bearchild.top/tags/Gameplay/"/>
    
    <category term="UE" scheme="https://www.bearchild.top/tags/UE/"/>
    
  </entry>
  
  <entry>
    <title>[UE]GameFeature浅析</title>
    <link href="https://www.bearchild.top/2024/02/22/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]GameFeature%E6%B5%85%E6%9E%90/"/>
    <id>https://www.bearchild.top/2024/02/22/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/[UE]GameFeature%E6%B5%85%E6%9E%90/</id>
    <published>2024-02-21T16:00:00.000Z</published>
    <updated>2024-02-23T16:29:23.492Z</updated>
    
    <content type="html"><![CDATA[<h1>GameFeature浅析</h1><p>一套支持动态增删游戏玩法的框架，往 <code>CoreGame</code> 里 <code>Add/Remove</code> 其它游戏资源/逻辑；</p><p>以 <code>Lyra(UE5.3)</code> 为例，<code>GameFeature</code> 提供了很好的解耦资源/逻辑的方案，可以看出这里的 <code>ShooterCore</code> 被实现为了一个相对比较独立的 <code>Plugin</code>。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202402220044408.png" alt="image-20240220173041938"></p><h2 id="初始化">初始化</h2><p>首先在游戏内，<code>GameFeaturesSubsystem</code> 管理着所有的 <code>GameFeature</code>，看到对应的初始化 <code>UGameFeaturesSubsystem::Initialize</code>，可以分为几步：</p><blockquote><ol><li><p>加载<code>Policy</code>：根据 <code>GameFeaturesSubsystemSettings-&gt;GameFeaturesManagerClassName</code> 加载对应的 <code>GameSpecificPolicies</code></p></li><li><p>注册资源回调：<code>UAssetManager::CallOrRegister_OnAssetManagerCreated</code></p></li><li><p>注册 <code>ConsoleCommand</code> 方便 <code>Debug</code></p></li></ol></blockquote><p>在资源加载完的回调后，会走到 <code>UGameFeaturesSubsystem::OnAssetManagerCreated</code>，进行 <code>GameSpecificPolicies-&gt;InitGameFeatureManager</code>，根据 <code>Policies</code> 执行初始化逻辑；</p><p>这里的 <code>GameFeaturesProjectPolicies</code> 决定了一些 <code>GameFeaturePlugin</code> 的加载规则，比如需要在什么地方<code>(Server/Client)</code> 加载什么 <code>GameFeature</code>，同时可以在这里的 <code>Init</code> 扩展需要的额外功能，比如注册一些 <code>Observers</code>、<code>Subsystems</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">InitGameFeatureManager</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ShutdownGameFeatureManager</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> TArray&lt;FPrimaryAssetId&gt; <span class="title">GetPreloadAssetListForGameFeature</span><span class="params">(<span class="keyword">const</span> UGameFeatureData* GameFeatureToLoad, <span class="keyword">bool</span> bIncludeLoadedAssets = <span class="literal">false</span>)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsPluginAllowed</span><span class="params">(<span class="keyword">const</span> FString&amp; PluginURL)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> TArray&lt;FName&gt; <span class="title">GetPreloadBundleStateForGameFeature</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetGameFeatureLoadingMode</span><span class="params">(<span class="keyword">bool</span>&amp; bLoadClientData, <span class="keyword">bool</span>&amp; bLoadServerData)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br></pre></td></tr></table></figure><p>在 <code>UDefaultGameFeaturesProjectPolicies::InitGameFeatureManager</code>  中会执行 <code>UGameFeaturesSubsystem::Get().LoadBuiltInGameFeaturePlugins(AdditionalFilter)</code>，根据 <code>Filter</code> 来加载 <code>GameFeaturePlugin</code>，可以发现，会进行状态机 <code>GameFeaturePluginStateMachine</code> 的初始状态设置并初始化。</p><p>状态机的底层的数据都存在 <code>GameFeatureData</code> 上，可以从这里面开始分析：</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202402220044305.png" alt="image-20240220173210508" style="zoom: 33%;" /><p>（需要注意的是，<code>GameFeatureData</code> 本身只记录了 <code>Actions</code> 和 <code>PrimaryAssetTypesToScan</code>，这里的 <code>FeatureState</code> 对应的是 <code>GameFeaturePlugin</code> 的对应状态机的信息，由 <code>FGameFeaturesEditorModule::StartModule -&gt; FGameFeatureDataDetailsCustomization::CustomizeDetails</code> 注册进 <code>Details</code> 面板）</p><h2 id="状态机">状态机</h2><p><code>GameFeature</code> 由一个 <code>UGameFeaturesSubsystem : UEngineSubsystem</code> 管理其生命周期：</p><pre class="mermaid">classDiagram    class UGameFeaturesSubsystem {        GameFeaturePluginStateMachines : TMap[GameFeature, StateMachine]         ListGameFeaturePlugins()        LoadGameFeaturePlugin()        DeactivateGameFeaturePlugin()        UnloadGameFeaturePlugin()        ReleaseGameFeaturePlugin()        UninstallGameFeaturePlugin()        TerminateGameFeaturePlugin()    }        UGameFeaturesSubsystem..>UGameFeaturePluginStateMachineclass UGameFeaturePluginStateMachine {        AllStates : TUniquePtr[FGameFeaturePluginState]         CurrentStateInfo : FGameFeaturePluginStateInfo        SetDestination()    }        UGameFeaturePluginStateMachine..>FGameFeaturePluginStateclass FGameFeaturePluginState {        TickHandle : FTSTicker-FDelegateHandle         BeginState()        UpdateState()        TryCancelState()        EndState()    }        UGameFeaturePluginStateMachine..>FGameFeaturePluginStateInfoclass FGameFeaturePluginStateInfo {    State : EGameFeaturePluginState    }</pre><p>最基本的有 <code>Load</code>、<code>Deactivate</code>、<code>Unload</code>、<code>Release</code>、<code>Uninstall</code>、<code>Terminate</code> 几个功能，可以由外部调用。</p><p>核心内容围绕着每个 <code>GameFeaturePlugin</code> 对应的 <code>StateMachine</code> 展开；<code>GameFeatureSubSystem</code> 上记录着 <code>TMap&lt;FString, TObjectPtr&lt;UGameFeaturePluginStateMachine&gt;&gt; GameFeaturePluginStateMachines </code> ，也就是  <code>PluginIdentifier-&gt;StateMachine</code> 的多个映射。</p><p>最后都会走到 <code>UGameFeaturesSubsystem::ChangeGameFeatureDestination</code> 修改状态机的状态：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChangeGameFeatureDestination</span><span class="params">(UGameFeaturePluginStateMachine* Machine, <span class="keyword">const</span> FGameFeaturePluginStateRange&amp; StateRange, FGameFeaturePluginChangeStateComplete CompleteDelegate)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 暴露给外部的主要目标状态</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">EGameFeatureTargetState</span> :</span> uint8</span><br><span class="line">&#123;</span><br><span class="line">Installed,</span><br><span class="line">Registered,</span><br><span class="line">Loaded,</span><br><span class="line">Active,</span><br><span class="line"><span class="function">Count<span class="title">UMETA</span><span class="params">(Hidden)</span></span></span><br><span class="line"><span class="function">&#125;</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ChangeGameFeatureTargetState</span><span class="params">(<span class="keyword">const</span> FString&amp; PluginURL, EGameFeatureTargetState TargetState, <span class="keyword">const</span> FGameFeaturePluginChangeStateComplete&amp; CompleteDelegate)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="GameFeaturePluginStateMachine"><code>GameFeaturePluginStateMachine</code></h3><p>主要维护对应 <code>GameFeaturePlugin</code> 的状态。</p><p>最重要的设置状态入口是 <code>UGameFeaturePluginStateMachine::SetDestination</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UE5.0: 传入的目标状态为一个 GameFeaturePluginState</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UGameFeaturePluginStateMachine::SetDestinationState</span><span class="params">(EGameFeaturePluginState InDestinationState, FGameFeatureStateTransitionComplete OnFeatureStateTransitionComplete)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">check</span>(<span class="built_in">IsValidDestinationState</span>(InDestinationState));</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> If we aren&#x27;t in a destination state and our new destination is in the opposite direction of </span></span><br><span class="line"><span class="comment">// our current destination, cancel the current state transition (if possible)</span></span><br><span class="line"><span class="comment">// The completion delegate may be stomped in these cases.  Should probably callback with a cancelled error</span></span><br><span class="line"></span><br><span class="line">StateProperties.DestinationState = InDestinationState;</span><br><span class="line">StateProperties.OnFeatureStateTransitionComplete = OnFeatureStateTransitionComplete;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UpdateStateMachine</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UE5.1-5.3：将传入的状态改为了一个 FGameFeaturePluginStateRange(MinState, MaxState)</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UGameFeaturePluginStateMachine::SetDestination</span><span class="params">(FGameFeaturePluginStateRange InDestination, FGameFeatureStateTransitionComplete OnFeatureStateTransitionComplete, FDelegateHandle* OutCallbackHandle <span class="comment">/*= nullptr*/</span>)</span></span></span><br></pre></td></tr></table></figure><p>可以发现 <code>StateMachine</code> 维护了一个 <code>FGameFeaturePluginStateMachineProperties&amp; StateProperties</code>，记录了状态机运行中可以切换到的状态的一些属性，其中的 <code>DestinationState</code> 表示在状态变化中期望到达的状态（<code>UE5.3</code> 改为了状态区间，为了适配 <code>Terminal</code> 以及状态转移中不丢失对应的 <code>CompletionHandle</code>）</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 当前状态是否不在 Destination 内，不在的话说明需要尝试到一个新的 Destination，标记为 IsRunning */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsRunning</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> !StateProperties.Destination.<span class="built_in">Contains</span>(CurrentStateInfo.State);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 已经在 Destination 内，那么可以尝试到任意的 Destination</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">IsRunning</span>())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (InDestination.<span class="built_in">Contains</span>(CurrentStateInfo.State)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    StateProperties.Destination = InDestination;</span><br><span class="line">    <span class="built_in">UpdateStateMachine</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不在 Destination 内，说明状态还在过渡状态，这时如果收到了新的 Destination，为了保证原有状态可以顺利过渡，与原有的 Destination 求交，继续尝试切换状态</span></span><br><span class="line"><span class="keyword">if</span> (TOptional&lt;FGameFeaturePluginStateRange&gt; NewDestination = StateProperties.Destination.<span class="built_in">Intersect</span>(InDestination))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// The machine is already running so we can only transition to this range if it overlaps with our current range.</span></span><br><span class="line">    <span class="comment">// We can satisfy both ranges in this case.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CurrentStateInfo.State &lt; StateProperties.Destination)</span><br><span class="line">    &#123;</span><br><span class="line">        StateProperties.Destination = *NewDestination;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (InDestination.<span class="built_in">Contains</span>(CurrentStateInfo.State)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(CurrentStateInfo.State &gt; StateProperties.Destination)</span><br><span class="line">    &#123;</span><br><span class="line">        StateProperties.Destination = *NewDestination;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (InDestination.<span class="built_in">Contains</span>(CurrentStateInfo.State)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="FeaturePluginState"><code>FeaturePluginState</code></h4><p>内部维护了很多状态：</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202402220044382.png" alt="image-20240221105036685"></p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202402220044864.png" alt="image-20240220225411173" style="zoom:33%;" /><p>可以被作为<code>DestinationState</code>的状态有：<code>UnknownStatus</code>、<code>Uninstalled</code>、<code>StatusKnown</code>、<code>Installed</code>、<code>Registered</code>、<code>Load</code>、<code>Active</code>、<code>Terminal</code>、其它<code>ErrorStates</code>。</p><p>状态间的关系如图所示：</p><pre class="mermaid">flowchart LRUninitialized-->*UnknownStatus*UnknownStatus-->CheckingStatus*UnknownStatus-->*TerminalCheckingStatus-->*StatusKnown*StatusKnown-->*Installed*StatusKnown-->Downloading*StatusKnown-->Uninstalling*StatusKnown-->*TerminalDownloading-->*InstalledUninstalling-->*Uninstalled*Uninstalled-->*Terminal*Uninstalled-->CheckingStatusReleasing-->*StatusKnown*Installed-->Mounting*Installed-->ReleasingMounting-->WaitingForDependenciesUnmounting-->*InstalledWaitingForDependencies-->RegisteringRegistering-->*Registered*Registered-->Unregistering*Registered-->LoadingUnregistering-->UnmountingLoading-->*Loaded*Loaded-->Activating*Loaded-->UnloadingUnloading-->*RegisteredActivating-->*Active*Active-->DeactivatingDeactivating-->*Loaded</pre><p>状态修改完会通过<code>UGameFeaturesSubsystem::Get().OnGameFeature...</code> 进行通知，<code>GameFeatureSubSystem</code> 会调用到 <code>Actions</code> 的回调，同时提供了一个 <code>CallbackObservers</code> 通知已注册的 <code>Observers</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">EObserverCallback</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    CheckingStatus,</span><br><span class="line">    Terminating,</span><br><span class="line">    Registering,</span><br><span class="line">    Unregistering,</span><br><span class="line">    Loading,</span><br><span class="line">    Activating,</span><br><span class="line">    Deactivating,</span><br><span class="line">    PauseChanged,</span><br><span class="line">    Count</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="Actions">Actions</h2><p>对于一个 <code>GameFeature</code> ，在 <code>Register</code>、<code>Unregister</code>、<code>Load</code>、<code>Activate</code>、<code>Deactive</code> 等行为时（也可以自己添加）会调用到 <code>GameFeatureData</code> 上配置的 <code>Actions</code> 的对应回调：</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202402220044126.png" alt="image-20240221155727741" style="zoom: 40%;" /><img src="E:\Pictures\_data\image-20240221155957459.png" alt="image-20240221155957459" style="zoom:50%;" /><p>可以自定义各种各样的 <code>Actions</code>：</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202402220044309.png" alt="image-20240221155442578" style="zoom: 67%;" /><p><code>GameFeatureAction</code> 中有一个关键 <code>UGameFeatureAction_AddComponents</code> ，其主要是将 <code>Component</code> 注册进对应的 <code>Actor</code>，应用到了另一个模块 <code>ModularGameplay</code>。</p><p><code>AddComponent</code> 通过 <code>ModularGameplay</code> 的 <code>UGameFrameworkComponentManager::AddComponentRequest</code> 实现，简单介绍一下 <code>ModularGameplay</code> ：</p><h3 id="ModularGameplay">ModularGameplay</h3><p>一套往 <code>Actor</code> 上注册 <code>Component/ExtensionHandler</code> 的解决方案。</p><p>这套框架核心由一个 <code>UGameFrameworkComponentManager : USubSystem</code> 在全局管理各个 <code>ActorClass</code> 的 <code>Component/ExtensionHandler</code>，维护 <code>Component</code> 的生命周期，并且提供接口供外部调用（<code>Add/Remove/SendEvent</code> 等）</p><h4 id="ActorReceiver"><code>ActorReceiver</code></h4><h5 id="注册-Receiver">注册 <code>Receiver</code></h5><p>首先将需要使用这套框架维护 <code>Component</code> 的 <code>ActorClass</code> 作为 <code>Receiver</code> ，通过 <code>UGameFrameworkComponentManager::AddGameFrameworkComponentReceiver</code> 注册进 <code>Manager</code>；</p><p>同时，在注册的时候，会判断 <code>ActorClass</code> 是否已经提前注册的 <code>ComponentClass</code> 或者 <code>EventDelegate</code> ，如果有 <code>ComponentClass</code> 则会在此时创建对应实例 <code>CreateComponentOnInstance</code>，有 <code>EventDelagte</code> 则会通知一下 <code>NAME_ReceiverAdded</code>。</p><p>（一般在 <code>AActor::PreInitializeComponents</code> 调用）</p><h5 id="移除-Receiver">移除 <code>Receiver</code></h5><p>通过  <code>UGameFrameworkComponentManager::RemoveGameFrameworkComponentReceiver</code> 移除；</p><p>调用对应 <code>Component</code> 的销毁，通知一下 <code>NAME_ReceiverRemoved</code>。</p><p>（一般在 <code>AActor::EndPlay</code> 调用）</p><h4 id="Component"><code>Component</code></h4><pre class="mermaid">classDiagram    class UGameFrameworkComponentManager     UGameFrameworkComponentManager  : ReceiverClassToComponentClassMap    UGameFrameworkComponentManager : AddComponentRequest()    UGameFrameworkComponentManager : RemoveComponentRequest()</pre><p>维护了一个 <code>ActorClass-&gt;ComponentClass</code>  ，也就是 <code>TMap&lt;FComponentRequestReceiverClassPath, TSet&lt;TObjectPtr&lt;UClass&gt;&gt;&gt; ReceiverClassToComponentClassMap</code>，（其中 <code>FComponentRequestReceiverClassPath</code> 是一个结构体，用字符串数组记录 <code>Class-&gt;Root</code> 这条链路，作为 <code>Class</code> 的标识，不直接用 <code>UClass</code> 是因为以 <code>Component</code> 的视角进行操作，不期望在这里直接依赖 <code>Receiver</code> 对应模块的指针）</p><h5 id="注册-Component">注册 <code>Component</code></h5><p>通过 <code>UGameFrameworkComponentManager::AddComponentRequest</code> 实现；</p><p>这里的 <code>CompoentRequest</code> 也就是一个 <code> FComponentRequestHandle(OwningManager, ReceiverClass, ComponentClass)</code>；</p><p>内部维护了一个 <code>RequestTrackingMap</code> 用于 <code>CompoentRequest</code> 的计数，如果 <code>==1</code> 则说明需要尝试创建实例；</p><p>（有可能不同的模块都依赖对应的 <code>ComponentClass</code> ，所以需要计数一下）</p><p>注册的时候判断对应的 <code>Actor</code> 是否已经 <code>Initialize</code> ，如果是，则 <code>CreateComponentOnInstance</code>。</p><p><code>CreateComponentOnInstance</code>：创建 <code>ComponentInstance</code> ，维护 <code>TMap&lt;UClass*, TSet&lt;FObjectKey&gt;&gt; ComponentClassToComponentInstanceMap</code> 用于记录这个 <code>ComponentClass</code> 有哪些对应的 <code>Instance</code></p><h5 id="移除-Component">移除 <code>Component</code></h5><p>通过 <code>UGameFrameworkComponentManager::RemoveComponentRequest</code> 实现；</p><p>修改计数，<code>==0</code> 则执行销毁。</p><p>销毁的时候通过 <code>ComponentClassToComponentInstanceMap</code> 找到所有的 <code>Component</code>，判断对应的 <code>Actor</code> 是否是期望的，如果是，则销毁；</p><h4 id="ExtensionHandler"><code>ExtensionHandler</code></h4><p>和 <code>Component</code> 类似，也就是注册 <code>Event</code> 的部分；</p><pre class="mermaid">classDiagram    class UGameFrameworkComponentManager UGameFrameworkComponentManager  : ReceiverClassToEventMap    UGameFrameworkComponentManager : AddExtensionHandler()    UGameFrameworkComponentManager : RemoveExtensionHandler()    UGameFrameworkComponentManager : SendExtensionEvent()</pre><h2 id="资源加载">资源加载</h2><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202402220044399.png" alt="image-20240221163647066" style="zoom:40%;" /><p>在 <code>FGameFeaturePluginState_Registering</code> 状态时，会根据配置的 <code>GameFeatureToAdd-&gt;GetPrimaryAssetTypesToScan()</code>，执行对应的 <code>UGameFeaturesSubsystem::AddGameFeatureToAssetManager</code>，进行资源是否存在等判定之后，尝试加载资源到 <code>AssetManager</code>。</p><p>类似的，在 <code>FGameFeaturePluginState_Unregistering</code> 状态时，通过 <code>UGameFeaturesSubsystem::RemoveGameFeatureFromAssetManager</code> 进行资源卸载。</p><h2 id="参考">参考</h2><p><code>Lyra (UE5.0-5.3) GameFeature 部分源码</code></p><p><a href="https://imzlp.com/posts/17658/">UE5：Game Feature 预研</a></p><p><a href="https://zhuanlan.zhihu.com/p/467236675">《InsideUE5》GameFeatures架构</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;GameFeature浅析&lt;/h1&gt;
&lt;p&gt;一套支持动态增删游戏玩法的框架，往 &lt;code&gt;CoreGame&lt;/code&gt; 里 &lt;code&gt;Add/Remove&lt;/code&gt; 其它游戏资源/逻辑；&lt;/p&gt;
&lt;p&gt;以 &lt;code&gt;Lyra(UE5.3)&lt;/code&gt; 为例，</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="Gameplay" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/"/>
    
    
    <category term="Gameplay" scheme="https://www.bearchild.top/tags/Gameplay/"/>
    
    <category term="UE" scheme="https://www.bearchild.top/tags/UE/"/>
    
  </entry>
  
  <entry>
    <title>2023 年度总结</title>
    <link href="https://www.bearchild.top/2023/12/31/%E6%97%A5%E5%BF%97/2023%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/"/>
    <id>https://www.bearchild.top/2023/12/31/%E6%97%A5%E5%BF%97/2023%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/</id>
    <published>2023-12-31T15:59:59.000Z</published>
    <updated>2024-01-20T13:50:34.794Z</updated>
    
    <content type="html"><![CDATA[<h1>2023 年度总结</h1><h2 id="一月">一月</h2><p>今年的记忆，从跨年和家人一起在海边放烟花开始，绚烂而又短暂的烟花就好像今年的故事一样，美好也夹杂着一些可惜。</p><p>一月底，随着网易和暴雪的合同到期，国内暴雪的时代正式结束了，好像人生一样，总是一次又一次的离别。看到了 link 发的回忆录，上面写着他的游戏策划之路从 War3 的疾风忍法帖地图开始，就好像我当初也玩 OW 玩到入迷。</p><p>虽然游戏不在了，但游戏带来的朋友，对人的影响却不会消失。好的游戏真的可以改变一个人一生的轨迹。</p><p>同时也更加坚定了自己对游戏行业的看法，游戏行业从业者，不单单只是从业者，更是热爱者、逐梦者，是一个 <strong>浪漫</strong> 的职业。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310430755.png" alt="image-20231231042955369"></p><h2 id="二月-三月">二月~三月</h2><p>在工作中沉沦，写了 Gameplay经分框架、接了卡车玩法，优化了 DisplayInfoSystem。各种业务框架、性能优化、代码重构…… 日子一天天过去。为了出包、Showcase 更是一次又一次的爆肝。</p><p>但哪怕如此，最高通缉第一次 CE 测，也还是被喷烂了，玩家表示甚至不知道要进去要干啥，又感觉自己的辛苦毫无意义，这一切会不会是在感动自己呢？</p><blockquote><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310430257.png" alt="image-20231231032512777" style="zoom: 50%;" /></blockquote><p>那天晚上，一个人坐在人才公园的岸边发呆了两个小时。左边是体育中心演唱会有人正在高歌，右边是高楼的霓虹与起重机正在工作的轰鸣。身前有虫鸣和偶尔鱼儿跳出浅滩的声音，身后是光污染的写字楼高不见顶。</p><p>这座城市好吵，我好像与这里格格不入。这 <strong>混沌而复杂</strong> 的城市，<strong>迷幻与孤独</strong> 好像淹没了我。</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310430492.png" alt="image-20231231013616851" style="zoom: 50%;" /><p>不过幸好，这段时间煦哥也来深圳实习了，我们经常一起出去恰大排档吃宵夜，讨论着当下的困境与迷茫、矛盾和艰难，也畅谈人生和理想、目标和未来。</p><p>同时，这段时间还认识了一个很活泼的女孩子，给当时的我带来了很多鼓励，她真的好爱说话好有分享的欲望，对生活充满了 <strong>乐观和希望</strong> ，令人不禁感慨，世界上还有这样元气的人。</p><p>可惜的是，不知道为什么，我有点不敢直视这种阳光，光明虽然可以带来 <strong>温暖</strong>，但有时也太过刺眼 。</p><p>我们曾相约看过一次电影，电影过后，深夜十二点，我一个人撑着伞在深圳的街头漫步和思考，或许这才是我的人生？好像失去了爱人的能力，习惯了孤独，接受并且开始享受孤独，又或许这只是面对孤独时只能无奈接受的借口吧。</p><p>电影里那样 <em>“只要有你在的话”</em> 的爱情，可望不可及，令人羡慕的同时，也有点让人心生恐慌。</p><h2 id="四月-五月">四月~五月</h2><p>哪怕小规模 CE 测试的评价不好，但路还是要走的，大家继续接着努力不断优化。经常晚上聊项目、未来、痛点，又或者是一起写代码调配置。哪怕到深夜两三点下班，也还是会发现有同事还在工位。</p><p>大家或许已经不止是同事，更接近一起努力的 <strong>战友</strong> 吧。虽然身体很累，但做游戏还是很快乐的。</p><p>在这样的强度下，也逐渐成长了起来。大版本要做组队的时候，一天就拿下了组队系统的基本框架。又写了气势、暴露，负责了各种各样的机制与系统。</p><p>虽然现在来看，已经有很多功能废弃了，当初的技术框架也很稚嫩，现在远可以做得更好，但是在当时还是很有成就感的。果然，成长悄无声息，只有回过头来才能发现自己原来还是走了很远。</p><p>最高通缉 也为了上线改名为 <strong>热力追踪</strong>，幸运的是，beta1测的数据还不错，这也是在黑暗前行之中一点小小的光芒。</p><p>五一也和游戏研发同好会的兄弟们一起在科韵路大聚会了几天，有志同道合的人一起真是一件幸运的事情。离开的那个晚上，和白狼他们一起坐在广州街头的路边，聊了一两个小时，聊着游戏、感情、还有各自的未来，这种慢悠悠的生活真是太好了，至今也难以忘怀。</p><p>也玩了几款新游戏，看了看漫展，毕业论文也准备就绪了，一切都在向前。</p><h2 id="六月">六月</h2><p>又是一年毕业季，返校准备毕业答辩和相关事宜，最后一段在学校的时光了。</p><p>短短一周的回归。到学校和朋友们一起爽恰了火锅烧烤，哪怕是在毕业答辩的前一天晚上，深夜也一起聊人生到三点多。大家都在享受最后的 <strong>狂欢</strong>。最后一次吃一食堂的黄焖鸡，最后一次去熙街的山水溶洞，最后一次恰校外的新疆烧烤，最后一次在操场上跑步，最后一次走进一教进行答辩……</p><p>在校园的这最后一段时间，也第一次（或许也是最后一次）和认识了两年的一个校园异性朋友出去玩，可惜我们之间的故事还没有开始就结束了，很可惜却也还是很开心，还是很感谢当时在网络上的陪伴和鼓励。</p><p>也许还是虚拟的世界更好，一切都可以用机器码精确阐述，如果爱情像写代码那么简单就好了。不过这样的结束也是好事，给这段校园经历画上一个 <strong>完美的句号</strong>。</p><p>回过头来才发现，因为早早就出去实习，自己的校园生活太过短暂实在有点可惜，感觉毕业来得太过突然。但哪怕如此，却还是有很多值得记忆一辈子的人和事，<strong>刻骨铭心</strong>。</p><p><em>“何当共剪西窗烛，却话巴山夜雨时”。</em></p><p>感慨错过的同时，也还是得继续向前，迎接又或是回归新的生活。重庆是原来这么美啊！</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310430398.png" alt="image-20231231013358987" style="zoom: 67%;" /><p>在一周后的某个深夜，伴着星光点点，我又回到了深圳，回到了熟悉的每天开发游戏的日子。每天加班，偶尔加完班大家一起出去恰烧烤。</p><p>期间迎来了一次新的 Showcase，被疯狂拷打麻了。不过这次法爷看大家情绪负面。站了出来，让大家不要慌张、不要沮丧。</p><blockquote><p>后续调整的方向相对明确，所差的是验证成本，结合从整体客户端团队的开发效率和交付质量上看，开发、策划团队的 <strong>战斗力顶级</strong> ，有足够的能力应对可能的变更，所以能打磨好；</p><p>相信一点，没有谁能一次性的给出完美的解决方案，我们要作为一个团队群力群策，从策划案的源头（需求沟通）到过程中的考量（开发中的思考）集思广益，奔着阶段性战略，我们的天花板是可触达的；</p><p>最高通缉是我们的天花板，QQ飞车是地板，地板的战绩是明确的，天花板能撑到什么样看策划的想象、开发的收敛和一起的打磨；</p><p>和这么多优秀的同事合作，多看齐大家的优点补齐自己的短板，<strong>Happy做事快乐生活</strong>，上线后给赛车品类一点小小的<strong>震撼</strong>。</p></blockquote><p>在这样的鼓励下，或许还是有迷茫和无奈，但大家也重拾信心，继续向前。</p><p>某个晚上久违地通宵看完了《跃动青春》，不知道有多久没有看番到天亮了，简单而又纯粹的快乐。</p><blockquote><p>人生就是一场为了寻找自己喜欢的人和事的旅行。</p></blockquote><p>有勇气 <strong>追逐梦想</strong> 的人真是耀眼。大家都有各自青春的回忆与故事，或悲伤或美好。各怀心绪，<strong>光彩熠熠</strong>。</p><p>最高通缉也是这样一个梦想，我们总是在被质疑、被挑战、被拷打，<strong>但我们始终坚持走在路上</strong>。</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310430024.png" alt="image-20231231015112457" style="zoom: 50%;" /><h2 id="七月-八月">七月~八月</h2><p>继续奋战。加班到深夜早就已经是常事，不过搞各种新需求的同时，偶尔还会和 宇健、超哥、法爷 一起出去恰烧烤火锅。辛苦也带着甜蜜。</p><p>期间还经历了一次封培开始，结果恰巧项目有重大改动，需要添加关键的搜索态，走不开身，法爷直接亲自帮我写封培延期申请，好家伙。在这样辛苦的日子里，即将迎来 beta2测。出版本前一周，每天晚上都和老铁、球哥他们一起调各种配置到两三点，大家经常点宵夜来工位一起爆肝。</p><blockquote><p>深圳很大，看不清云雾里的大厦。海岸城总有人纸醉金迷夜夜笙歌。</p><p>深圳很小，迷失在城中村的小巷。科技园总有人精疲力竭通宵达旦。</p></blockquote><p>正式 beta2测，10w+规模测试，可惜这是一次 <strong>至暗时刻</strong> ！首日、充值、匹配、性能、断线重连、语音、组队、网络 各个模块出现了各种各样的问题，实在令人惋惜。</p><blockquote><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310430676.png" alt="image-20231231032405922" style="zoom:33%;" /></blockquote><p>在各种问题的叠加下，这次测试的数据比上一次全线下降了将近 10%，不过令人感慨的是，热力追踪居然没有什么下滑，在所有的玩法中表现最好，甚至超过了竞速赛，努力是有回报的。</p><p>不过项目组是一个整体，除了一部分人的努力以外，整体太让人太失望了。</p><p>再一次陷入了迷茫，也意识到了，有的人是满怀热爱来做游戏的，有的人不过是来上班的而已，这就是 <strong>现实</strong>。</p><blockquote><p>很喜欢马宝的一句话：</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202401202149649.png" alt="image-20240120214922209" style="zoom:50%;" /></blockquote><h2 id="九月">九月</h2><p>在台风里开启了九月，这场台风就像项目组此时面临的风暴一样。幸运的是，台风总会过去，团队里也不都是混子，优秀的团队总是不乏能人志士。伴随着美术狠狠冲刺，渲染优化支持，整个游戏的美术质量肉眼可见地在提升。</p><p>热力追踪也在不断优化，偶尔也会一边喝酒一边写代码到天亮，大家一起喝酒解压。</p><p>在迷茫的日子里，有一天酒后早醒，恰逢天亮，看到了美丽的风景。</p><p><em>“曦日分昏晓，凌云任风飘”</em>，或许也预示着之后咱们游戏会迎来那道晨曦曙光。</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310430500.png" alt="image-20231231023237399" style="zoom: 25%;" /><p>在国庆节前夕，策划意识到了撤离玩法需要大改，开了个大会议，一看全是我的功能，doctor 在会议室里狠狠打画饼，<em>“此时就像创业最后一搏，现在不冲更待何时”</em>，确实给我打满了鸡血。</p><p>于是国庆节前大家一起狠狠加班了一波。中秋的晚上，在公司干到了晚上十一点，终于把 PeakMomentSystem 写完了。最后一天加班结束前，也和兄弟们一起恰了一波铁板烧，迎接国庆假期。</p><p>或许总是一个人在加班写代码，但不只是一个人在做游戏。</p><h2 id="十月-十一月">十月~十一月</h2><p>在修bug期的空闲时间，补了很多当时没看的好番。</p><blockquote><p>《路人女主的养成办法》</p><p>“时而一起胡闹，时而遇到挫折，时而大声欢笑，时而产生分歧，时而握手言和，时而互相争吵……还发生了其它许许多多的事……这么一个一起实现梦想的故事” 真是令人感慨。</p><p>“不是为了多数玩家，而是为了唯一一个人的，我成为只属于你的第一女主角了吗？”</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310439122.png" alt="image-20231231043906999" style="zoom: 33%;" /></blockquote><p>回过头看，满是追寻梦想的路上的热忱和希望。各种各样的经历，每一段故事，波澜又或平淡，悲伤或是欢喜，都是成长路上最好的奖励。</p><blockquote><p>《中二病也要谈恋爱！》</p><p>“人们有时会说胡话，幻想世界会在瞬间变化，想象遥远的未来，在脑中描绘一场轰轰烈烈的恋爱，这些都是人在一生中永远重复着，永无止境地重复，悲伤，害羞，却又可爱，名为 ‘自我意识过剩’ 的疾病，名为 ‘自己’ 的不可绕行之路。没错，人一辈子都活在中二病里。 ”</p><p>“爆裂吧，现实！断裂吧，神经！放逐这个世界！“</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310430018.png" alt="image-20231231033936329" style="zoom:33%;" /></blockquote><p>愿你走出半生，归来仍是少年。</p><blockquote><p>《樱花庄的宠物女孩》</p><p>“无论自己多么努力也有无法改变的东西。”</p><p>“只要是认真思考过自己到底想要怎么做之后得出的结论就行了。”</p><p>樱花庄就是因为大家都在才是樱花庄！</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310433857.png" alt="image-20231231043211405" style="zoom: 33%;" /></blockquote><p>人生就是这样分分合合有喜有悲不断成长，想要获得美好的结局，需要有永远在一起的觉悟。</p><p>……</p><p>每个人物，都在自己的故事里迈出一步又一步，在灿烂宏大而青涩的青春里，释放着自己的光芒。</p><p>二次元也给了我莫大的勇气和鼓励，就像路人女主和16bit的感动里那样，又一次爱上了和大家一起做游戏的日子。</p><blockquote><p>能够找到热爱之事并为之奋斗，<br>本身就是命中注定极大的幸运。<br>波澜或是平淡，欢笑又或泪水，<br>追梦路上总是满怀热忱和希望。<br>迷失了所寻梦想和热爱的人生，<br>或许早就已经可以称之为死去。</p></blockquote><p>不过人生总是有喜有悲，在一个情绪爆发的夜晚，在莫名的思绪下，结合着酒精的作用，有点幼稚地向一个在网上交流了一年多的女孩子表达了心意，其实自己也知道结局早已注定，也算是借此斩断了这段虚空的情缘。虽然在那之后至今没有联系，不过哪怕如此，也还是很感谢那些曾经深夜一起交流游戏分享生活、满怀欣喜聊着未来的时光。</p><blockquote><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310430686.png" alt="image-20231231040016305" style="zoom: 67%;" /></blockquote><p>在这样平淡也复杂的日子里，迎来了游戏的 beta3 测。</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310430767.png" alt="image-20231231031125877" style="zoom: 80%;" /><h2 id="十二月">十二月</h2><p>丰收的一个月。</p><p>先令人惊喜的是，这次 beta3测 数据异常的好，远超 beta2测，甚至比已经数据很棒的 beta1测 更好。不过细细想来，这可能也是我们如此付出理应得到的回报，大家也一起久违开心地团建了一次。</p><p>一次偶然看到了公众号上的宣传标语，发现宣传语里重点突出的 “公敌对决、撤离玩法、搜索功能”，基本全是我的身影。回过头来看，原来热力追踪的这么多功能都是我在负责了。在持续的高强度作战中，自己正在逐渐变成更厉害的 Gameplay 开发者。</p><p>项目组里也加入了更多的新人，偶尔也会讨论技术到凌晨一两点。也新接了龙卷风、雷达卡车，更多新的机制和玩法。自己买了一个多功能锅，偶尔也煎一下小烧烤，恰一顿小火锅，生活自得其乐。</p><p>同时，迎来了 A-SOUL 的三周年纪念日。</p><p>时间过得真快啊，转眼就已经过去了三年。回想起当初在学校宿舍里看到 A-SOUL 的那一天，真是梦开始的地方。后面一个人出去实习，一个人来深圳，A-SOUL 陪伴我度过了那么多困难的时光，也发现原来我已经走了这么远了。</p><p>经历了各种各样的事，认识了各种各样的人，有遗憾也有快乐，有错过也有欣喜，A-SOUL 始终都在那陪伴着我，然然的那一句 <em>“大家要好好吃饭，每天都要开开心心的！”</em>，简短的话语，让人感受到无尽的温暖的力量。</p><blockquote><p>初见惊羡，再见沉沦。</p><p>“抵达” 是一种勇敢，但 “我在” 才是温暖。</p><p>“头顶苍穹，总有星辰为我而闪烁，穿过亿万光年，热爱无畏时空。”</p><p>“心怀远方，总有理想为我而呐喊，越过流言汹涌，信仰生生不息。”</p><p>过往皆为篇章，未来海阔天空，希望这个故事还有很长很长……</p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310430457.png" alt="image-20231231034527582" style="zoom: 50%;" /></blockquote><p>在年末的最后一天工作日，和朋友们一起出去恰了一顿鸡煲，结束了这相对圆满的一年。</p><h2 id="总结">总结</h2><p>今年走到了大学毕业的关键节点，也经历了几次项目大规模测试，体验了些许暧昧的感情，人生也在徐徐发展。</p><p>认识了很多人，经历了很多事。可能一次偶然的相遇，一个不经意的回眸，两个素未谋面之人就会迸发数不尽的精彩故事。正如这个世界，千变万化，扩展着 <strong>无限的可能性</strong>。</p><p>追寻梦想，也享受生活，感受痛苦，亦享受孤独。无数次在脑海中想象着遥远的未来，但也不要忘了这 <strong>旅途本身比终点更为重要</strong>。</p><p>一次又一次地站在 <strong>命运的前方，人生的岔路</strong>，或许会有失落迷茫，有所犹豫质疑，或许正身处黑暗，找不到光芒在何方，不知到底可以飞往多高的天空……</p><p>但无论发生了什么，都不要忘记了那份 <strong>热爱与梦想，初心与道路</strong>。</p><p>雨后总会天晴，人生也没有永夜。</p><p>继续坚定向前走去吧！ —— <strong>“只要有心，就能瞬间改变世界！”</strong></p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202312310439668.png" alt="image-20231231043339798"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;2023 年度总结&lt;/h1&gt;
&lt;h2 id=&quot;一月&quot;&gt;一月&lt;/h2&gt;
&lt;p&gt;今年的记忆，从跨年和家人一起在海边放烟花开始，绚烂而又短暂的烟花就好像今年的故事一样，美好也夹杂着一些可惜。&lt;/p&gt;
&lt;p&gt;一月底，随着网易和暴雪的合同到期，国内暴雪的时代正式结束了，好像人生一样</summary>
      
    
    
    
    <category term="日志" scheme="https://www.bearchild.top/categories/%E6%97%A5%E5%BF%97/"/>
    
    
    <category term="日志" scheme="https://www.bearchild.top/tags/%E6%97%A5%E5%BF%97/"/>
    
  </entry>
  
  <entry>
    <title>2022 年度总结</title>
    <link href="https://www.bearchild.top/2022/12/31/%E6%97%A5%E5%BF%97/2022%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/"/>
    <id>https://www.bearchild.top/2022/12/31/%E6%97%A5%E5%BF%97/2022%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/</id>
    <published>2022-12-31T15:59:59.000Z</published>
    <updated>2024-01-20T13:44:35.122Z</updated>
    
    <content type="html"><![CDATA[<h1>2022 年度总结</h1><h2 id="一月-二月">一月~二月</h2><p>打工前最后的时光。</p><p>印象深刻的是看了乃琳的 50w 粉纪念回，她说：<strong>“喜欢，就是一件细水长流且滔滔不绝的事情呀~”</strong>。</p><p>一年结束回望过去，感情是这样，工作是这样，人生也是这样。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202212310134293.png" alt="image-20221231013237913"></p><p>月初，投了下朝夕光年的江南工作室，结果被刷了；还被天美 L1 给捞了，结果也没有面过。</p><p>当初还很愤慨，觉得自己这么猛，肯定是面试官没有眼光。现在看来，当初的自己也十分青涩，自以为才高八斗，实际上连半桶水的水平也没有，连UI都不会拼，没有面试通过也很正常。</p><p>不过现在感觉也没什么，或许年少就该轻狂点，自负总比自卑更接近自信。</p><p>今年行业不景气，寒气传给了每一个人。和几个朋友都聊了聊，聊了下计划，聊了下未来，发现大家也都很焦虑。保研、考研、工作，大学最关键的一年，种种事情纷至沓来，DDL 仿佛近在眼前。</p><p>想了一想，果断接着逃学，在家准备面试和溜去实习。</p><p>寒气从年初开始找实习时就已经可见一斑，各大厂纷纷开始锁hc，连实习岗位都寥寥无几。幸运的是，或许是因为投简历投得早的原因，在锁 hc 的前一天，终于拿下了天美的实习 offer，十分感激 <strong>天美 F1 工作室</strong> 给了我实习的机会。</p><p>或许运气占了很大一部分因素，但是这也坚定了我的人生信条之一：<strong>胆子要大，做事果断</strong>。</p><h2 id="三月-四月">三月~四月</h2><p>人生总是起起落落，有幸运自然也有不幸。</p><p>三月初，因为疫情的缘故，学校全员核酸，逃学终是被发现了；深圳疫情也加重了，封公交封地铁，禁止堂食。</p><p>不过凡事都有解决的办法。逃学可以和辅导员补个假条，疫情加重也可以居家办公。也明白了，很多事情没必要去逃避，用自己想当然的方法去解决，比如当初或许压根没必要逃学。<strong>有时候好好沟通沟通，或许会有更好的处理办法。</strong></p><p>疫情好转后，再次一个人来到了深圳。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202212310134737.png" alt="image-20221231000143786"></p><p>因为各种调整，来到了 <strong>天美 J1 工作室</strong> 支援快上线的项目（一开始看到是赛车品类的游戏十分失望，但现在看来也是运气极好的一点，因为后面秋招阶段 F1 基本就没有 hc。这不就像人生一样吗，<strong>“祸兮福所倚，福兮祸所伏”</strong>。）</p><p>第一次进一个真正的游戏项目组，加入了 <strong>AI组</strong> 。面对庞大的代码无从下手，最后果断直接去要活，帮着改 bug。发现自己原来连 UI 都不会拼，备受折磨，这才是我的真实水平，太弱小了！没有力量！</p><p>一个人走在回出租屋的路上，一个人深夜恰着啤酒和烧烤。</p><p>不过幸好，认识了浩博，在最艰难的时候给了我许多帮助。至今难以忘记有一次团建后，他还帮我调一个生命周期的问题到了十二点，让我对项目组，乃至游戏这条道路都有了更多的期待。（可惜四月中旬他就离开了项目组去了王者战斗组，说来也巧，当初一月份的时候我还面了王者荣耀的战斗组并且没通过，王者你坏事做尽！）</p><p>后面逐渐融入了 AI 组，认识了更多的人，获得了很多很多的帮助。</p><p>现在看来这实在太过幸运，一入行就加入的特性小组，组里全是级别很高的猛人。看到了天豪天游他们优美的代码、精妙的框架，愈发令我折服。感受到了自己的渺小，也学到了很多。</p><p><strong>只要动手，一切都会好起来的</strong>。</p><h2 id="五月">五月</h2><p>月初去了广州玩耍，快乐的五一假期。回来后发现珈乐要毕业，退出了 A-SOUL，当初还难受了一段时间。晚上喝了几瓶哭了好久，一个人住的好处就是哭了也没人知道。</p><p>不过现在也早已释怀。<strong>人生有梦，各自精彩</strong>。各个选择也不好说是好是坏，自己选择的路跪着也要走完。</p><p>或许是之前成功搞定了技能数据蓝图，这次天游拉上我一起在版本末极限开工了“技能漏斗系统”，虽然只是辅助开发，但终于也算是又接了一个稍微狠一点的活。成功拿下，最后效果也还算不错。</p><p>原来我也是可以接狠活的人了，不知道什么时候才能独立负责一个完整的系统呢？</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202212310134950.png" alt="image-20221230210122043"></p><h2 id="六月">六月</h2><p>最如梦似幻的一个月，在不正确的时间遇上了一起来腾讯实习的妹妹。</p><p>人生第一次和女生单独出去玩。我们一起看电影，一起喝酒，一起吹海风，一起聊人生。在欢乐港湾坐在海岸边，看着远方的灯火，青涩幼稚的我以为最恰当的时机、最好的氛围表白了，结果寄了 XD。</p><p>镜花水月的美好让我误以为这就是爱情，可其实我们之间的差距大到难以想象。无论是性格还是三观， 无论是过去、现实还是未来；其实我们也不是很了解对方，或许是这个月太过充实，让我以为时间过了太久。</p><p>灿烂热烈的日子和平时老鼠窝的生活对比太过强烈，也许我也只是渴望改变下自己？就像鼠鼠也总是喜欢探出下水道寻找光明。</p><p>故事的结局并不总是那么美好，也许这就是最好的结局。梦总是会醒的，这也只是生命中的一段小插曲。现在想来，当初有很多幼稚的想法，第一次处理这些事情，矛盾又可笑，可细细一品，却也有点青春的浪漫与纯真。</p><p><strong>人生路漫漫，遗憾也是一种浪漫</strong>。尽量做到 <strong>不求无憾，但求无悔</strong> 吧。（呜呜呜又母胎solo了一年）</p><p>六月太不真实，如此草草就结束了，秋招也要开始了。</p><h2 id="七月-八月">七月~八月</h2><p>每年的七月和八月总是充斥着应届生们焦虑的气息。</p><p>一边是秋招的压力，一边是工作的无奈。又接了各种经分和UI的杂活，愈发迷茫，这真的是我想做的东西吗？</p><p>每天的日记里就写着 “写了一天经分 / 写了一天 UI / 想润了”。写 UI 的过程中，美术策划还一直爱指指点点。果然，<strong>UI程序，无间炼狱</strong>！</p><p>最后终于想明白了，这些东西总要有人干的，为什么不是你呢？<strong>游戏客户端就是什么都要做的</strong>。</p><p>事实上，当时的情况下来看，组里挑一个最不构成生产力的人来干，那个人也只能是我。</p><blockquote><p>很喜欢肛少说的一句话：</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202212310134576.png" alt="image-20221231002945979"></p></blockquote><p>现在还回过头看，这段经历也收获了很多，这些体力活也打下了较为扎实的业务基础，厚积才能薄发。</p><blockquote><p>做游戏这事，你会拼 UI，不是啥什么本事。但不会拼 UI，却无从谈本事了。</p></blockquote><p>回到秋招，或许今年的秋招堪称 <strong>地狱难度</strong>，其中艰辛相信经历过的人自然懂。各大厂释放的 hc 寥寥无几，无论是互联网行业还是游戏行业，寒气席卷到了每一个角落。</p><p>真正的千军万马过独木桥。游戏行业版号持续缩进，仿佛看不到尽头一样，到处都是劝退的言论。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202212310141099.png" alt="image-20221231014110154"></p><p>我彻底意识到了，<strong>“做游戏，本就九死一生”</strong>。</p><blockquote><p>很喜欢子明当时和别人的一次对话：</p><p>”天人感应：某天某夜一个男子望着大楼发呆，此时已经街道无人，只有灯还亮着“</p><p>“东面有什么？” ，“东面是正在修的地铁站不知道什么时候完工。”</p><p>“南面有什么？”，“南面是一片技术园区，有的灯还亮着，再往南是一望无际的深蓝。”</p><p>“西面有什么？”，“西面是无人无车的公交站以及帝国的另一块版图。”</p><p>“北面有什么？”，“北面的居民楼，妇人正在安抚醒来的孩童，今夜无眠。”</p><p>“上面有什么？”，“辽阔深邃的星空，高悬的明月，以及攀爬用的楼梯。”</p><p>“下面有什么？”，“红色的鲜血，星星落地的骨灰。”</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202212310134945.png" alt="image-20221231013013538"></p></blockquote><p>恰好当时从 J5/J6 又转来 J1 很多人，hc 愈发堪忧。</p><p>有不幸的事，也有幸运的事。因为早早开始实习，早早进入项目组干活，至少转正答辩的时候有东西可以写，转正的 PPT 上，需求单就贴了三页满。</p><p>写转正自评和 PPT 的时候，感谢球哥和文龙也指点我应该怎么写（虽然最后还是就简单写了几十个字，但至少他们的指点让我没那么开摆），同时也感谢 TO/PO/PM 当时力保我（现在看来当时我的确实还很稚嫩）。</p><p>八月底最后的转正 GM 面试走了个流程，成功拿下了转正 Offer，收到了意向书。</p><h2 id="九月">九月</h2><p>月初，又一个版本要结束了，我们的这个玩法 <strong>生死存亡</strong>，体验的结果实在太差，没有人看好，领导玩了不到十分钟就已经放下手机开始开会了。组里所有人都很焦虑，看着球哥他们越来越着急，愈发容易上火，甚至 PM 都已经急哭了几次。</p><p>哎…… 真惨，组里的氛围越来越不好。策划开会讨论的时候，都听到 doctor 好像在开玩笑一样地说：“大家都可以准备投简历了”，令人感慨，又有多少真话是以开玩笑的方式说出来的呢？</p><p>想着这样的组到底有没有留下去的价值，自己也感觉这个玩法前途一片灰暗。</p><p>生死存亡之际，最终策划们一波讨论，决定拉上了几个人 <strong>敏捷开发</strong> 快速验证新玩法。</p><p>因为平常 UI 拼的多，杂七杂八的东西负责的也多，混上了敏捷开发四人组中的一个，负责了所有的玩法/AI交互事件还有 UI。后面回头来看，这正是一个转折点，不但是这个玩法的转折点，也是我的转折点，厚积薄发的开始。</p><p>狠狠加了一周大班，每天一起床就是全力开发，经常肝到十一点多、十二点，一觉睡醒接着开卷。<strong>充实却又冷漠</strong>。想着看看最后结果如何，还抱着一丝幻想。</p><p>月末 Demo 终于开始出包跑起来了，值得庆幸的是，这个 Demo 看起来比之前成功了太多。事实证明，新玩法比之前的有趣了太多。当最初的 demo 跑起来的那一晚，策划直接玩上头。说明这个模式还是很有前途的，至少比之前的好了太多。</p><p>虽然加班没什么工资，但还是有种 <strong>值得</strong> 的感觉，看到策划（玩家）的笑脸，如释重负，也切实体会到了 <strong>做游戏的快乐</strong>。</p><p>啊，这段黑暗却又光明的日子。<strong>黑暗终将过去，黎明的曙光也终将到来</strong>。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202212310134174.png" alt="image-20221231002558895"></p><p>敏捷开发后，各种机缘巧合，或许是组织调整，或许我每天在工位讲做游戏就该做 gameplay，被 leader 听到了 XD。</p><p>总之，正式从 <strong>AI组</strong> 转到了 <strong>玩法组</strong>，项目也开启了 <strong>里程碑快速开发</strong> 阶段。</p><p>当初还很焦虑，毕竟要走出舒适圈了，但现在看来，这才是我该来的地方。</p><blockquote><p>很喜欢 MDD 说的一句话：</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202212310134155.png" alt="image-20221231002233010"></p></blockquote><h2 id="十月-十二月">十月~十二月</h2><p>敏捷线开发后，新玩法正式立足，进入了里程碑快速开发，我也正式转入玩法组进行工作。</p><p>里程碑的快速开发，带来的也是快速的成长。</p><p>和在 AI组 的 ”基本都在 UI，偶尔一点大活“ 不同，到玩法组后各种狠活，各种各样的功能，各种各样的系统：<code>LifeTimeSystem</code> / <code>DisplayInfoSystem</code> / <code>GameplayBuffSystem</code> / <code>GameplayFeatureSystem</code>……</p><p>回过头来，已经独立拿下了好多功能，各种 gameplay，狠狠堆业务。</p><blockquote><p>很喜欢马宝说的一句话：</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202212310134135.png" alt="image-20221230210148303"></p></blockquote><p>或许是拿下的狠活多了，或许是手速快、Bug 少。也逐渐愈发核心，各种功能开会也都拉上我了，手里的活越来越核心，不再是过去的 UI 打杂仔了。</p><p>恰好这时也谈薪发了正式 Offer，寒气袭人，一开始拿到的还只有 SP（现在想想在 AI 组的表现也确实就值这个价），感觉不太满意，和领导反馈了一下，结果 leader 直接去找 HR 表示 “这个人对项目组很重要，要尽全力挽留”（感动），最后也是成功拿下了个不错的 Offer，ヾ(✿ﾟ▽ﾟ)ノ</p><p>兜兜转转，最后还是决定在这个项目组好好干。</p><p>日子就这样一天天过去，里程碑阶段疯狂加班，几乎每天都十一点多走，在这种高压下，项目在成长，我也在飞速成长……</p><p>年终看完了世界杯，不得不说这是近几年最精彩的一场球赛，两个球队的坚持令人动容，这种意志值得学习，庆祝潘帕斯雄鹰也再次起飞！</p><p>终于，里程碑的快速开发终于走到了尾声。最后一个里程碑，基本也只有策划配置的活，恰好疫情也放开了，阳性在家，好好休息了一下。</p><p>最后一段居家办公的生活，作为了一年的总结，确实有种今年总算结束了的感觉，令人感慨。</p><p>希望明年项目顺利上线吧，希望我们玩法也可以大受好评。</p><h2 id="总结">总结</h2><p>今年认识了各种各样、各行各业的人，无论是程序、策划、测试，还是美术、运营。每个人都有自己与众不同的经历与故事，都有自己的想法和目标，<strong>平等自然看待所有人</strong> 才是相处的好办法。</p><p>无论人生有怎样的困难，总是要积极面对，<strong>凡事都会有解决的办法</strong>，相信自己，坚定信念。</p><p>固然运气也是成功的一部分，但 <strong>执行力要强，胆子要大</strong> 也十分重要。如果都不曾动手过，也无从谈运气好之说了。</p><p><strong>福祸相依</strong>，人生总不是一帆风顺的，起起落落跌宕起伏的故事才更加扣人心弦。</p><blockquote><p>或许寒气袭人，或许游戏行业日薄西山，或许九死一生。</p><p>但哪怕如此，依然得拼 UI、写 gameplay，因为这就是 “游戏热爱者”。</p></blockquote><p><strong>『No Game No Life』</strong> 的故事中，里克和休比面对黑暗，也始终心向光明，依然可以说出那句 <em><strong>【ゲームを始めよう】</strong></em>。</p><p>人生何尝不是一场盛大的游戏？</p><p>一部设计得精妙绝伦的游戏，一段注定与众不同、注定精彩的人生。</p><p>那么 —— <strong>来玩游戏吧！</strong></p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202212310134074.png" alt="image-20221231001141448"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;2022 年度总结&lt;/h1&gt;
&lt;h2 id=&quot;一月-二月&quot;&gt;一月~二月&lt;/h2&gt;
&lt;p&gt;打工前最后的时光。&lt;/p&gt;
&lt;p&gt;印象深刻的是看了乃琳的 50w 粉纪念回，她说：&lt;strong&gt;“喜欢，就是一件细水长流且滔滔不绝的事情呀~”&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;一年</summary>
      
    
    
    
    <category term="日志" scheme="https://www.bearchild.top/categories/%E6%97%A5%E5%BF%97/"/>
    
    
    <category term="日志" scheme="https://www.bearchild.top/tags/%E6%97%A5%E5%BF%97/"/>
    
  </entry>
  
  <entry>
    <title>[UE]PushModel属性同步</title>
    <link href="https://www.bearchild.top/2022/04/10/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/[UE]PushModel%E5%B1%9E%E6%80%A7%E5%90%8C%E6%AD%A5/"/>
    <id>https://www.bearchild.top/2022/04/10/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/[UE]PushModel%E5%B1%9E%E6%80%A7%E5%90%8C%E6%AD%A5/</id>
    <published>2022-04-09T16:00:00.000Z</published>
    <updated>2022-11-26T11:15:48.749Z</updated>
    
    <content type="html"><![CDATA[<h1>PushModel属性同步</h1><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202204101622619.png" alt="image-20220410162250125"></p><h2 id="优势">优势</h2><p><code>PushModel</code> 是对 <code>Replicate</code> 的一个优化。</p><p>对于属性的同步，原有的 <code>Replicated</code> 属性，在 <code>Replicate</code>  之前需要通过<code>反射</code>对一个 <code>Actor</code> 的所有属性进行 <code>diff</code>，对比所有的属性是否发生变化，变化的属性才进行同步。</p><p>而用上了 <code>PushModel</code>，我们可以主动 <code>MARK_DIRTY</code>，在 <code>Set</code> 时主动将其设置为脏，相当于给该属性上了一个<code>Flag</code>，底层会自动通过这个<code>Flag</code> 来判断是否需要同步，省去了 <code>diff</code> 这个高消耗的操作。</p><p>需要注意的是，对于一个 <code>Actor</code>，如果采用了 <code>PushModel</code>，则需要将所有需要同步的属性都挂上这个 <code>PushModel</code>，否则如果存在非<code>PushModel</code>的需要<code>Repilicated </code>的属性，可能会该功能不生效，退化到原来的情况。</p><p>UE5 中还对 <code>PushModel</code> 做了更进一步的优化，添加了一些新的宏以及对更多基础组件的支持。</p><h2 id="实践">实践</h2><h3 id="设置依赖">设置依赖</h3><p>首先，我们需要在 <code>Build.cs</code> 中添加 <code>NetCore</code> 模块的依赖。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PublicDependcyModuleNames.<span class="built_in">AddRange</span>(<span class="keyword">new</span> string[] &#123;<span class="string">&quot;NetCore&quot;</span>&#125;)</span><br></pre></td></tr></table></figure><h3 id="设置属性">设置属性</h3><p>我们对于一个需要同步的属性，得先加上 <code>Replicated</code> 标签；有必要的话，需要加上<code>RepilicatedUsing </code> 来设置属性为脏时执行的回调函数。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ATest</span> :</span> <span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">UPROPERTY</span>(Replicated, EditAnywhere, ReplicatedUsing = OnRep_Param)</span><br><span class="line"><span class="keyword">float</span> Param;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UFUNCITON</span>()</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnRep_Param</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ATest::OnRep_Param</span><span class="params">()</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure><h3 id="声明同步">声明同步</h3><p>首先我们要先将这个 <code>Actor</code> 标记为需要同步，在构造函数中标记 <code>bReplicates = true</code>。</p><p>接着我们需要实现 <code>GetLifetimeReplicatedProps</code>，在这个接口中添加宏标记同步的 Property。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ATest::GetLifetimeReplicatedProps</span><span class="params">(TArray&lt; FLifetimeProperty &gt;&amp; OutLifetimeProps)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Super::<span class="built_in">GetLifetimeReplicatedProps</span>(OutLifetimeProps);</span><br><span class="line">    </span><br><span class="line">FDoRepLifetimeParams SharedParams;</span><br><span class="line">SharedParams.bIsPushBased = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line"><span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(ATest, Param, SharedParams);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FDoRepLifetimeParams</code> 中设置了同步的条件，其中<code>bIsPushBased</code> 表明是否使用 <code>PushModel</code>。</p><p>其中 <code>DOREPLIFETIME_WITH_PARAMS_FAST</code> 的宏实现：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">define <span class="title">DOREPLIFETIME_WITH_PARAMS_FAST</span><span class="params">(c,v,params)</span> \</span></span><br><span class="line"><span class="function"></span>&#123; \</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">bool</span> bIsValid_##c_#<span class="meta">#v = ValidateReplicatedClassInheritance(StaticClass(), c::StaticClass(), TEXT(#v)); \</span></span><br><span class="line"><span class="meta">const TCHAR* DoRepPropertyName_##c_##v(TEXT(#v)); \</span></span><br><span class="line"><span class="meta">const NetworkingPrivate::FRepPropertyDescriptor PropertyDescriptor_##c_##v(DoRepPropertyName_##c_##v, (int32)c::ENetFields_Private::v, 1); \</span></span><br><span class="line"><span class="meta">RegisterReplicatedLifetimeProperty(PropertyDescriptor_##c_##v, OutLifetimeProps, params); \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="修改属性">修改属性</h3><p>最后，我们在修改属性的时候，可以使用 <code>MARK_PROPERTY_DIRTY_FROM_NAME</code> 来将属性设脏。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ATest::SetParam</span><span class="params">(<span class="keyword">const</span> <span class="keyword">float</span> NewParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">MARK_PROPERTY_DIRTY_FROM_NAME</span>(ATest, Param, <span class="keyword">this</span>);</span><br><span class="line">    Param = NewParam;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在，<code>Server</code> 只需要检测属性是否被 <code>MARK_DIRTY</code> 就可以知道是否需要同步。</p><p>当然，除了 <code>MARK_PROPERTY_DIRTY_FROM_NAME</code> 以外，UE 还实现了一些作用类似的其它的宏：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MARK_PROPERTY_DIRTY(Object, Property) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MARK_PROPERTY_DIRTY_STATIC_ARRAY_INDEX(Object, RepIndex, ArrayIndex) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MARK_PROPERTY_DIRTY_STATIC_ARRAY(Object, RepIndex, ArrayIndex) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MARK_PROPERTY_DIRTY_FROM_NAME(ClassName, PropertyName, Object) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MARK_PROPERTY_DIRTY_FROM_NAME_STATIC_ARRAY_INDEX(ClassName, PropertyName, ArrayIndex, Object) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MARK_PROPERTY_DIRTY_FROM_NAME_STATIC_ARRAY(ClassName, PropertyName, ArrayIndex, Object)</span></span><br></pre></td></tr></table></figure><h3 id="改进">改进</h3><p>当然，我们也可以不这么复杂，我们可以自己设置一个新的标签。</p><p>对于打上这个标签的属性，让其在 <code>CodeGenerator</code> 中自动生成 <code>Setter</code> 与 <code>Getter</code>，然后通过 <code>Setter</code> 与 <code>Getter</code> 来进行修改与访问。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _T&gt; \</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetParam</span><span class="params">(_T&amp;&amp; NewParam)</span> \</span></span><br><span class="line"><span class="function"></span>&#123; \</span><br><span class="line">    <span class="built_in">MARK_PROPERTY_DIRTYFROM_NAME</span>(ATest, Param, <span class="keyword">this</span>); \</span><br><span class="line">    Param = Forward&lt;_T&gt;(NewParam); \</span><br><span class="line">&#125; \</span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">float</span>&amp; <span class="title">GetParam</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;<span class="keyword">return</span> Param;&#125; \</span><br><span class="line"><span class="function"><span class="keyword">float</span>&amp; <span class="title">GetParam_Mutable</span><span class="params">()</span> \</span></span><br><span class="line"><span class="function"></span>&#123; \</span><br><span class="line">   <span class="built_in">MARK_PROPERTY_DIRTYFROM_NAME</span>(ATest, Param, <span class="keyword">this</span>); \</span><br><span class="line">   <span class="keyword">return</span> Param;</span><br><span class="line">&#125; \</span><br></pre></td></tr></table></figure><h2 id="参考">参考</h2><p>Unreal Engine 4. New network model: PushModel：<a href="https://tech-en.netlify.app/articles/en539604/index.html">https://tech-en.netlify.app/articles/en539604/index.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;PushModel属性同步&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202204101622619.png&quot; alt=&quot;</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="网络" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="UE" scheme="https://www.bearchild.top/tags/UE/"/>
    
    <category term="网络" scheme="https://www.bearchild.top/tags/%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>[GENERIC]知识总结</title>
    <link href="https://www.bearchild.top/2022/01/01/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/[GENERIC]%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/"/>
    <id>https://www.bearchild.top/2022/01/01/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/[GENERIC]%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/</id>
    <published>2021-12-31T16:00:00.000Z</published>
    <updated>2024-04-14T10:03:03.221Z</updated>
    
    <content type="html"><![CDATA[<h1>知识总结</h1><h2 id="1-AI">1. AI</h2><h3 id="寻路">寻路</h3><p><a href="https://zhuanlan.zhihu.com/p/54510444">路径规划之 A* 算法</a></p><p><a href="https://blog.csdn.net/tkokof1/article/details/111297299">[译]寻路优化</a></p><p><a href="https://www.cnblogs.com/KillerAery/p/12242445.html">JPS/JPS+ 寻路算法</a></p><p><a href="http://www.aisharing.com/archives/80">在AI寻路决策中运用势力图（Influence Map）</a></p><p><a href="https://zhuanlan.zhihu.com/p/362500376">LPA* 与 D* Lite</a></p><p><a href="https://wo1fsea.github.io/2016/08/21/A_Quick_Introduction_to_NavMesh/">NavMesh 生成算法</a></p><blockquote><p>A* 的估价：设起点为 S、终点为 T，可以选择 D0 * ManhattanDist(S, T) + D1 * abs( Cross(Se, Te) )</p><p>其中 D0 = 2，D1 = 0.001</p></blockquote><h2 id="2-动画">2. 动画</h2><h3 id="骨骼动画">骨骼动画</h3><p><a href="https://www.bearchild.top/2021/11/27/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%8A%A8%E7%94%BB/%E9%AA%A8%E9%AA%BC%E5%8A%A8%E7%94%BB%E5%8E%9F%E7%90%86/">骨骼动画原理</a></p><h2 id="3-Gameplay">3. Gameplay</h2><h3 id="基础">基础</h3><p><a href="https://harttle.land/effective-cpp.html">Effective C++</a></p><h3 id="架构">架构</h3><p><a href="https://blog.codingnow.com/2017/06/overwatch_ecs.html">浅谈《守望先锋》中的 ECS 构架</a></p><p><a href="https://zhuanlan.zhihu.com/p/270927422">漫谈Entity Component System (ECS)</a></p><h2 id="4-工具流">4. 工具流</h2><h3 id="引入第三方库">引入第三方库</h3><p><a href="https://wofead.top/2019/10/31/c++%E5%A4%B4%E6%96%87%E4%BB%B6%E5%BA%93%E6%96%87%E4%BB%B6%E5%92%8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93%E6%96%87%E4%BB%B6%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB%E5%92%8C%E4%BD%9C%E7%94%A8/">c++库文件的理解</a></p><h2 id="5-UI">5. UI</h2><h2 id="6-网络">6. 网络</h2><p><a href="https://zhuanlan.zhihu.com/p/445398809">预测、和解、插值</a></p><p><a href="https://www.lfzxb.top/nkgmoba-skillandnetwork/">技能系统与网络同步</a></p><p><a href="https://github.com/skywind3000/kcp">KCP</a></p><h2 id="7-物理">7. 物理</h2><h3 id="碰撞">碰撞</h3><p><a href="https://zhuanlan.zhihu.com/p/86981378?utm_source=qq&amp;utm_medium=social&amp;utm_oi=792136550879227904">多边形碰撞检测</a></p><p><a href="https://dyn4j.org/2010/01/sat/">SAT</a>：每个方向的投影都有重叠部分则图形碰撞。实际上不需要检测所有方向，二维使用 <strong>每条边</strong> 的法向量检测；三维使用 <strong>每个面</strong> 的法向量、<strong>两个图形的边两两组成的面</strong> 的法向量进行检测即可。</p><p><a href="https://dyn4j.org/2010/04/gjk-gilbert-johnson-keerthi/">GJK</a>、<a href="https://www.qiujiawei.com/collision-detection-2/">GJK</a></p><p>两个图形的闵可夫斯基差包含原点则图形碰撞。实际上不需要求出具体的闵可夫斯基图形，只要维护一个逼近原点的单纯形即可，该单纯形至多有三个顶点。三维时需要维护一个四面体。</p><p><a href="https://dyn4j.org/2010/05/epa-expanding-polytope-algorithm/">EPA</a></p><p>基于 GJK 算法进行扩展，确定物体的碰撞点和碰撞深度。需要注意的是，维护的单纯形可能顶点数会多于三个。</p><h2 id="8-渲染">8. 渲染</h2><h3 id="图形学">图形学</h3><p><a href="https://zhuanlan.zhihu.com/p/27471300">四元数——基本概念</a></p><p><a href="https://www.zhihu.com/question/23005815/answer/33971127">如何形象地理解四元数？</a></p><p><a href="https://zhuanlan.zhihu.com/p/97186723">四元数(Quaternions)</a></p><p><a href="https://zhiruili.github.io/posts/transformations/">图形学入门</a></p><p><a href="https://zhuanlan.zhihu.com/p/370059588">图形渲染基础：光栅化算法</a></p><p><a href="https://www.bearchild.top/2021/09/22/%E5%9B%BE%E5%BD%A2%E5%AD%A6/%5B%E5%9B%BE%E5%BD%A2%E5%AD%A6%5D%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF/">[图形学] 基础知识 - 渲染管线</a></p><p><a href="https://zhuanlan.zhihu.com/p/261667233">法线变换、切线空间、法线贴图</a></p><p><a href="https://zhuanlan.zhihu.com/p/102134614">延迟渲染</a></p><p><a href="https://zhuanlan.zhihu.com/p/434874992">上万字手把手教学，从零开始写软渲染器（光栅化版本）</a></p><h3 id="PBR">PBR</h3><p><a href="https://zhuanlan.zhihu.com/p/416112744">重新认识PBR</a></p><h3 id="卡通渲染">卡通渲染</h3><p><a href="https://zhuanlan.zhihu.com/p/163791090">卡通渲染学习总结</a></p><h3 id="大世界">大世界</h3><p><a href="https://zhuanlan.zhihu.com/p/258985044">大世界技术浅析——超远视距处理</a></p><h2 id="9-性能优化">9. 性能优化</h2><p><a href="https://zhuanlan.zhihu.com/p/259760974">IMR, TBR, TBDR 还有GPU架构方面的一些理解</a></p><p><a href="https://www.cnblogs.com/timlly/p/11471507.html">深入GPU硬件架构及运行机制</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;知识总结&lt;/h1&gt;
&lt;h2 id=&quot;1-AI&quot;&gt;1. AI&lt;/h2&gt;
&lt;h3 id=&quot;寻路&quot;&gt;寻路&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/54510444&quot;&gt;路径规划之 A* 算法&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="知识总结" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="知识总结" scheme="https://www.bearchild.top/tags/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>[UNITY]知识总结</title>
    <link href="https://www.bearchild.top/2022/01/01/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/[UNITY]%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/"/>
    <id>https://www.bearchild.top/2022/01/01/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/[UNITY]%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/</id>
    <published>2021-12-31T16:00:00.000Z</published>
    <updated>2024-04-14T10:03:18.416Z</updated>
    
    <content type="html"><![CDATA[<h1>知识总结</h1><h2 id="1-AI">1. AI</h2><h2 id="2-动画">2. 动画</h2><h3 id="动画基础">动画基础</h3><p><a href="https://zhuanlan.zhihu.com/p/105029905">学习笔记 — Unity动画系统</a></p><h3 id="Procedural-Animation">Procedural Animation</h3><p><a href="https://zhuanlan.zhihu.com/p/135877690">Unity里的Procedural Animation</a></p><h3 id="解决方案">解决方案</h3><p><a href="https://mp.weixin.qq.com/s?__biz=MzU5MjQ1NTEwOA==&amp;mid=2247493316&amp;idx=1&amp;sn=7e4fef834a8066faca3d2f1f1a090bb4&amp;chksm=fe1dd26fc96a5b79856840f556cf65026facb83520ac1891605e42d5e777d30a0d5219060e21&amp;mpshare=1&amp;scene=1&amp;srcid=0606YJLYnfprk9UjpPQCnre1#rd">Playable API：定制你的动画系统</a></p><p><a href="https://kybernetik.com.au/animancer/">Animancer</a></p><h2 id="3-Gameplay">3. Gameplay</h2><h3 id="架构">架构</h3><p><a href="https://www.drflower.top/posts/4981aa9/">GameFramework 解析</a></p><p><a href="https://zhuanlan.zhihu.com/p/186970833">Unity DOTS：目录</a></p><h3 id="协程">协程</h3><p><a href="https://www.bearchild.top/2021/09/24/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Gameplay/%5BUnity%5DUnity%E4%B8%AD%E7%9A%84%E5%8D%8F%E7%A8%8B/">Unity 中的协程</a></p><h3 id="地形">地形</h3><p><a href="https://zhuanlan.zhihu.com/p/388844386">大世界GPU Driven地形入门</a></p><h2 id="4-工具流">4. 工具流</h2><h3 id="反编译">反编译</h3><p><a href="https://github.com/dnSpy/">dnSpy</a></p><h3 id="编辑器">编辑器</h3><p><a href="https://www.lfzxb.top/odin-usualuse/">Odin常用功能整理</a></p><h3 id="技能编辑器">技能编辑器</h3><p><a href="https://zhuanlan.zhihu.com/p/158430393">技能编辑器的设计实现</a></p><h2 id="5-UI">5. UI</h2><h2 id="6-网络">6. 网络</h2><p><a href="https://zhuanlan.zhihu.com/p/83010584?utm_source=qq&amp;utm_medium=social&amp;utm_oi=792136550879227904">多人网络游戏同步探究</a></p><h2 id="7-物理">7. 物理</h2><h2 id="8-渲染">8. 渲染</h2><h3 id="渲染基础">渲染基础</h3><p><a href="https://www.zhihu.com/pub/book/119585555">Unity Shader 入门精要</a></p><h3 id="卡通渲染">卡通渲染</h3><p><a href="https://zhuanlan.zhihu.com/p/109101851">从零开始的卡通渲染</a></p><h2 id="9-性能优化">9. 性能优化</h2><h3 id="内存">内存</h3><p><a href="https://zhuanlan.zhihu.com/p/381859536">【笔记】Unity内存分配和回收的底层原理</a></p><p><a href="https://zhuanlan.zhihu.com/p/370467923">Unity游戏内存分布概览</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;知识总结&lt;/h1&gt;
&lt;h2 id=&quot;1-AI&quot;&gt;1. AI&lt;/h2&gt;
&lt;h2 id=&quot;2-动画&quot;&gt;2. 动画&lt;/h2&gt;
&lt;h3 id=&quot;动画基础&quot;&gt;动画基础&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/105029905&quot;&gt;</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="知识总结" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="知识总结" scheme="https://www.bearchild.top/tags/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/"/>
    
    <category term="Unity" scheme="https://www.bearchild.top/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>[UE]知识总结</title>
    <link href="https://www.bearchild.top/2022/01/01/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/[UE]%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/"/>
    <id>https://www.bearchild.top/2022/01/01/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/[UE]%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/</id>
    <published>2021-12-31T16:00:00.000Z</published>
    <updated>2024-04-14T10:02:41.410Z</updated>
    
    <content type="html"><![CDATA[<h1>知识总结</h1><h2 id="1-3C">1. 3C</h2><h3 id="CharacterMovement">CharacterMovement</h3><p><a href="https://zhuanlan.zhihu.com/p/34257208">《Exploring in UE4》移动组件详解[原理分析]</a></p><p><a href="https://zhuanlan.zhihu.com/p/114341957">UE4移动的网络同步</a></p><h2 id="2-AI">2. AI</h2><h3 id="寻路">寻路</h3><p><a href="https://zhuanlan.zhihu.com/p/74537236">UE4 Navmesh寻路</a></p><p><a href="https://github.com/recastnavigation/recastnavigation">UE4 的 RecastDetour 组件</a></p><p>UE4 主要使用 RecastDetour 组件主要支持 3D 场景的导航网格导出和寻路，也就是 NavMesh</p><h3 id="行为树">行为树</h3><p><a href="https://zhuanlan.zhihu.com/p/143298443">UE4行为树详解</a></p><p><a href="https://zhuanlan.zhihu.com/p/139514376">[UE4][AI] 浅析UE4-BehaviorTree的特性</a></p><h2 id="3-动画">3. 动画</h2><p><a href="https://www.zhihu.com/column/c_1354205128203993089">虚幻引擎里的运动学研究</a></p><h2 id="4-Gameplay">4. Gameplay</h2><h3 id="GAS">GAS</h3><p><a href="https://zhuanlan.zhihu.com/p/440168260">UE的GAS原理深入探究</a></p><p><a href="https://github.com/tranek/GASDocumentation#concepts-asc-rm">GAS Documentation</a></p><p><a href="https://zhuanlan.zhihu.com/p/464329488">GAS架构分析</a></p><p><a href="https://zhuanlan.zhihu.com/p/458192589">GAS探究</a></p><p><a href="https://www.youtube.com/watch?v=_713CSOWkTU">SplashDamage的技术负责人的GAS介绍</a></p><p><a href="https://docs.unrealengine.com/5.0/en-US/lyra-sample-game-in-unreal-engine/">UE5：Lyra示例项目</a></p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202308110009187" alt="img"></p><h2 id="5-工具流">5. 工具流</h2><h3 id="插件基础">插件基础</h3><p><a href="https://zhuanlan.zhihu.com/p/121152396">插件与模块</a></p><p><a href="https://cloud.tencent.com/developer/article/1699614">UE4编辑器如何生成和共享插件</a></p><p><a href="%E4%B8%BA%E5%A4%9A%E4%B8%AA%E6%9C%89%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB%E7%9A%84plugin%E7%94%9F%E6%88%90%E9%A2%84%E7%BC%96%E8%AF%91%E7%9A%84%E9%93%BE%E6%8E%A5%E5%BA%93%EF%BC%9Ahttps://zhuanlan.zhihu.com/p/115292711">[UE4]无插件源码编译和打包工程</a></p><p><a href="https://lxjk.github.io/2019/10/01/How-to-Make-Tools-in-U-E.html">How to Make Tools in UE4</a></p><blockquote><p>注意事项</p><p>在同一个插件模块里面定义的全局静态变量共享。（在 <code>A.cpp</code> 中定义 <code>static int a</code>，在 <code>B.cpp</code> 可以调用。若在 <code>B.cpp</code> 中也定义 <code>static int a</code> 则会报重定义的错误）</p></blockquote><h3 id="序列化">序列化</h3><h4 id="JSON">JSON</h4><p><a href="https://www.bilibili.com/read/cv10071665">[UE4 C++入门到进阶]10.Json数据读写</a>、<a href="https://sanctorum003.github.io/2019/08/07/CG/UE4/JSON/">虚幻4之JSON学习</a>、<a href="https://zhuanlan.zhihu.com/p/74720067">反序列化方法</a>、<a href="https://www.dazhuanlan.com/2020/02/24/5e536ade3f9b8/">[UE4]写入Json文件</a></p><p>参考源码：<code>PaperSpriteSheetImportFactory</code>、<code>PaperTiledImporterFactory</code>、<code>PaperJsonSpriteSheetImporter</code></p><h3 id="Config-系统">Config 系统</h3><p><a href="https://blog.ch-wind.com/ue4-config-usage/">UE4 中 Config 的使用</a></p><p><a href="https://blog.ch-wind.com/ue4-config-setting/">UE4 的配置界面写入</a></p><p><a href="http://supervj.top/2020/08/31/%E6%89%A9%E5%B1%95%E6%B8%B8%E6%88%8F%E8%AE%BE%E7%BD%AE/">UE4 添加自定义项目设置</a></p><p>参考源码：<code>Paper2DEditorModule</code></p><h3 id="拓展编辑器">拓展编辑器</h3><p>显示 UI 的可拓展点：Edit -&gt; Editor Preferences -&gt; General -&gt; Miscellaneous -&gt; Developer Tools -&gt; Display UIExtension Points，勾选后即可显示</p><p><a href="https://www.lfzxb.top/ue4-plugins-development/">UE4插件开发总结</a></p><p><a href="https://blog.csdn.net/qq_29523119/article/details/100088321">UE4给编辑器添加菜单栏(Menu)，工具栏(TooBar)，Tab窗口</a></p><p><a href="https://zhuanlan.zhihu.com/p/302632931">【UE4编辑器】ContentBrowser 扩展之资源菜单</a></p><p><a href="https://nerivec.github.io/old-ue4-wiki/pages/custom-context-menu-for-actors-in-editor.html">Custom Context Menu for Actors in Editor</a></p><blockquote><p>本质就是 通过 FModuleManager 获得对应模块，在其扩展数组（MenuExtenderArray）里添加新的委托，委托里的内容就是用来添加真正的菜单项。可添加的内容根据 Extender 来确定。</p></blockquote><p>参考源码：<code>AssetManagerEditorModule</code>、<code>ContentBrowserExtensions：InstallHooks</code>、<code>SpriteAssetTypeActions：GetActions</code></p><h4 id="Slate">Slate</h4><p><a href="https://zhuanlan.zhihu.com/p/115267691">UE4 Slate 基本框架</a></p><p><a href="https://zhuanlan.zhihu.com/p/77681049">虚幻4渲染编程（工具篇）【第九卷：SlateUI布局】</a></p><p><a href="https://zhuanlan.zhihu.com/p/56127773">Slate VS UMG（Slate 控件基本框架）</a></p><p><a href="https://gameinstitute.qq.com/community/detail/121778">Slate控件中的代理事件如何绑定 UObject 方法</a></p><p><a href="https://zhuanlan.zhihu.com/p/28355166">【UE4 Renderer】&lt;02&gt; Slate系统</a></p><p><a href="https://zhuanlan.zhihu.com/p/346275251">【UEInside】 Slate合批机制剖析</a></p><p>参考源码：<code>SlateTypes</code></p><h3 id="引入第三方库">引入第三方库</h3><p><a href="https://zhuanlan.zhihu.com/p/395423662">UE4引入第三方库</a></p><h3 id="创建-Asset">创建 Asset</h3><p><a href="https://blog.csdn.net/weixin_39743369/article/details/112160932">ue4 通过指定路径加载资源_UE4 C++基础教程 - 资源常见名词解释</a></p><p><a href="https://answers.unrealengine.com/questions/500286/view.html">Create a package in a special path</a></p><p><a href="https://gmpreussner.com/reference/adding-new-asset-types-to-ue4">Adding New Asset Types to UE4</a></p><p><a href="https://blog.csdn.net/u010385624/article/details/99729152">ue4 创建自定义资源，导入与重新导入自定义资源</a></p><p><a href="https://zhuanlan.zhihu.com/p/374152267">UE4的DragonBones插件的开发</a></p><p><a href="https://zhuanlan.zhihu.com/p/55132638">虚幻4渲染编程（工具篇）【第八卷：Asset creation】</a></p><p><a href="https://zhuanlan.zhihu.com/p/338729328">虚幻4渲染编程（工具篇V2）【第一卷：UE4 Assets tool DV basic Intro】</a></p><p>参考源码：<code>EditorFactories</code>、<code>SoundFactory</code>、<code>PaperTiledImporterFactory</code></p><h2 id="6-关卡">6. 关卡</h2><h2 id="7-UI">7. UI</h2><h3 id="UI基础知识">UI基础知识</h3><p><a href="https://zhuanlan.zhihu.com/p/117582084">UE4入门之路（UI篇）：UMG系统介绍</a></p><p><a href="https://gameinstitute.qq.com/community/detail/121327">UE4的UI制作流程</a></p><p><a href="https://gamedevworks.com/blog/ue4-how-to-get-umg-widget-position-in-screen-space/">How to get UMG widget absolute position in UE4</a></p><p><a href="https://dawnarc.com/2018/12/ue4slate-and-native-umgc-notes/">[UE4]Slate 和 Native UMG(C++) 笔记</a></p><h3 id="程序化生成">程序化生成</h3><p><a href="https://answers.unrealengine.com/questions/561607/view.html">How to construct UMG widget in C++?</a></p><p><a href="https://gist.github.com/SalahAdDin/b3814f109d340f1e0f5dcac6e623b8ce">代码生成 Widget 与 WidgetBlueprint</a></p><p>参考源码：<code>WidgetBlueprintFactory</code></p><h2 id="8-网络">8. 网络</h2><p><a href="https://zhuanlan.zhihu.com/p/678112760">UE4 浅谈网络同步中的RPC</a></p><p><a href="https://zhuanlan.zhihu.com/p/533738684">UE4网络同步-RPC流程详解</a></p><p><a href="https://zhuanlan.zhihu.com/p/682972215">UE4 属性同步-同步前的准备</a></p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202305282307110.png" alt="image-20230528230743329"></p><p><a href="https://zhuanlan.zhihu.com/p/567579687">虚幻笔记：RPC中Actor的所有权</a></p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202305282307655.png" alt="image-20230528230724616"></p><p><a href="https://zhuanlan.zhihu.com/p/34723199">《Exploring in UE4》网络同步原理深入（上）[原理分析]</a></p><p><a href="https://zhuanlan.zhihu.com/p/105040792">使用虚幻引擎4年，我想再谈谈他的网络架构【经验总结】</a></p><p><a href="https://wizardcell.com/unreal/multiplayer-tips-and-tricks/">Multiplayer Tips&amp;Tricks</a></p><p>参考源码：<code>NetDriver</code>、<code>ActorChannel</code>、<code>FObjectReplicator::SendCustomDeltaPropert</code></p><h2 id="9-物理">9. 物理</h2><h2 id="10-渲染">10. 渲染</h2><h3 id="Niagara">Niagara</h3><p><a href="https://www.cyanhall.com/cn/tutorial/">Niagara 教程</a></p><h3 id="材质">材质</h3><p><a href="https://zhuanlan.zhihu.com/p/73754807">[UE4]动态液体材质浅谈</a></p><h2 id="10-性能优化">10. 性能优化</h2><h3 id="内存管理">内存管理</h3><p><a href="https://zhuanlan.zhihu.com/p/61366273">UE4内存Profiler</a></p><p><a href="https://zhuanlan.zhihu.com/p/219588301">UE4 垃圾收集大杂烩</a></p><h3 id="性能分析">性能分析</h3><p><a href="https://www.cnblogs.com/ghl_carmack/p/5481763.html">UE4 性能优化方法(工具篇)</a></p><p><a href="https://www.cnblogs.com/kekec/p/14960139.html">UE4 stats性能埋点</a></p><p><a href="https://zhuanlan.zhihu.com/p/267335603?utm_source=qq">[UE4] 项目帧率低排查瓶颈文件步骤记录</a></p><p><a href="https://www.puredevsoftware.com/framepro/index.htm">FramePro</a></p><h2 id="11-引擎">11. 引擎</h2><h3 id="基础">基础</h3><p><a href="https://zhuanlan.zhihu.com/p/362218832">Unity3D 经验者转到 UE4 的经验</a></p><p><a href="https://zhuanlan.zhihu.com/p/369974105">UE4的智能指针 TSharedPtr</a></p><p><a href="https://dawnarc.com/2016/05/ue4console%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4command/">[UE4]console命令行常用命令(command)</a></p><p><a href="https://zhuanlan.zhihu.com/p/49046671">[UE4] 对象内存管理几种模式</a></p><h3 id="蓝图">蓝图</h3><p><a href="https://zhuanlan.zhihu.com/p/92268112">理解蓝图技术架构</a></p><h3 id="反射">反射</h3><p><a href="https://www.xianlongok.site/post/6605f9f/">反射系统</a></p><h3 id="架构">架构</h3><p><a href="https://zhuanlan.zhihu.com/p/22833151">《InsideUE4》GamePlay架构（一）Actor和Component</a></p><h3 id="Demo">Demo</h3><p><a href="https://github.com/tomlooman/EpicSurvivalGameSeries">EpicSurvivalGameSeries</a></p><p><a href="https://docs.unrealengine.com/4.27/en-US/Resources/SampleGames/ShooterGame/">Shooter Game</a></p><p><a href="https://www.unrealengine.com/marketplace/zh-CN/product/action-rpg">ActionRPG</a></p><h3 id="资源管理">资源管理</h3><p><a href="https://zhuanlan.zhihu.com/p/69078536">UE4中的烘焙</a></p><p><a href="https://zhuanlan.zhihu.com/p/256342436">大世界技术浅析，WOW的梦幻影歌——客户端资源加载</a></p><h3 id="生命周期">生命周期</h3><p><a href="https://zhuanlan.zhihu.com/p/577433224?utm_medium=social&amp;utm_oi=854673897260457984&amp;utm_psn=1572287088678162432&amp;utm_source=wechat_session">UE5 – 引擎运行流程（从main到BeginPlay）</a></p><p><a href="https://blog.csdn.net/u014391423/article/details/107104283/">Ue4 客户端登录流程解析</a></p><p><a href="https://zhuanlan.zhihu.com/p/417502244">Gameplay启动流程</a></p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202211242037757.jpg" alt="img"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;知识总结&lt;/h1&gt;
&lt;h2 id=&quot;1-3C&quot;&gt;1. 3C&lt;/h2&gt;
&lt;h3 id=&quot;CharacterMovement&quot;&gt;CharacterMovement&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34257208&quot;&gt;</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="知识总结" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="知识总结" scheme="https://www.bearchild.top/tags/%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/"/>
    
    <category term="UE" scheme="https://www.bearchild.top/tags/UE/"/>
    
  </entry>
  
  <entry>
    <title>2021 年度总结</title>
    <link href="https://www.bearchild.top/2021/12/31/%E6%97%A5%E5%BF%97/2021%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/"/>
    <id>https://www.bearchild.top/2021/12/31/%E6%97%A5%E5%BF%97/2021%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/</id>
    <published>2021-12-31T15:59:59.000Z</published>
    <updated>2022-01-06T10:27:02.915Z</updated>
    
    <content type="html"><![CDATA[<h1>2021 年度总结</h1><h2 id="一月-三月">一月 ~ 三月</h2><p>开年好像并不是十分顺利，先是挂了 雅思听力 这门课（也是唯一一次挂科，幸好补考过了）。</p><p>给 ACM 的学弟讲课、准备补考、沉迷小说…… 日子总是在浑浑噩噩中就这样过去了，没什么成长也没什么收获。</p><p>就这样平平淡淡结束了这个学期在学校的日子，踏上了返乡的飞机。</p><p>回到家，躺了三天，想了很多，各种头脑风暴与纠结。最后终于坚定了自己的选择： <strong>毕业直接打工</strong> ，从事 <strong>游戏客户端开发</strong> 。</p><p>既然有了选择，那就动手！怎么在来年的秋招拿到个好 Offer 呢？水了水知乎，看了看那些面试的人，发现最有用的东西：<strong>实习经历</strong>。</p><p>发现大家都是大三才去找实习，那时候肯定很卷 QAQ，不行，得想个办法卷过他们！这时候我的内心萌生了一个想法：我要在这个 <strong>大二暑假</strong> 就去游戏大厂实习！</p><p>怎么找到实习呢？自然是 <strong>奖牌、项目、八股文</strong> ，但这时我手里除了一块 ACM 银牌一无所有，于是带着找到实习的目标，开始了紧急特训。</p><p>寒假期间，每天晚上从七八点卷到凌晨三四点以后，最后终于在开学的前两天整出了一个稍微能看能聊的 <strong>项目</strong> 。开学后，带着焦虑从早到晚背了两三周的 <strong>八股文</strong>（速成还是稍微取巧了，不可取啊不可取！）。但至少这下，终于可以有底气投递简历了。</p><p>带着 稚嫩的项目、不成熟的八股文、唯一一块稍微值钱点的 ACM 银牌 ，我开始了投递简历。这时候发现，官网上往往写着暑期实习只招收 22 届的学生（而我是 23 届的），但是事已至此怎能放弃呢！我还是把游戏大厂投了个遍，最后也证明了，这玩意儿也就写写而已，简历还是全都被捞了起来。</p><p>写简历，投递简历，等着简历被捞，面试。</p><p>……</p><p>幸运的是， 付出了的有了收获，甚至收获比你想象的更大 。居然通过了所有的面试，一次都没有挂过。</p><p>尘埃落定。在 <strong>3.26</strong> 收到 <strong>腾讯光子</strong> 的 Offer 的时候，过去近四个月的高压终于得到了释放。这时身心俱疲，甚至对面试产生了 PTSD，于是把其它厂的后续面试全拒了。（太感谢腾讯给的机会啦！）</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202201020036629.png" alt="img"></p><h2 id="四月-五月">四月~五月</h2><p>接下来好好把之前速成的八股学了学，认真学了下计网和操作系统。杂七杂八的东西也学了一堆，搭建起了这个博客。</p><p>期间认识了一个很优秀也很可爱的小姐姐，成为了好朋友，后来也给了我很多帮助和鼓励，很难不心动，可惜之后发现小姐姐早就有男朋友了……看来今年也脱单无望了，事实证明也确实如此，的确又母胎 solo 了一年。希望明年可以脱单！（好像已经这么说了好几年了，哈哈哈哈）</p><p>五月末，去北京打了人生中最后一场 ACM 比赛，可惜，结局并不是太好。可能是太久没有好好训练，早就进入了退役状态，比赛的结果不怎么样，痛苦打铁，公费旅游变自费…… <strong>一切摸的鱼，迟早要付出代价的！</strong></p><p>比赛完和好兄弟们聚了聚。考完和 lpf、pyz 一起聚了聚。这时我突然有了去天安门看升旗的想法，大家一拍即合！（或许好兄弟就是这样能陪你一起进步一起闹一起疯狂的存在吧）于是在凌晨两三点，我们从北四环一起骑共享单车到天安门看升旗。</p><p>这也是今年记忆最深刻的一件事情了，不得不承认这样的经历此生难忘。与此同时，这也是我人生中看过的最壮观的一场升旗仪式。</p><p>我觉得这甚至比得奖更加有价值，在往后余生，这样的经历都将有它在记忆中的位置。</p><p><strong>这些与众不同的故事，才是人生的意义吧</strong> 。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202201020036718.jpeg" alt="img"></p><h2 id="六月">六月</h2><p>偶然间看到了 <strong>嘉然</strong> 的一场直播，一首小年兽、一句晚安，直接心动！后来慢慢好好了解了下然然，原来世界上还有这么可爱的女孩子！</p><p><strong>“大家都要好好吃饭，每天都要开开心心的！”</strong> ，初见时并没有什么波澜，但是在后面我压力大再听到的时候，直接给我整破防了，或许这就是 <strong>偶像的意义</strong> 吧。</p><p>虽然我们隔着一个次元，但我还是受到了深深的鼓励，莫大的力量！！</p><p>后面实习期间，压力大的时候，在然然的 50 周年纪念回上，听到了那首《不可思议》，一个人在十平米的出租屋里直接听哭了。愈发入脑，或许在其他人看来甚至有点魔怔，但是其中的感动自己知道也就足够了。</p><p>然然，嘿嘿，我滴然然！</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202201020036999.jpeg" alt="img"></p><h2 id="七月-九月">七月 ~ 九月</h2><p>踏上了实习的路。</p><p>听到要做的东西的时候一脸懵逼，“这啥玩意儿啊？”，不能说是不会，只能说是完全不会了。</p><p>哎，嘈杂焦虑的深圳啊……项目前期每天在压力中度过，科兴好像风水确实不好，感觉整个人都不太对劲儿，幸好后面习惯了，生活和状态也慢慢回到正轨，虽然还是莫名其妙感觉好累。</p><p>还是有许多幸运的事。认识了很多志同道合的好朋友，一起在游戏行业成长。压力大的时候有然然的直播和朋友的陪伴，每一次鼓励和侃大山都给了我很大的力量。</p><p>现在还能回忆起来，想到的不是因为做不出项目的痛苦。而是 下班后晚上和 奥佬、川宝、柏神 一起喝啤酒吃烧烤的日子、和 枕鹤、恒佬 一起吃的那顿韩料、和桉宝一起约着吃的猪脚饭、还有和 游戏研发男酮会（同好会） 的众人一起面基打桌游时开心的模样……果然，友谊，是人生最珍贵的东西之一了。</p><p>最后慢慢啃还是顺利完成了项目，因为种种原因九月底就离职了。</p><p>同时也深刻明白了马宝说的一句话：<strong>“你得先做，然后才会；你得会了，所以能做。”</strong></p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202201020036965.jpeg" alt="img"></p><h2 id="十月-十二月">十月 ~ 十二月</h2><p>升到了 <strong>大三</strong> ，岁月如梭呀。</p><p>不过因为这学期课程实在太水，彻底把这些毫无价值的课给摆了，基本就没有上过课。</p><p>用实习挣的钱买了台顶配的电脑，无论是学习还是游戏都舒服了起来。</p><p>好好打了打游戏，也好好学了点东西（虽然总体来说还是比较摸鱼）把渲染、动画、Gameplay、物理、框架等等都卷了卷…… 正如肛少所说的 <strong>“客户端是什么都要做的”</strong>。</p><p>看完了入门精要，发现对渲染还是不感兴趣，能抄抄效果就好。期间看到 MDD 说的话，感觉很有道理：“做游戏，不做 Gameplay，做个屁的游戏。”</p><p>期间看了看其他虚拟主播的直播，感觉好像自己也 <strong>更加感性</strong> 了，以前总是理性消费，现在被感动到了总是想消费一波，差点要把实习赚的钱给造完了 QAQ（或许是因为然然在实习期间给了我很大的力量吧）。在这个世界上，大家都各自有自己的故事。在互联网上认识了一些可爱的人，也发现了一些或许不够成熟的人。这就是人生百态吧，同时庆幸自己遇到并结识的都是很优秀的人。</p><p>年末发现自己老是宅在电脑面前，以至于体重突破了 70kg，寄！于是立马开始了两天一次的长跑，运动确实可以锻炼意志力，在你不想跑想停下来的时候，克服怠惰的欲望再往前跑，这也是一次成长。</p><p>在学校平平淡淡地度过了 2021 年的最后一个季度……</p><p>今年的最后几天，发现 ugg 要去杭州字节的江南工作室了（然然也是江南工作室的），这推动了还在纠结的我。</p><p>回想起然然带给我的力量，过去的种种感动，果断给 <strong>杭州字节</strong> 投递了简历，这不也是人生中一件很 <strong>浪漫</strong> 的事情吗。</p><p>又开始了背八股的日子，就像上个学期一样，仿佛一场轮回一样，又吹响了新一场战斗的号角。</p><p>不过与之前不同的是，现在的我比开年的我更加有底气，也更加成熟了。</p><h2 id="总结">总结</h2><p>人生总是有许多的起起伏伏，有顺风顺水之日，亦有逆水行舟之时。</p><p>年初的时候我就在想，“今年过去后，自己会成长成一个什么样的人？”</p><p>整理年度总结的时候看了看过去的日记，发现年末的我确实比开年之初成长了许多，那这就足够了。</p><p>有什么想到的或者是想法，就立马动手！不要总是考虑那么多，不是所有事情都能准备得十分周全的，时间往往在你准备的时候就已经流逝了。</p><p><strong>所以，去做吧！</strong></p><p>最后，别忘记了家人，也别忘记了好朋友好兄弟们。</p><p><strong>人生路漫漫，这些弥足珍贵的情感，是人生中最宝贵的财富。</strong></p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202201020037007.jpg" alt="img"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;2021 年度总结&lt;/h1&gt;
&lt;h2 id=&quot;一月-三月&quot;&gt;一月 ~ 三月&lt;/h2&gt;
&lt;p&gt;开年好像并不是十分顺利，先是挂了 雅思听力 这门课（也是唯一一次挂科，幸好补考过了）。&lt;/p&gt;
&lt;p&gt;给 ACM 的学弟讲课、准备补考、沉迷小说…… 日子总是在浑浑噩噩中就这样过去</summary>
      
    
    
    
    <category term="日志" scheme="https://www.bearchild.top/categories/%E6%97%A5%E5%BF%97/"/>
    
    
    <category term="日志" scheme="https://www.bearchild.top/tags/%E6%97%A5%E5%BF%97/"/>
    
  </entry>
  
  <entry>
    <title>Live2D模型的简单制作</title>
    <link href="https://www.bearchild.top/2021/11/29/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%8A%A8%E7%94%BB/Live2D%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%AE%80%E5%8D%95%E5%88%B6%E4%BD%9C/"/>
    <id>https://www.bearchild.top/2021/11/29/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%8A%A8%E7%94%BB/Live2D%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%AE%80%E5%8D%95%E5%88%B6%E4%BD%9C/</id>
    <published>2021-11-28T16:00:00.000Z</published>
    <updated>2021-11-29T10:05:49.409Z</updated>
    
    <content type="html"><![CDATA[<h1>Live2D模型的简单制作</h1><h2 id="准备工作">准备工作</h2><ol><li>下载 <strong>Photoshop</strong> ；</li><li>下载 <strong>Live2D Cubism</strong> ：<a href="https://www.live2d.com/zh-CHS/%E3%80%82">https://www.live2d.com/zh-CHS/。</a></li></ol><h2 id="PS">PS</h2><p>首先我们在 <strong>PS</strong> 中制作好已经分层好的图层，为了方便后续在 <strong>Live2D Editor</strong> 中的使用，每个图层可以单独移动。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111291804890.png" alt="image-20211129164244952"></p><p>保存好 <strong>.psd</strong> 文件，后续使用。</p><h2 id="Live2D-Editor">Live2D Editor</h2><h3 id="导入文件">导入文件</h3><p>打开 <strong>Live2D Cubism Editor</strong>。</p><p>将制作好的 <strong>.psd</strong> 文件导入到 <strong>Editor</strong> 中。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111291804117.png" alt="image-20211129165444470"></p><h3 id="应用模板动画">应用模板动画</h3><p>点击 <strong>文件 -&gt; 应用模板</strong> 。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111291804308.png" alt="image-20211129165759765"></p><p>在显示的各种模板中选择一个合适的模板。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111291804316.png" alt="image-20211129165837121"></p><h3 id="调整参数">调整参数</h3><p>调整模板参数，尽可能地保证五官、身体对应。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111291804212.png" alt="image-20211129171438834"></p><p>由于自动绑定不一定合适，我们在 <strong>应用模板预览</strong> 中手动绑定对应部位</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111291804475.png" alt="image-20211129170308057"></p><p>点击一侧的部位，然后点击另一侧需要绑定的部位后，点击 <strong>对应所选元素</strong> 即可。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111291804163.png" alt="image-20211129170326365"></p><p>绑定后点击 <strong>OK</strong> 确认。</p><h3 id="制作纹理">制作纹理</h3><p>点击 <strong>可编辑纹理集</strong> 并导出纹理。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111291804131.png" alt="image-20211129165611423"></p><p><img src="E:%5CPictures_data%5Cimage-20211129165649706.png" alt="image-20211129165649706"></p><h3 id="导出">导出</h3><p>点击 <strong>文件 -&gt; 导出运作档 -&gt; 导出为 moc3 文件</strong> 即可。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111291804013.png" alt="image-20211129170837179"></p><p>这个 <strong>moc3</strong> 文件即可投入使用。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;Live2D模型的简单制作&lt;/h1&gt;
&lt;h2 id=&quot;准备工作&quot;&gt;准备工作&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;下载 &lt;strong&gt;Photoshop&lt;/strong&gt; ；&lt;/li&gt;
&lt;li&gt;下载 &lt;strong&gt;Live2D Cubism&lt;/strong&gt; ：&lt;a href=</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="动画" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%8A%A8%E7%94%BB/"/>
    
    
    <category term="动画" scheme="https://www.bearchild.top/tags/%E5%8A%A8%E7%94%BB/"/>
    
  </entry>
  
  <entry>
    <title>骨骼动画原理</title>
    <link href="https://www.bearchild.top/2021/11/27/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%8A%A8%E7%94%BB/%E9%AA%A8%E9%AA%BC%E5%8A%A8%E7%94%BB%E5%8E%9F%E7%90%86/"/>
    <id>https://www.bearchild.top/2021/11/27/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%8A%A8%E7%94%BB/%E9%AA%A8%E9%AA%BC%E5%8A%A8%E7%94%BB%E5%8E%9F%E7%90%86/</id>
    <published>2021-11-26T16:00:00.000Z</published>
    <updated>2021-11-26T21:44:54.476Z</updated>
    
    <content type="html"><![CDATA[<h1>骨骼动画原理</h1><h2 id="基础知识">基础知识</h2><p><strong>骨骼动画（Skeletal Animation）</strong> 是模型动画中的一种，通过改变骨骼的朝向和位置来为 <strong>模型</strong>  生成动画。</p><p><strong>模型（Model</strong>）由一个个三角面组成，这种三角面也被称为 <strong>网格（Mesh）</strong>，网格上有一个个 <strong>顶点（Vertex）</strong> 。</p><p>对应在骨骼动画中， <strong>网格（Mesh）</strong> 也被称作 <strong>皮肤（Skin）</strong>；骨骼之间的连接处称作 <strong>关节（Joints）</strong>，骨骼可以绕着 <strong>关节</strong> 旋转。</p><p>骨骼动画的制作，我们一般先进行 <strong>蒙皮</strong> ，然后运动时根据提前制作好的 <strong>关键帧</strong> 与在两个关键帧之间的 <strong>插值</strong> 进行 <strong>姿态调整</strong> 生成动画。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111270535439.png" alt="image-20211127035412971"></p><h2 id="蒙皮">蒙皮</h2><h3 id="基础知识-2">基础知识</h3><p>对于两脚兽，一般使用 <strong>T-Pose</strong> 进行蒙皮，因为大部分姿势不会偏离它太大。</p><p><strong>蒙皮</strong> 就是将 <strong>网格（Mesh）</strong> 的 <strong>顶点（Vertex）</strong> 给 <strong>绑定</strong> 在骨骼上，骨骼动画的本质就是用 <strong>骨骼</strong> 来操控 <strong>Mesh</strong> 动起来，<strong>Mesh</strong> 动起来的本质是 <strong>顶点</strong> 位置的改变。</p><p>一个 <strong>顶点</strong> 可能被多个 <strong>骨骼</strong> 影响（大部分情况一个顶点只会被一个骨骼影响，但是比如接近关节的顶点，单纯由一个骨骼影响可能会出现缝隙）。</p><p>确定被影响的方案就要使用 <strong>线性混合蒙皮（Linear Blend Skinning）</strong> 技术。</p><h3 id="线性混合蒙皮">线性混合蒙皮</h3><p>每个骨骼上会储存一个 <strong>变换矩阵</strong>（变换矩阵就是从 <strong>关节坐标系</strong> 到 <strong>世界坐标系</strong> 的 <strong>平移、旋转、缩放</strong> 矩阵的乘积，关节坐标系是以某个关节为原点的坐标系）</p><p>我们假设对这个顶点有影响的 <code>骨骼 i</code> 的 <strong>权重</strong> 为 <code>w[i]</code> 、变换矩阵为 <code>M[i]</code>、在 <strong>T-Pose</strong> 下的坐标为 <code>V</code>，那最后<strong>混合后的世界坐标</strong> 就为 <code>sum(V * w[i] * M[i])</code>，其中所有对其有影响的骨骼的权重之和为 <code>1</code> 。（其实这个公式就是按各个骨骼的权重比例转换，实际上是对每个骨骼的变换矩阵进行插值）</p><p>现在我们有了这个式子，需要的就是知道如何获得 <strong>变换矩阵</strong>，这就需要用到 <strong>正向动力学（Forward Kinematics）</strong> 了。</p><h3 id="正向动力学">正向动力学</h3><p>控制了关节的坐标，也就控制了骨骼、控制了模型。</p><p>关节可以构成一棵树（一般两脚兽以 <strong>盆骨</strong> 为根节点），每个节点存储了 <strong>相对父节点</strong> 的变换矩阵（我们可以叫它 <strong>小变换矩阵</strong>）。</p><p>这样，一个父节点移动的时候，可以带动子节点一起移动。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111270536995.png" alt="image-20211127042112070"></p><p>我们有了每个节点 <strong>相对父节点</strong> 的 <strong>小变换矩阵</strong>，从 <strong>关节坐标系</strong> 到 <strong>世界坐标系</strong> 的最终 <strong>变换矩阵</strong> 就由这一个个小变换矩阵累积获得，这个求解最终 <strong>变换矩阵</strong> 过程也就是 <strong>正向动力学</strong> 的本质。</p><p>实际上，每个节点的这个最终 <strong>变换矩阵</strong> 也就是从 <strong>根节点</strong> 到 <strong>该节点</strong> 路径上，每个 <strong>小变换矩阵</strong> 的乘积。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111270536124.png" alt="image-20211127043125618"></p><p>设<code>骨骼 i</code> 的 <strong>小变换矩阵</strong> 为 <code>m[i]</code>，特别的，根节点的变换矩阵设为 <code>O</code>，那显然对上图：<code>M[0] = O</code>、<code>M[1] = m[1]* O</code>、<code>M[2] = m[2] * m[1] * O = M[1] * O</code>，显然可以通过在树上进行一次遍历求得。</p><p>求解这个问题，这就是 <strong>正向动力学</strong> 了（一看就很 <strong>正向</strong>，从根节点 <strong>正向</strong> 往下走到叶节点）</p><h2 id="姿态调整">姿态调整</h2><h3 id="基础知识-3">基础知识</h3><p>动画师编辑骨骼进行若干姿态的调整，在 <strong>关键帧</strong> 中我们直接手动调整姿态。</p><p>在非关键帧（两个关键帧之间的 <strong>插值</strong> 得到的）动画，也会有姿态的变换。</p><p>如何进行姿态的调整有两种方案：</p><ol><li>对 <strong>变换矩阵</strong> 进行插值，需要用到 <strong>正向动力学（Forward Kinematics）</strong>。</li><li>对部分 <strong>关节坐标</strong> 进行插值，然后逆推所有坐标，需要用到 <strong>逆向动力学（Inverse Kinematics）</strong></li></ol><h3 id="逆向动力学">逆向动力学</h3><p>对于关节树，给定末端的 <strong>关节坐标</strong> ，怎么获得每个关节的坐标，从下往上 <strong>逆向</strong> 求解，就是 <strong>逆向动力学</strong> 的本质。</p><p>逆向动力学的解决方案一般是 <strong>CCD（Cyclic Coordinate Descent）</strong> 或 <strong>CAA（Circular Alignment Algorithm）</strong> 等。</p><h4 id="CCD（循环坐标下降算法）">CCD（循环坐标下降算法）</h4><p>CCD 在关节链的上执行一系列旋转，从最后一个链节开始，每次尝试将 <strong>末端</strong> 移近 <strong>目标坐标</strong>，采用迭代的方式逐渐处理。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111270536778.png" alt="image-20211127050602039"></p><p>CCD 算法也有不足之处：</p><ol><li><p>一组关节的物理系统一般有 <strong>关节角度约束</strong> 等物理限制，在解决 <strong>逆向动力学</strong> 的时候需要考虑到这些限制。CCD 算法可以生成可能 <strong>违反关节角度约束</strong> 的大角度旋转。</p></li><li><p>在某些情况下，特别是当靠近目标坐标时，CCD 算法会导致一条链形成循环 <strong>与自身相交</strong>。</p></li></ol><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111270536234.png" alt="image-20211127051144869"></p><ol start="3"><li>在某些情况下，CCD 可能会进行大量迭代，导致末端缓慢的 <strong>锯齿形运动</strong>。</li></ol><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111270536675.png" alt="image-20211127051220872"></p><p><strong>CAA（Circular Alignment Algorithm）</strong> 可以克服这些缺点。</p><h4 id="CAA（圆形对齐算法）">CAA（圆形对齐算法）</h4><p>CCA 给定的关节链沿 <strong>基点</strong> 和 <strong>可到达的目标位置</strong> 之间的若干圆弧。通过这些圆弧，计算可接受范围内的关节角度，实现 逆向动力学。</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202111270536594.png" alt="image-20211127051811031"></p><p><strong>CAA</strong> 要求所有圆弧具有相同的长度，以便计算。</p><p>CAA 在包含圆弧的 <strong>基点</strong> 和 <strong>目标坐标</strong> 的二维平面上工作。因此，一般的三维问题会被简化为二维问题，所有关节链都被限制为在单个平面上移动。</p><h3 id="插值">插值</h3><p>让非关键帧动画 <strong>平滑且连续</strong> 需要用到插值；空间变换有三种操作：平移、旋转、缩放。</p><p>其中，平移、缩放，显然可以平移矩阵、缩放矩阵直接进行 <strong>线性插值</strong>，但是旋转显然不行，旋转是在一个球面上移动，我们需要用到 <strong>四元数</strong> 进行 <strong>球面线性插值</strong> 。</p><h2 id="参考">参考</h2><p>GPU Skinning：骨骼动画原理：<a href="https://zhuanlan.zhihu.com/p/126293705">https://zhuanlan.zhihu.com/p/126293705</a></p><p>浅谈骨骼动画技术原理：<a href="https://zhuanlan.zhihu.com/p/431446337">https://zhuanlan.zhihu.com/p/431446337</a></p><p>Kinematics (Advanced Methods in Computer Graphics) ：<a href="http://what-when-how.com/advanced-methods-in-computer-graphics/kinematics-advanced-methods-in-computer-graphics-part-4/">http://what-when-how.com/advanced-methods-in-computer-graphics/kinematics-advanced-methods-in-computer-graphics-part-4/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;骨骼动画原理&lt;/h1&gt;
&lt;h2 id=&quot;基础知识&quot;&gt;基础知识&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;骨骼动画（Skeletal Animation）&lt;/strong&gt; 是模型动画中的一种，通过改变骨骼的朝向和位置来为 &lt;strong&gt;模型&lt;/strong&gt;  生成动画。&lt;/p&gt;</summary>
      
    
    
    
    <category term="游戏开发" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
    <category term="动画" scheme="https://www.bearchild.top/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%8A%A8%E7%94%BB/"/>
    
    
    <category term="动画" scheme="https://www.bearchild.top/tags/%E5%8A%A8%E7%94%BB/"/>
    
  </entry>
  
  <entry>
    <title>[图形学]基础图形绘制-直线裁剪</title>
    <link href="https://www.bearchild.top/2021/10/19/%E5%9B%BE%E5%BD%A2%E5%AD%A6/[%E5%9B%BE%E5%BD%A2%E5%AD%A6]%E5%9F%BA%E7%A1%80%E5%9B%BE%E5%BD%A2%E7%BB%98%E5%88%B6-%E7%9B%B4%E7%BA%BF%E8%A3%81%E5%89%AA/"/>
    <id>https://www.bearchild.top/2021/10/19/%E5%9B%BE%E5%BD%A2%E5%AD%A6/[%E5%9B%BE%E5%BD%A2%E5%AD%A6]%E5%9F%BA%E7%A1%80%E5%9B%BE%E5%BD%A2%E7%BB%98%E5%88%B6-%E7%9B%B4%E7%BA%BF%E8%A3%81%E5%89%AA/</id>
    <published>2021-10-18T16:00:00.000Z</published>
    <updated>2021-10-19T12:53:56.205Z</updated>
    
    <content type="html"><![CDATA[<h1>基础图形绘制-直线裁剪</h1><h2 id="Cohen-Sutherland">Cohen-Sutherland</h2><p><strong>Cohen-Sutherland 裁剪算法</strong> 是最常用的直线的裁剪算法，用于直线在矩形框的裁剪。</p><p>首先，给空间编码：</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202110192053631.png" alt="image-20211019203421901"></p><p>根据点所在的位置我们可以获得其编码。</p><p>接下来考虑几种情况：</p><ol><li>完全在矩形框内：将端点编码按位或，若为 0，则完全在矩形框内，直接全部保留；</li><li>完全在矩形框外：将端点编码按位与，若不为 0，则完全在矩形框外，直接全部舍弃；</li><li>其它情况：计算线段与矩形框的交点，获得新的线段，继续判断。</li></ol><p>对于 <strong>情况3</strong>，我们获得新的线段后接着判断。</p><p>这样可以有效减少计算次数，同时，遇到下图这种情况时：</p><p><img src="https://bearchildbucket-1300061763.cos.ap-guangzhou.myqcloud.com/img/articles/202110192053698.png" alt="image-20211019204228310"></p><p>我们会保留得到 <strong>AC</strong> 或 <strong>BD</strong> （取决于计算交点的顺序），然后在下一轮计算中舍弃该线段，不会出现问题。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> IN_SIDE      =  <span class="number">0x0000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> LEFT_SIDE    =  <span class="number">0x0001</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> RIGHT_SIDE   =  <span class="number">0x0010</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> BOTTOM_SIDE  =  <span class="number">0x0100</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> TOP_SIDE     =  <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">EncodePoint</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> code = IN_SIDE;</span><br><span class="line"><span class="keyword">if</span> (x &lt; LEFT)    code |= LEFT_SIDE;</span><br><span class="line"><span class="keyword">if</span> (RIGHT &lt; x)   code |= RIGHT_SIDE;</span><br><span class="line"><span class="keyword">if</span> (y &lt; BOTTOM)  code |= BOTTOM_SIDE;</span><br><span class="line"><span class="keyword">if</span> (TOP &lt; y)     code |= TOP_SIDE;</span><br><span class="line"><span class="keyword">return</span> code;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CohenSutherland</span><span class="params">(<span class="keyword">int</span> x0, <span class="keyword">int</span> y0, <span class="keyword">int</span> x1, <span class="keyword">int</span> y1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> code0 = <span class="built_in">EncodePoint</span>(x0, y0), code1 = <span class="built_in">EncodePoint</span>(x1, y1);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ( (code0 | code1) == <span class="number">0</span> ) <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> ( (code0 &amp; code1) != <span class="number">0</span> ) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> outCode = code0 ? code0 : code1;</span><br><span class="line"><span class="keyword">double</span> x, y, z;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (outCode &amp; LEFT_SIDE) &#123; x = LEFT; <span class="keyword">float</span> t = (x - x0) / (x1 - x0); y = (<span class="number">1</span> - t) * y0 + t * y1; &#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(outCode &amp; RIGHT_SIDE) &#123; x = RIGHT; <span class="keyword">float</span> t = (x - x0) / (x1 - x0); y = (<span class="number">1</span> - t) * y0 + t * y1; &#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(outCode &amp; BOTTOM_SIDE) &#123; y = BOTTOM; <span class="keyword">float</span> t = (y - y0) / (y1 - y0); x = (<span class="number">1</span> - t) * x0 + t * x1; &#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(outCode &amp; TOP_SIDE) &#123; y = TOP; <span class="keyword">float</span> t = (y - y0) / (y1 - y0); x = (<span class="number">1</span> - t) * x0 + t * x1; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (outCode == code0) x0 = x, y0 = y, code0 = <span class="built_in">EncodePoint</span>(x0, y0);</span><br><span class="line"><span class="keyword">else</span> x1 = x, y1 = y, code1 = <span class="built_in">EncodePoint</span>(x1, y1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Bresenham</span>(x0, y0, x1, y1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="OpenGL-完整代码">OpenGL 完整代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GLEW_STATIC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;GL/glew.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;GL/GL.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;GLFW/glfw3.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region Setting</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> GLFWwindow* window;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> SCR_WIDTH = <span class="number">800</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> SCR_HEIGHT = <span class="number">600</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> MAX_COUNT = <span class="number">800</span> * <span class="number">600</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitializeWindow</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">glfwInit</span>();</span><br><span class="line"><span class="built_in">glfwWindowHint</span>(GLFW_CONTEXT_VERSION_MAJOR, <span class="number">3</span>);</span><br><span class="line"><span class="built_in">glfwWindowHint</span>(GLFW_CONTEXT_VERSION_MINOR, <span class="number">3</span>);</span><br><span class="line"><span class="built_in">glfwWindowHint</span>(GLFW_OPENGL_PROFILE, GLFW_OPENGL_CORE_PROFILE);</span><br><span class="line"></span><br><span class="line">window = <span class="built_in">glfwCreateWindow</span>(SCR_WIDTH, SCR_HEIGHT, <span class="string">&quot;Test&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">glfwMakeContextCurrent</span>(window);</span><br><span class="line"><span class="built_in">glfwSetFramebufferSizeCallback</span>(window, [](GLFWwindow* window, <span class="keyword">int</span> width, <span class="keyword">int</span> height) &#123; <span class="built_in">glViewport</span>(<span class="number">0</span>, <span class="number">0</span>, width, height); &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">glewExperimental = GL_TRUE;</span><br><span class="line"><span class="built_in">glewInit</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ProcessInput</span><span class="params">(GLFWwindow* window)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">glfwGetKey</span>(window, GLFW_KEY_ESCAPE) == GLFW_PRESS)</span><br><span class="line"><span class="built_in">glfwSetWindowShouldClose</span>(window, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> region InitializeVertex</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">point</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">int</span> x, y;</span><br><span class="line"><span class="built_in">point</span>() : <span class="built_in">x</span>(<span class="number">0</span>), <span class="built_in">y</span>(<span class="number">0</span>) &#123;&#125;</span><br><span class="line"><span class="built_in">point</span>(<span class="keyword">int</span> _x, <span class="keyword">int</span> _y) : <span class="built_in">x</span>(_x), <span class="built_in">y</span>(_y) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">float</span> vertices[MAX_COUNT * <span class="number">3</span> * <span class="number">2</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> VAO, VBO;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Normalize</span><span class="params">(<span class="keyword">float</span>&amp; x, <span class="keyword">float</span>&amp; y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">x = (x - (SCR_WIDTH / <span class="number">2</span>)) / (SCR_WIDTH / <span class="number">2</span>);</span><br><span class="line">y = (y - (SCR_HEIGHT / <span class="number">2</span>)) / (SCR_HEIGHT / <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Swap</span><span class="params">(T&amp; a, T&amp; b)</span> </span>&#123; <span class="function">T <span class="title">temp</span><span class="params">(a)</span></span>; a = b; b = temp; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">/// Boundary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> LEFT = SCR_WIDTH / <span class="number">4</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> RIGHT = SCR_WIDTH / <span class="number">4</span> * <span class="number">3</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> BOTTOM = SCR_HEIGHT / <span class="number">4</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> TOP = SCR_HEIGHT / <span class="number">4</span> * <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DrawBoundary</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SCR_HEIGHT; i++)</span><br><span class="line">&#123;</span><br><span class="line">vertices[count * <span class="number">3</span>] = LEFT, vertices[count * <span class="number">3</span> + <span class="number">1</span>] = i;</span><br><span class="line"><span class="built_in">Normalize</span>(vertices[count * <span class="number">3</span>], vertices[count * <span class="number">3</span> + <span class="number">1</span>]), count++;</span><br><span class="line"></span><br><span class="line">vertices[count * <span class="number">3</span>] = RIGHT, vertices[count * <span class="number">3</span> + <span class="number">1</span>] = i;</span><br><span class="line"><span class="built_in">Normalize</span>(vertices[count * <span class="number">3</span>], vertices[count * <span class="number">3</span> + <span class="number">1</span>]), count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SCR_WIDTH; i++)</span><br><span class="line">&#123;</span><br><span class="line">vertices[count * <span class="number">3</span>] = i, vertices[count * <span class="number">3</span> + <span class="number">1</span>] = BOTTOM;</span><br><span class="line"><span class="built_in">Normalize</span>(vertices[count * <span class="number">3</span>], vertices[count * <span class="number">3</span> + <span class="number">1</span>]), count++;</span><br><span class="line"></span><br><span class="line">vertices[count * <span class="number">3</span>] = i, vertices[count * <span class="number">3</span> + <span class="number">1</span>] = TOP;</span><br><span class="line"><span class="built_in">Normalize</span>(vertices[count * <span class="number">3</span>], vertices[count * <span class="number">3</span> + <span class="number">1</span>]), count++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Bresenham</span><span class="params">(<span class="keyword">int</span> x1, <span class="keyword">int</span> y1, <span class="keyword">int</span> x2, <span class="keyword">int</span> y2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">bool</span> steep = <span class="built_in">abs</span>(y2 - y1) &gt; <span class="built_in">abs</span>(x2 - x1);</span><br><span class="line"><span class="keyword">if</span> (steep) <span class="built_in">Swap</span>(x1, y1), <span class="built_in">Swap</span>(x2, y2);</span><br><span class="line"><span class="keyword">if</span> (x1 &gt; x2) <span class="built_in">Swap</span>(x1, x2), <span class="built_in">Swap</span>(y1, y2);</span><br><span class="line"><span class="keyword">int</span> dx = x2 - x1, dy = y2 - y1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> d = -dx;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, x = x1, y = y1; i &lt;= dx; i++, count++)</span><br><span class="line">&#123;</span><br><span class="line">vertices[count * <span class="number">3</span>] = !steep ? x : y;</span><br><span class="line">vertices[count * <span class="number">3</span> + <span class="number">1</span>] = !steep ? y : x;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Normalize</span>(vertices[count * <span class="number">3</span>], vertices[count * <span class="number">3</span> + <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">x++;</span><br><span class="line">d += <span class="number">2</span> * <span class="built_in">abs</span>(dy);</span><br><span class="line"><span class="keyword">if</span> (d &gt; <span class="number">0</span>) y += (dy &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">-1</span>), d -= <span class="number">2</span> * dx;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">/// CohenSutherland</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> IN_SIDE      =  <span class="number">0x0000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> LEFT_SIDE    =  <span class="number">0x0001</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> RIGHT_SIDE   =  <span class="number">0x0010</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> BOTTOM_SIDE  =  <span class="number">0x0100</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> TOP_SIDE     =  <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">EncodePoint</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> code = IN_SIDE;</span><br><span class="line"><span class="keyword">if</span> (x &lt; LEFT)    code |= LEFT_SIDE;</span><br><span class="line"><span class="keyword">if</span> (RIGHT &lt; x)   code |= RIGHT_SIDE;</span><br><span class="line"><span class="keyword">if</span> (y &lt; BOTTOM)  code |= BOTTOM_SIDE;</span><br><span class="line"><span class="keyword">if</span> (TOP &lt; y)     code |= TOP_SIDE;</span><br><span class="line"><span class="keyword">return</span> code;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CohenSutherland</span><span class="params">(<span class="keyword">int</span> x0, <span class="keyword">int</span> y0, <span class="keyword">int</span> x1, <span class="keyword">int</span> y1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> code0 = <span class="built_in">EncodePoint</span>(x0, y0), code1 = <span class="built_in">EncodePoint</span>(x1, y1);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ( (code0 | code1) == <span class="number">0</span> ) <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> ( (code0 &amp; code1) != <span class="number">0</span> ) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> outCode = code0 ? code0 : code1;</span><br><span class="line"><span class="keyword">double</span> x, y, z;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (outCode &amp; LEFT_SIDE) &#123; x = LEFT; <span class="keyword">float</span> t = (x - x0) / (x1 - x0); y = (<span class="number">1</span> - t) * y0 + t * y1; &#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(outCode &amp; RIGHT_SIDE) &#123; x = RIGHT; <span class="keyword">float</span> t = (x - x0) / (x1 - x0); y = (<span class="number">1</span> - t) * y0 + t * y1; &#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(outCode &amp; BOTTOM_SIDE) &#123; y = BOTTOM; <span class="keyword">float</span> t = (y - y0) / (y1 - y0); x = (<span class="number">1</span> - t) * x0 + t * x1; &#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(outCode &amp; TOP_SIDE) &#123; y = TOP; <span class="keyword">float</span> t = (y - y0) / (y1 - y0); x = (<span class="number">1</span> - t) * x0 + t * x1; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (outCode == code0) x0 = x, y0 = y, code0 = <span class="built_in">EncodePoint</span>(x0, y0);</span><br><span class="line"><span class="keyword">else</span> x1 = x, y1 = y, code1 = <span class="built_in">EncodePoint</span>(x1, y1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Bresenham</span>(x0, y0, x1, y1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitializeVertex</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// Generate</span></span><br><span class="line"><span class="built_in">glGenVertexArrays</span>(<span class="number">1</span>, &amp;VAO);</span><br><span class="line"><span class="built_in">glGenBuffers</span>(<span class="number">1</span>, &amp;VBO);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bind</span></span><br><span class="line"><span class="built_in">glBindVertexArray</span>(VAO);</span><br><span class="line"><span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, VBO);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in"><span class="keyword">sizeof</span></span>(vertices), vertices, GL_STATIC_DRAW);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glVertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="number">3</span> * <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">float</span>), (<span class="keyword">void</span>*)<span class="number">0</span>);</span><br><span class="line"><span class="built_in">glEnableVertexAttribArray</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> endregion</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Render</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">glClearColor</span>(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">1</span>);</span><br><span class="line"><span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glBindVertexArray</span>(VAO);</span><br><span class="line"><span class="built_in">glDrawArrays</span>(GL_POINTS, <span class="number">0</span>, count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> x0, y0, x1, y1;</span><br><span class="line">std::cin &gt;&gt; x0 &gt;&gt; y0 &gt;&gt; x1 &gt;&gt; y1;</span><br><span class="line"></span><br><span class="line"><span class="built_in">InitializeWindow</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">DrawBoundary</span>();</span><br><span class="line"><span class="built_in">CohenSutherland</span>(x0, y0, x1, y1);</span><br><span class="line"></span><br><span class="line"><span class="built_in">InitializeVertex</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (!<span class="built_in">glfwWindowShouldClose</span>(window))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">ProcessInput</span>(window);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Render</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">glfwSwapBuffers</span>(window);</span><br><span class="line"><span class="built_in">glfwPollEvents</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">glfwTerminate</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;基础图形绘制-直线裁剪&lt;/h1&gt;
&lt;h2 id=&quot;Cohen-Sutherland&quot;&gt;Cohen-Sutherland&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Cohen-Sutherland 裁剪算法&lt;/strong&gt; 是最常用的直线的裁剪算法，用于直线在矩形框的裁剪。&lt;/p&gt;</summary>
      
    
    
    
    <category term="图形学" scheme="https://www.bearchild.top/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6/"/>
    
    
    <category term="图形学" scheme="https://www.bearchild.top/tags/%E5%9B%BE%E5%BD%A2%E5%AD%A6/"/>
    
  </entry>
  
</feed>
